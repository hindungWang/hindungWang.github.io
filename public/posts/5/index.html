<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Golang-channel :: Hindung Blogs</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Golang channel类型笔记" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://hindung.cn/posts/5/" />




<link rel="stylesheet" href="http://hindung.cn/assets/style.css">

  <link rel="stylesheet" href="http://hindung.cn/assets/green.css">






<link rel="apple-touch-icon" href="http://hindung.cn/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="http://hindung.cn/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Golang-channel">
<meta property="og:description" content="Golang channel类型笔记" />
<meta property="og:url" content="http://hindung.cn/posts/5/" />
<meta property="og:site_name" content="Hindung Blogs" />

  
    <meta property="og:image" content="http://hindung.cn/img/favicon/green.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2020-08-01 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Hindung
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/posts">Post</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/posts">Post</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="http://hindung.cn/posts/5/">Golang-channel</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2020-08-01
        
      </span>
    
    
    
      <span class="post-reading-time">:: 12 min read (2524 words)</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="http://hindung.cn/tags/go/">Go</a>&nbsp;
    
  </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#channel与goroutine">channel与goroutine</a>
      <ul>
        <li><a href="#channel的基本使用">channel的基本使用</a></li>
        <li><a href="#channel的底层实现">channel的底层实现</a></li>
        <li><a href="#select与channel">select与channel</a></li>
        <li><a href="#发送和接收的阻塞">发送和接收的阻塞</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h2 id="前言">前言<a href="#前言" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>本文主要记录平时使用Golang的channel对象是如何在内存中存储和实现的，包括channel的创建、发送、接收、实现和关闭，最佳实践等，有时还应该更加关注channel的阻塞问题，以及select底层实现与channel的选择执行。</p>
<h2 id="channel与goroutine">channel与goroutine<a href="#channel与goroutine" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>goroutine, to execute tasks <em>independently</em>, potentially in parallel.
channels, for <em>communication</em>, <em>synchronization</em> between goroutine.</p>
</blockquote>
<p>正如上面说的，goroutine是独立地，可能并行地执行任务。channel是服务与goroutine之间的通讯，同步等。</p>
<p>Go语言的并发模型是基于CSP的， Golang从CSP中吸收了Process/Channel。</p>
<p>channel是一种：</p>
<ul>
<li>协程安全</li>
<li>可以在协程之间存储和传输值</li>
<li>先进先出</li>
<li>能够导致协程阻塞或不阻塞（block or unblock）</li>
</ul>
<p>关于goroutine的内容以后在深入，本文就重点了解一下channel。</p>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
</blockquote>
<p>这是Go语言的并发哲学。</p>
<p>下面就来详细了解一下golang是如何实现channel这个对象，并且如何实现goroutine之间的数据通信的。</p>
<h3 id="channel的基本使用">channel的基本使用<a href="#channel的基本使用" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">//声明一个int类型的channel，注意，该语句仅声明，不初始化channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) <span style="color:#75715e">//创建一个无缓冲的int型的channel，无缓冲的channel当放入1个元素后，后续的输入便会阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span>) <span style="color:#75715e">//创建一个缓冲区大小为10的int型的channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">x</span> <span style="color:#75715e">//将x发送到channel中，如果channel缓冲区满，则阻塞当前goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span> <span style="color:#75715e">//从channel中接收一个值，如果缓冲区为空，则阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span> = <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span> <span style="color:#75715e">//从channel中接收一个值并存到x中，如果缓冲区为空，则阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span> <span style="color:#75715e">//从channel中接收一个值，如果channel关闭了，那么ok为false（在没有defaultselect语句的前提下），在channel未关闭且为空的情况下，会阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>close(<span style="color:#a6e22e">ch</span>) <span style="color:#75715e">//关闭channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ch</span> {} <span style="color:#75715e">//等待并取出channel中的值，直到channel关闭，会阻塞
</span></span></span></code></pre></div><h4 id="无缓冲区的channel">无缓冲区的channel<a href="#无缓冲区的channel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>从无缓存的channel中读取消息会阻塞，直到goroutine向channel中发送消息；同理，向无缓存的channel 中发送消息也会阻塞，直到有goroutine从channel中读取消息。</p>
<h4 id="有缓冲区的channel">有缓冲区的channel<a href="#有缓冲区的channel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>有缓存的channe 的构造方式为指定make函数的第二个参数，该参数为channel缓存的容量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span>)
</span></span></code></pre></div><p>有缓存的channel实现了一个阻塞队列(采用环形数组实现)。当缓存未满时，向channel中发送消息时不会阻塞，当缓存满时，发送操作将被阻塞，直到有其他goroutine从中读取消息；相应的，当channel中消息不为空时，读取消息不会出现阻塞，当channel为空时，读取操作会造成阻塞，直到有goroutine向channel中写入消息。</p>
<h4 id="只读只写的channel">只读/只写的channel<a href="#只读只写的channel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//定义只读的channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">read_only</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">make</span> (<span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//定义只写的channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">write_only</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">make</span> (<span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//可同时读写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">read_write</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">make</span> (<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span></code></pre></div><p>一般来说， 只读或者只写的channel主要用在参数传递上面，比如有一个读取和发送数据的函数，那么在函数参数定义的时候可以限定channel类型，使得权限最小。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//只能往channel里面写数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//只能从channel里面读数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ch</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="channel的底层实现">channel的底层实现<a href="#channel的底层实现" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>我们知道channel不能new出来，只能make出来，这是因为channel本身数据结构的复杂性。
我们本次主要重点看一下channel底层是如何实现的。（源码是基于Go 1.10.2）
channel的数据结构表示</p>
<p>在src/runtime/chan.go里面定义了channel的数据结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hchan</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">qcount</span>   <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// total data in the queue： channel的当前元素个数，也就是len方法的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dataqsiz</span> <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// size of the circular queue：channel的容量，环形队列的大小，cap方法的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">buf</span>      <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// points to an array of dataqsiz elements :环形数组实现的缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">elemsize</span> <span style="color:#66d9ef">uint16</span>  <span style="color:#75715e">// 每个元素的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">uint32</span>  <span style="color:#75715e">//标志位，标识是否close
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">elemtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span> <span style="color:#75715e">// element type： channel存放元素的类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">sendx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// send index： 环形队列中下一次发送元素的索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">recvx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// receive index： 环形队列中下一次接收元素的索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">recvq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// list of recv waiters  ： recv的goroutinue的等待队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">sendq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// list of send waiters  ： send的goroutinue的等待队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// lock protects all fields in hchan, as well as several
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// fields in sudogs blocked on this channel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Do not change another G&#39;s status while holding this lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// (in particular, do not ready a G), as this can deadlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// with stack shrinking.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">mutex</span>  <span style="color:#75715e">//互斥量，保证同步安全
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>上面就是channel对象的数据结构表示，内部有一个环形队列来存放数据。并且还有两个waitq链表来实现goroutine的等待队列，用来存放哪些goroutine因为send或者recv被阻塞在了这个channel上面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">waitq</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">first</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">last</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最后sudog就是对于goroutine中的G的封装, 记录的就是因为channel读写被阻塞的goroutine。
make channel的实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makechan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chantype</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">elem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// buf points into the same allocation, elemtype is persistent.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:  <span style="color:#75715e">//没有缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Queue or element size is zero.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Race detector uses this location for synchronization.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">kind</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">kindNoPointers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:  <span style="color:#75715e">//channel不包含指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Elements do not contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Allocate hchan and buf in one call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">+</span>uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">hchanSize</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Elements contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span> = new(<span style="color:#a6e22e">hchan</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">mallocgc</span>(uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemsize</span> = uint16(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span> = <span style="color:#a6e22e">elem</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> = uint(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看得出来，make channel里面主要是要申请环形队列的内存块，也就是为什么channel不能用new来实现的原因了。</p>
<p>并且make channel申请数据的堆内存，所以我们可以直接传递channel对象而不是channel的指针。</p>
<h4 id="channel的send方法">channel的send方法<a href="#channel的send方法" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>我们通过上面的图来表示发送和接受的流程，刚开始的时候，缓冲区都是空的。如果开始发送，那么变成下面这种状态，并且sendx开始累加。</p>
<p>缓冲区发送满了以后就是这种状态：</p>
<p>channel send的源代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chansend</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">block</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">callerpc</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果想一个nil的channel发送数据，会调用gopark将当前的goroutine休眠，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//然后通过第一个参数唤醒，但是下面传入的第一个参数也是nil那么就会导致这个goroutine一直休眠
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//如果goroutine sysmon检查到这种情况就，就会throw(&#34;all goroutines are asleep - deadlock!&#34;) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">block</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gopark</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;chan send (nil chan)&#34;</span>, <span style="color:#a6e22e">traceEvGoStop</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;unreachable&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">racereadpc</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">callerpc</span>, <span style="color:#a6e22e">funcPC</span>(<span style="color:#a6e22e">chansend</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Fast path: check for failed non-blocking operation without acquiring the lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// After observing that the channel is not closed, we observe that the channel is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// not ready for sending. Each of these observations is a single word-sized read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// (first c.closed and second c.recvq.first or c.qcount depending on kind of channel).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Because a closed channel cannot transition from &#39;ready for sending&#39; to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#39;not ready for sending&#39;, even if the channel is closed between the two observations,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// they imply a moment between the two when the channel was both not yet closed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// and not ready for sending. We behave as if we observed the channel at that moment,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// and report that the send cannot proceed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// It is okay if the reads are reordered here: if we observe that the channel is not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ready for sending and then observe that it is not closed, that implies that the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// channel wasn&#39;t closed during the first observation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">block</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> ((<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">first</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">t0</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">blockprofilerate</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t0</span> = <span style="color:#a6e22e">cputicks</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//获取同步锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//不能向已经close的channel发送数据，否则直接panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;send on closed channel&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果有goroutine在这个channel上面等待，那么直接将数据发送给这个接收goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">dequeue</span>(); <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Found a waiting receiver. We pass the value we want to send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// directly to the receiver, bypassing the channel buffer (if any).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>) }, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">//缓冲队列还没有满，那么直接将数据复制到缓冲队列里面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &lt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Space is available in the channel buffer. Enqueue the element to send.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">qp</span>, <span style="color:#a6e22e">ep</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">block</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Block on the channel. Some receiver will complete our operation for us.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//如果缓冲队列满了，俺么就将当前的发送goroutine塞到发送队列中去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getg</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">acquireSudog</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// on gp.waiting where copystack can find it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">ep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">waitlink</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">g</span> = <span style="color:#a6e22e">gp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">isSelect</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#a6e22e">mysg</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">enqueue</span>(<span style="color:#a6e22e">mysg</span>)  <span style="color:#75715e">//入队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">goparkunlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>, <span style="color:#e6db74">&#34;chan send&#34;</span>, <span style="color:#a6e22e">traceEvGoBlockSend</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// someone woke us up.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;chansend: spurious wakeup&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;send on closed channel&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">blockevent</span>(<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span><span style="color:#f92672">-</span><span style="color:#a6e22e">t0</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">releaseSudog</span>(<span style="color:#a6e22e">mysg</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>从上面的代码可以看到基本发送流程</p>
<ul>
<li>获取同步锁，对缓冲队列进行加锁</li>
<li>如果有等待的goroutinue，那么数据直接发送给这个接收goroutine，数据拷贝1次</li>
<li>如果缓冲队列没有满，将发送的数据拷贝到队列中，sendx加1</li>
<li>如果缓冲队列满了，那么将发送goroutine放到发送阻塞队列中</li>
</ul>
<h4 id="channel的recv方法">channel的recv方法<a href="#channel的recv方法" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>在发送的章节，我们已经把缓冲区里面存放了数据，然后就是接受的goroutinue开始接受数据了。
image.png</p>
<p>直到把数据读完阻塞为止。</p>
<p>channel recv的源代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">block</span> <span style="color:#66d9ef">bool</span>) (<span style="color:#a6e22e">selected</span>, <span style="color:#a6e22e">received</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// raceenabled: don&#39;t need to check ep, as it is always on the stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// or is new memory allocated by reflect.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Fast path: check for failed non-blocking operation without acquiring the lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// After observing that the channel is not ready for receiving, we observe that the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// channel is not closed. Each of these observations is a single word-sized read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// (first c.sendq.first or c.qcount, and second c.closed).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Because a channel cannot be reopened, the later observation of the channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// being not closed implies that it was also not closed at the moment of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// first observation. We behave as if we observed the channel at that moment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// and report that the receive cannot proceed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// The order of operations is important here: reversing the operations can lead to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// incorrect behavior when racing with a close.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">block</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">first</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Loaduint</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">t0</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">blockprofilerate</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t0</span> = <span style="color:#a6e22e">cputicks</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//加锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果channel已经关闭并且channel为空，那么recv的时候返回空值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ep</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">typedmemclr</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">ep</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果有send阻塞队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//如果channel没有缓冲区，那么直接从send goroutine接收数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//否则从缓冲区队列头取出数据，并且唤醒send开始写入数据到队列尾部
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">dequeue</span>(); <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Found a waiting sender. If buffer is size 0, receive value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// directly from sender. Otherwise, receive from head of queue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// and add sender&#39;s value to the tail of the queue (both map to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// the same buffer slot because the queue is full).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>) }, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//缓存队列不为空，那么从队列获取数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Receive directly from queue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ep</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">typedmemclr</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">qp</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">block</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//缓存队列为空，那么将recv goroutine加入到recv阻塞队列中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// no sender available: block on this channel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getg</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">acquireSudog</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// on gp.waiting where copystack can find it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">ep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">waitlink</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#a6e22e">mysg</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">g</span> = <span style="color:#a6e22e">gp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">isSelect</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">enqueue</span>(<span style="color:#a6e22e">mysg</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">goparkunlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>, <span style="color:#e6db74">&#34;chan receive&#34;</span>, <span style="color:#a6e22e">traceEvGoBlockRecv</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// someone woke us up
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">blockevent</span>(<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span><span style="color:#f92672">-</span><span style="color:#a6e22e">t0</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">closed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">releaseSudog</span>(<span style="color:#a6e22e">mysg</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, !<span style="color:#a6e22e">closed</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>channel的数据接收和发送比较类似：</p>
<ul>
<li>对于队列进行加锁</li>
<li>如果有send阻塞队列，那么
<ul>
<li>如果channel没有缓冲区，那么直接从send goroutine接收数据</li>
<li>否则从缓冲区队列头取出数据，并且唤醒send开始写入数据到队列尾部</li>
</ul>
</li>
<li>缓存队列不为空，那么从队列获取数据，数据都是拷贝出来的。</li>
<li>缓存队列为空，那么将recv goroutine加入到recv阻塞队列中</li>
</ul>
<h4 id="关闭channel">关闭channel<a href="#关闭channel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">closechan</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;close of nil channel&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//重复close同一个channel会panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>        panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;close of closed channel&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">callerpc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getcallerpc</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">racewritepc</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">callerpc</span>, <span style="color:#a6e22e">funcPC</span>(<span style="color:#a6e22e">closechan</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">glist</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//把所有的阻塞的recvgoroutine唤醒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// release all readers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">dequeue</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">typedmemclr</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#a6e22e">cputicks</span>()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raceacquireg</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">schedlink</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">glist</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">glist</span> = <span style="color:#a6e22e">gp</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//唤醒所有的阻塞的send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// release all writers (they will panic)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">dequeue</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#a6e22e">cputicks</span>()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raceacquireg</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">schedlink</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">glist</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">glist</span> = <span style="color:#a6e22e">gp</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ready all Gs now that we&#39;ve dropped the channel lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">glist</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">glist</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">glist</span> = <span style="color:#a6e22e">glist</span>.<span style="color:#a6e22e">schedlink</span>.<span style="color:#a6e22e">ptr</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">schedlink</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">goready</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>close channel 的工作除了将 ch.closed 设置为1。还需要：</p>
<ul>
<li>唤醒 recvq 队列里面的阻塞 goroutine</li>
<li>唤醒 sendq 队列里面的阻塞 goroutine</li>
<li>处理方式是分别遍历 recvq 和 sendq 队列，将所有的 goroutine 放到 glist 队列中，最后唤醒 glist 队列中的 goroutine。</li>
</ul>
<h3 id="select与channel">select与channel<a href="#select与channel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>select用于在多个channel上同时进行侦听并收发消息，当任何一个case满足条件时即执行，如果没有可执行的case则会执行default的case，如果没有指定defaultcase，则会阻塞程序，select的语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">communication</span> <span style="color:#a6e22e">clause</span> :
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statement</span>(<span style="color:#a6e22e">s</span>);     
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">communication</span> <span style="color:#a6e22e">clause</span> :
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statement</span>(<span style="color:#a6e22e">s</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/*可以定义任意数量的 case */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">default</span> : <span style="color:#75715e">/*可选 */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statement</span>(<span style="color:#a6e22e">s</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面来看一下golang底层是如何实现select和channel的配合的。
一个send case + default</p>
<p>对于这种情况，chan.go源码中是如下实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// compiler implements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    select {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    case c &lt;- v:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    default:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// as
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    if selectnbsend(c, v) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    } else {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbsend</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">chansend</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">getcallerpc</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">一个recv</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// compiler implements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    select {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    case v = &lt;-c:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    default:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// as
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    if selectnbrecv(&amp;v, c) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    } else {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbrecv</span>(<span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">selected</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">带有ok结果的recv</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// compiler implements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    select {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    case v, ok = &lt;-c:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    default:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// as
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    if c != nil &amp;&amp; selectnbrecv2(&amp;v, &amp;ok, c) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    } else {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//        ... bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbrecv2</span>(<span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">received</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO(khr): just return 2 values from this function, now that it is in Go.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">selected</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">received</span> = <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">多种case</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">default混合</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">如果下面这种多个case混合的代码</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">那么select是如何工作的呢</span><span style="color:#960050;background-color:#1e0010">？</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch2</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//省略初始化channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们通过go build -gcflags -S helloworld.go 2&gt; helloworld.s来反汇编上面的代码，可以看到下面的代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">0x0084</span> <span style="color:#ae81ff">00132</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">newselect</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0089</span> <span style="color:#ae81ff">00137</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">88</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x008e</span> <span style="color:#ae81ff">00142</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0092</span> <span style="color:#ae81ff">00146</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">XORPS</span>    <span style="color:#a6e22e">X1</span>, <span style="color:#a6e22e">X1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0095</span> <span style="color:#ae81ff">0014</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">MOVUPS</span>    <span style="color:#a6e22e">X1</span>, <span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x009a</span> <span style="color:#ae81ff">00154</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">24</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00a3</span> <span style="color:#ae81ff">00163</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">PCDATA</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00a3</span> <span style="color:#ae81ff">00163</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectrecv</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00a8</span> <span style="color:#ae81ff">0016</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">88</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00ad</span> <span style="color:#ae81ff">00173</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00b1</span> <span style="color:#ae81ff">00177</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00ba</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">86</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00bf</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">91</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">CX</span>, <span style="color:#ae81ff">16</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c4</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">96</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">24</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00cd</span> <span style="color:#ae81ff">00205</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">PCDATA</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00cd</span> <span style="color:#ae81ff">00205</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectrecv</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00d2</span> <span style="color:#ae81ff">00210</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">88</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00d7</span> <span style="color:#ae81ff">00215</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00db</span> <span style="color:#ae81ff">0021</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00e4</span> <span style="color:#ae81ff">0022</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00e9</span> <span style="color:#ae81ff">00233</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">CX</span>, <span style="color:#ae81ff">16</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00ee</span> <span style="color:#ae81ff">0023</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">PCDATA</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00ee</span> <span style="color:#ae81ff">0023</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectsend</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00f3</span> <span style="color:#ae81ff">00243</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">16</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">88</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00f8</span> <span style="color:#ae81ff">0024</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">16</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00fc</span> <span style="color:#ae81ff">00252</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">16</span>)    <span style="color:#a6e22e">PCDATA</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00fc</span> <span style="color:#ae81ff">00252</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">16</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectdefault</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0101</span> <span style="color:#ae81ff">00257</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">LEAQ</span>    <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">88</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0106</span> <span style="color:#ae81ff">00262</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x010a</span> <span style="color:#ae81ff">00266</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">PCDATA</span>    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x010a</span> <span style="color:#ae81ff">00266</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectgo</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x010f</span> <span style="color:#ae81ff">00271</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">MOVQ</span>    <span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0114</span> <span style="color:#ae81ff">00276</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">TESTQ</span>    <span style="color:#a6e22e">AX</span>, <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">其中下面这几行就是关键</span><span style="color:#960050;background-color:#1e0010">：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0084</span> <span style="color:#ae81ff">00132</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">newselect</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00a3</span> <span style="color:#ae81ff">00163</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">12</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectrecv</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00cd</span> <span style="color:#ae81ff">00205</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">13</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectrecv</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00ee</span> <span style="color:#ae81ff">0023</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">15</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectsend</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00fc</span> <span style="color:#ae81ff">00252</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">16</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectdefault</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x010a</span> <span style="color:#ae81ff">00266</span> (<span style="color:#a6e22e">helloworld</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">11</span>)    <span style="color:#a6e22e">CALL</span>    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">selectgo</span>(<span style="color:#a6e22e">SB</span>)
</span></span></code></pre></div><p>我们在src\runtime\select.go下面可以找到selectgo方法，这个是select的调度方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectgo</span>(<span style="color:#a6e22e">sel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hselect</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">loop</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pass 1 - look for something already waiting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dfli</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dfl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">scase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">casi</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cas</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">scase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; int(<span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">ncase</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">casi</span> = int(<span style="color:#a6e22e">pollorder</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cas</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">scases</span>[<span style="color:#a6e22e">casi</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">kind</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">caseNil</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//接收数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">caseRecv</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sg</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">dequeue</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果有发送goroutine阻塞，那么就接收数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">recv</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果缓冲队列里面有数据，接收数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">bufrecv</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果channel是关闭的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">rclose</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">caseSend</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">racereadpc</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">pc</span>, <span style="color:#a6e22e">chansendpc</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">sclose</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果有接收goroutine阻塞，那么就发送数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">sg</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">dequeue</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">send</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果缓冲区不为空，那么发送数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &lt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">bufsend</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//default分支
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">caseDefault</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">dfli</span> = <span style="color:#a6e22e">casi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">dfl</span> = <span style="color:#a6e22e">cas</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其他的selectsend， selectrecv， selectdefault都是增加select的scases，将分支加入到调度列表中去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newselect</span>(<span style="color:#a6e22e">sel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hselect</span>, <span style="color:#a6e22e">selsize</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int32</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">selsize</span> <span style="color:#f92672">!=</span> int64(<span style="color:#a6e22e">selectsize</span>(uintptr(<span style="color:#a6e22e">size</span>))) {
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;runtime: bad select size &#34;</span>, <span style="color:#a6e22e">selsize</span>, <span style="color:#e6db74">&#34;, want &#34;</span>, <span style="color:#a6e22e">selectsize</span>(uintptr(<span style="color:#a6e22e">size</span>)), <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;bad select size&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">tcase</span> = uint16(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">ncase</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">lockorder</span> = (<span style="color:#f92672">*</span><span style="color:#66d9ef">uint16</span>)(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">scase</span>), uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">hselect</span>{}.<span style="color:#a6e22e">scase</span>[<span style="color:#ae81ff">0</span>])))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">pollorder</span> = (<span style="color:#f92672">*</span><span style="color:#66d9ef">uint16</span>)(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">lockorder</span>), uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">hselect</span>{}.<span style="color:#a6e22e">lockorder</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectsend</span>(<span style="color:#a6e22e">sel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hselect</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getcallerpc</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">ncase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">tcase</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;selectsend: too many cases&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">ncase</span> = <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cas</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">scase</span>)(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">scase</span>), uintptr(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">sel</span>.<span style="color:#a6e22e">scase</span>[<span style="color:#ae81ff">0</span>])))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">pc</span> = <span style="color:#a6e22e">pc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">kind</span> = <span style="color:#a6e22e">caseSend</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">elem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">debugSelect</span> {
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;selectsend s=&#34;</span>, <span style="color:#a6e22e">sel</span>, <span style="color:#e6db74">&#34; pc=&#34;</span>, <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">pc</span>), <span style="color:#e6db74">&#34; chan=&#34;</span>, <span style="color:#a6e22e">cas</span>.<span style="color:#a6e22e">c</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>select有自己的数据结构，包括hselect和scase，这里就不详细展开select的内部实现原理的，我们只要理解下面几点：</p>
<ul>
<li>如果select下面只有default语句，或者只有一个case+defaut语句，编译器会重新生成一些代码，简单处理这种情况。</li>
<li>selectgo函数是执行case语句的方法，主要按照下面的步骤来实施
<ul>
<li>evaluate all the involved channels and values</li>
<li>permuting the cases slice elements (randomize)</li>
<li>ordering elements according to cases hchan address</li>
<li>locking all the channels</li>
<li>starting to loop…</li>
<li>a. checking if a channel is already waiting, so we can use it immediately (and it’s done)</li>
<li>b. otherwise, enqueuing on all channels (and sleep)</li>
<li>c. waiting for another goroutine to wake us up</li>
<li>d. another goroutine wake us up (done = 1)</li>
<li>e. dequeuing of all the other channels</li>
<li>i. if we were waken up by a channel close operation, return to a.</li>
<li>ii. else, we’re done :)</li>
</ul>
</li>
</ul>
<h3 id="发送和接收的阻塞">发送和接收的阻塞<a href="#发送和接收的阻塞" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>我们从前面可以看到，如果发送的时候，接收端没有准备好，或者缓冲区队列是满的，那么就会将当前的goroutine阻塞，然后等待唤醒。 这个主要是涉及到了goroutine的底层模型以及调度机制，这里主要简单描述一下channel对象中sudog对象是如何工作的。</p>
<p>image.png</p>
<p>这里举一个发送的例子，如果给一个缓冲区已经满了的channel发送数据，就会生成一个sudog对象，sudog对象里面封装的就是发送goroutine， 这个goroutine被阻塞。
image.png</p>
<p>如果这时候recv的goroutine开始接受数据，那么找到被阻塞的send goroutine的sudog， 然后把sudog的队列的数据塞到缓冲区队列里面，并且激活这个sudog对象，让里面的goroutine成为runnable。
image.png
总结</p>
<p>回到刚开始的那句话：
image.png
这个需要大家好好体会一下goroutine和channel是如何实现这个思想的，并且从分析源码中，我们可以看到使用channel对象的一些常见问题：</p>
<ul>
<li>给一个nil channel发送数据，造成永远阻塞</li>
<li>从一个nil channel接收数据，造成永远阻塞</li>
<li>给一个已经关闭的channel发送数据，引起panic</li>
<li>从一个已经关闭的channel接收数据，立即返回一个零值</li>
<li>关闭已经已经关闭的channel，引起panic</li>
<li>关闭一个nil channel，引起panic</li>
</ul>
<p><strong>参考资料</strong></p>
<p><a href="https://speakerdeck.com/kavya719/understanding-channels">understanding-channels</a></p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://hindung.cn/posts/6/">
                <span class="button__icon">←</span>
                <span class="button__text">雪花算法</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="http://hindung.cn/posts/4/">
                <span class="button__text">Golang语言模型</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="http://hindung.cn/assets/main.js"></script>
<script src="http://hindung.cn/assets/prism.js"></script>


  <script src="http://hindung.cn/assets/languageSelector.js"></script>






  
</div>

</body>
</html>
