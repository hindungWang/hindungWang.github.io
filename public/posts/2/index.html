<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="记一次Docker镜像优化的历程"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Docker镜像优化"><meta property="og:description" content="记一次Docker镜像优化的历程"><meta property="og:type" content="article"><meta property="og:url" content="http://hindung.cn/posts/2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-23T00:00:00+00:00"><title>Docker镜像优化 | Hindung Blogs</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.scss integrity crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.babd2f636c40f8c2a90eb07eec05db5d5b170c6461306029c9a468cc2daf879d.js integrity="sha256-ur0vY2xA+MKpDrB+7AXbXVsXDGRhMGApyaRozC2vh50=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Hindung Blogs</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Docker镜像优化</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#dockerfile简介>Dockerfile简介</a></li><li><a href=#常用镜像缩小方法>常用镜像缩小方法</a><ul><li><a href=#在哪层引入就在哪层清理>在哪层引入，就在哪层清理</a></li><li><a href=#合并run中的命令>合并RUN中的命令</a></li><li><a href=#分阶段构建>分阶段构建</a></li><li><a href=#制作基础镜像包>制作基础镜像包</a></li><li><a href=#一些容易增大镜像体积的操作>一些容易增大镜像体积的操作</a></li></ul></li><li><a href=#常用的工具>常用的工具</a><ul><li><a href=#docker-history命令>docker history命令</a></li><li><a href=#dive分析镜像工具>dive分析镜像工具</a></li></ul></li><li><a href=#各种基础镜像的构建>各种基础镜像的构建</a><ul><li><a href=#各类基础镜像分析>各类基础镜像分析</a></li><li><a href=#各个基础镜像换源>各个基础镜像换源</a></li><li><a href=#各个基础镜像设置时区方法>各个基础镜像设置时区方法</a></li><li><a href=#把日志文件输出到标准输出流>把日志文件输出到标准输出流</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/2/>Docker镜像优化</a></h1><h5>July 23, 2020</h5><div><a href=/tags/docker/>Docker</a>,
<a href=/tags/dockerfile/>Dockerfile</a></div><p><em><strong>注：本文章基于docker-ce版本：Client 19.03.8，Server 19.03.8</strong></em></p><h2 id=dockerfile简介>Dockerfile简介
<a class=anchor href=#dockerfile%e7%ae%80%e4%bb%8b>#</a></h2><p><code>Dockerfile</code>主要有这几个指令，每个指令都会添加新的层，但是镜像大小不一定增长：</p><table><thead><tr><th>指令</th><th style=text-align:right>用途</th><th style=text-align:center>用法</th><th style=text-align:center>简单示例</th></tr></thead><tbody><tr><td>FROM</td><td style=text-align:right>指定基础镜像</td><td style=text-align:center><code>FROM &lt;image></code> 或 <code>FROM &lt;image>:&lt;tag></code></td><td style=text-align:center><code>FROM ubuntu:16.04</code></td></tr><tr><td>MAINTAINER</td><td style=text-align:right>维护者信息</td><td style=text-align:center><code>MAINTAINER &lt;name></code></td><td style=text-align:center><code>MAINTAINER HuangXianDong</code></td></tr><tr><td>ADD</td><td style=text-align:right>复制指定的文件到容器中包括tar，URL等</td><td style=text-align:center><code>ADD &lt;src> &lt;dest></code></td><td style=text-align:center><code>ADD conf/jail.local /etc/fail2ban/jail.local</code></td></tr><tr><td>COPY</td><td style=text-align:right>复制host上下文环境的文件或者前一阶段镜像的文件到容器</td><td style=text-align:center><code>COPY &lt;src> &lt;dest></code>有两个标志 <code>–from= –chown=</code></td><td style=text-align:center><code>COPY /usr/local/app /usr/local/app</code></td></tr><tr><td>USER</td><td style=text-align:right>指定用户</td><td style=text-align:center><code>USER &lt;username></code></td><td style=text-align:center><code>USER root</code></td></tr><tr><td>WORKDIR</td><td style=text-align:right>指定工作目录</td><td style=text-align:center><code>WORKDIR /path/to/workdir</code></td><td style=text-align:center><code>WORKDIR /root</code></td></tr><tr><td>RUN</td><td style=text-align:right>终端执行sh或者可执行程序</td><td style=text-align:center><code>RUN &lt;command></code> 或 <code>RUN [“executable”, “param1”, “param2”]</code></td><td style=text-align:center><code>RUN apt-get update</code></td></tr><tr><td>ENV</td><td style=text-align:right>指定一个环境变量</td><td style=text-align:center><code>ENV &lt;key> &lt;value></code>或<code>ENV &lt;key>=&lt;value></code></td><td style=text-align:center><code>ENV TZ=Asia/Shanghai</code></td></tr><tr><td>ONBUILD</td><td style=text-align:right>配置当所创建的镜像作为其它新创建镜像的基础镜像时，所执行的操作指令</td><td style=text-align:center><code>ONBUILD [INSTRUCTION]</code></td><td style=text-align:center><code>ONBUILD ADD . /app/src</code></td></tr><tr><td>VOLUME</td><td style=text-align:right>创建一个挂载点</td><td style=text-align:center><code>VOLUME [“/data”]</code></td><td style=text-align:center><code>VOLUME [“/data”]</code></td></tr><tr><td>EXPOSE</td><td style=text-align:right>打算暴露的端口号</td><td style=text-align:center><code>EXPOSE &lt;port> [&lt;port>…]</code></td><td style=text-align:center><code>EXPOSE 5060/tcp 5060/udp</code></td></tr><tr><td>ENTRYPOINT</td><td style=text-align:right>容器入口点，不可被<code>docker run</code>覆盖</td><td style=text-align:center><code>ENTRYPOIN</code>T [“executable”, “param1”, “param2”]或<code>ENTRYPOINT command param1 param2</code></td><td style=text-align:center><code>ENTRYPOINT entrypoint.sh</code></td></tr><tr><td>CMD</td><td style=text-align:right>指定启动容器时执行的命令，可以被<code>docker run</code>覆盖</td><td style=text-align:center><code>CMD [“executable”,”param1″,”param2″]</code>或<code>CMD command param1 param2</code>或<code>CMD [“param1″,”param2”]</code>提供给 <code>ENTRYPOINT</code> 的默认参数</td><td style=text-align:center><code>CMD python /app/app.py</code></td></tr></tbody></table><h2 id=常用镜像缩小方法>常用镜像缩小方法
<a class=anchor href=#%e5%b8%b8%e7%94%a8%e9%95%9c%e5%83%8f%e7%bc%a9%e5%b0%8f%e6%96%b9%e6%b3%95>#</a></h2><h3 id=在哪层引入就在哪层清理>在哪层引入，就在哪层清理
<a class=anchor href=#%e5%9c%a8%e5%93%aa%e5%b1%82%e5%bc%95%e5%85%a5%e5%b0%b1%e5%9c%a8%e5%93%aa%e5%b1%82%e6%b8%85%e7%90%86>#</a></h3><p>众所周知，<code>Dockerfile</code>每个指令都会叠加新的一层文件系统，由于<code>docker</code>镜像这种叠加的文件系统，也就是说在构建镜像时，前面一层的文件对于本层来说是只读的，从而不能够在本层文件系统去清理上一层引入的文件，虽然可以删除掉对应的文件或文件夹，但是镜像体积并没有减少：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone http://xxx.git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd ./xxx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./bootstrap.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --enable-core-pgsql-support <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install      <span style=color:#75715e>#这一层引入文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> rm -rf /usr/src/*      <span style=color:#75715e>#在这一层清理，达不到体积减小的目的，反而增加层数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>应该这样：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone http://xxx.git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd ./xxx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./bootstrap.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --enable-core-pgsql-support <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install <span style=color:#ae81ff>\ </span>     <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /usr/src/*      <span style=color:#75715e># 在哪层引入，就在哪层清理</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>此外，如果在<code>ADD</code>，<code>COPY</code>指令中添加了多余的文件，此后在其他层删除掉改文件或文件夹虽然文件删除了，但是镜像大小是不变或增加的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> busybox</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> . /root        <span style=color:#75715e># busytest0 157MB</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> rm -rf /root   <span style=color:#75715e># busytest1 157MB</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>另外，在使用包管理工具的时候经常要安装各种工具，安装时应该将所有要安装的工具写在一起并且加以清理，甚至可以卸载掉：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y autoconf automake bison <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    build-essential fail2ban gawk git-core groff groff-base <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get autoclean <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=合并run中的命令>合并RUN中的命令
<a class=anchor href=#%e5%90%88%e5%b9%b6run%e4%b8%ad%e7%9a%84%e5%91%bd%e4%bb%a4>#</a></h3><p>多个<code>RUN</code>指令会增加很多层镜像，应该尽量把能合在一起写的<code>shell</code>写在同一个<code>RUN</code>指令里：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install tzdata <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get clean <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get autoclean <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>而不是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo $TZ &gt; /etc/timezone <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install tzdata <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get clean <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get autoclean<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=分阶段构建>分阶段构建
<a class=anchor href=#%e5%88%86%e9%98%b6%e6%ae%b5%e6%9e%84%e5%bb%ba>#</a></h3><p>有些应用，如<code>go</code>构建的可执行文件，可以不需要依赖构建他的系统而运行的程序，就适合进行分步构建，也就是一个阶段编译，一个阶段用于执行程序。分步构建很大程度上能减少镜像的体积。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> hello.go .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build hello.go<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> scratch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> /go/hello .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;./hello&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>分阶段构建有时候对一些<code>C</code>程序和大型的<code>Go</code>程序来说，凡是有依赖动态运行库的程序进行分阶段构建就很头疼，因为复制过来的可执行文件可能需要某个动态库的支持。</p><p>与之相对的解决办法是：静态编译或者复制动态库。</p><p>静态编译是一个不错的方法，但是如果某种原因不适合静态编译，比如分阶段编译等等，这就需要拷贝库文件了。</p><p>就像某些程序，编译出来的可执行文件只有十几<code>kb</code>，其他的都是以动态库的形势存在，那么怎么寻找应用对应的依赖库呢？</p><p>使用<code>ldd</code>命令，该命令可以查询对应的库文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ldd /usr/local/freeswitch/bin/freeswitch</span>
</span></span><span style=display:flex><span>        linux-vdso.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0x00007ffd0bb61000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        libfreeswitch.so.1 <span style=color:#f92672>=</span>&gt; /usr/local/freeswitch/lib/libfreeswitch.so.1 <span style=color:#f92672>(</span>0x00007f0fa2a1d000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        libpthread.so.0 <span style=color:#f92672>=</span>&gt; /lib/x86_64-linux-gnu/libpthread.so.0 <span style=color:#f92672>(</span>0x00007f0fa27f3000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span style=color:#f92672>(</span>0x00007f0fa2429000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        libuuid.so.1 <span style=color:#f92672>=</span>&gt; /lib/x86_64-linux-gnu/libuuid.so.1 <span style=color:#f92672>(</span>0x00007f0fa2223000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        ...
</span></span></code></pre></div><p>将这些对应的库文件复制到镜像之后需要执行<code>ldconfig</code>命令，任何改动库文件的操作都应该执行该命令。</p><p>复制动态库文件可能会导致后续维护变得困难，并且可能存在未知的隐患。</p><h3 id=制作基础镜像包>制作基础镜像包
<a class=anchor href=#%e5%88%b6%e4%bd%9c%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f%e5%8c%85>#</a></h3><p>构建镜像时有些主要是下载依赖包导致的时间变长，可以考虑专门做一个环境编译的基础镜像，后续编译就可以基于该镜像编译，大大减少构建时间。</p><h3 id=一些容易增大镜像体积的操作>一些容易增大镜像体积的操作
<a class=anchor href=#%e4%b8%80%e4%ba%9b%e5%ae%b9%e6%98%93%e5%a2%9e%e5%a4%a7%e9%95%9c%e5%83%8f%e4%bd%93%e7%a7%af%e7%9a%84%e6%93%8d%e4%bd%9c>#</a></h3><p>慎用<code>chown</code>命令：<code>chown</code>命令在有些文件系统在实现多层联合文件系统的原理不同，可能会导致无端增加文件夹的体积。</p><p>原因是在<code>docker</code>实现的某些文件系统如<code>overlayfs2</code>，<code>chown</code> 只更改 <code>metadata</code> 数据, 而 <code>metadata</code> 是作用在 <code>inode</code> 节点上的, 一个硬链接文件的属性被修改, 同步的, 所有指向这个 <code>inode</code>节点的文件的属性都会变化，而<code>overlayfs2</code>每层都是独立的，即使文件属性的变化，也会导致整个文件被拷贝, 所以在 <code>overlayfs2</code> 下, 会产生多余的空间浪费。</p><h2 id=常用的工具>常用的工具
<a class=anchor href=#%e5%b8%b8%e7%94%a8%e7%9a%84%e5%b7%a5%e5%85%b7>#</a></h2><h3 id=docker-history命令>docker history命令
<a class=anchor href=#docker-history%e5%91%bd%e4%bb%a4>#</a></h3><p><code>docker</code>自带了简单的镜像分析命令，直接执行<code>docker history &lt;IMAGE ID></code> 或者 <code>docker history REPOSITORY:TAG</code>就行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@RqInternTest3 freeswitch-container<span style=color:#f92672>]</span><span style=color:#75715e># docker history dda43e8b9e21</span>
</span></span><span style=display:flex><span>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
</span></span><span style=display:flex><span>dda43e8b9e21        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop)  CMD [&#34;/usr/local/freeswit…   0B</span>
</span></span><span style=display:flex><span>76f11898568d        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop)  EXPOSE 64535-65535/udp       0B</span>
</span></span><span style=display:flex><span>124e52a5fdb8        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop)  EXPOSE 8021/tcp              0B</span>
</span></span><span style=display:flex><span>d05fa7854fa3        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop)  EXPOSE 5066/tcp 7443/tcp     0B</span>
</span></span><span style=display:flex><span>fae9a2737d1b        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop)  EXPOSE 5060/tcp 5060/udp …   0B</span>
</span></span><span style=display:flex><span>d817769a9e83        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c ldconfig                             81.5kB
</span></span><span style=display:flex><span>e4347f4a3f7f        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) ADD file:305fb1821e6c9f4f7…   19.5kB</span>
</span></span><span style=display:flex><span>7fa9aac435b0        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) ADD file:ef5aa87255557ffc9…   340B</span>
</span></span><span style=display:flex><span>2872fc32f715        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) ADD file:aa24cd419ee5ea6ca…   249B</span>
</span></span><span style=display:flex><span>681ea1a83b9b        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c chmod +x /etc/init.d/freeswitch  …   7.28kB
</span></span><span style=display:flex><span>b3af584e7595        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) ADD file:e450d50f8d60a1861…   5.76kB</span>
</span></span><span style=display:flex><span>8c2e2a5f2de4        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) COPY dir:8ecfbdecc9f674459…   417MB</span>
</span></span><span style=display:flex><span>9a2938106462        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) COPY dir:1ddadc455338c149f…   112MB</span>
</span></span><span style=display:flex><span>d03606f65563        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) COPY dir:cd305b7f15031b530…   20.4MB</span>
</span></span><span style=display:flex><span>3e21911eea87        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c <span style=color:#75715e>#(nop) COPY --chown=freeswitch:da…   410MB</span>
</span></span><span style=display:flex><span>6ce315566979        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c useradd -r -g daemon freeswitch      329kB
</span></span><span style=display:flex><span>b7c170867677        <span style=color:#ae81ff>9</span> hours ago         /bin/sh -c apt-get update     <span style=color:#f92672>&amp;&amp;</span> ln -snf /us…   2.76MB
</span></span><span style=display:flex><span>9a800e72f239        <span style=color:#ae81ff>10</span> hours ago        /bin/sh -c <span style=color:#75715e>#(nop)  ENV TZ=Asia/Shanghai         0B</span>
</span></span><span style=display:flex><span>77be327e4b63        <span style=color:#ae81ff>4</span> weeks ago         /bin/sh -c <span style=color:#75715e>#(nop)  CMD [&#34;/bin/bash&#34;]            0B</span>
</span></span><span style=display:flex><span>&lt;missing&gt;           <span style=color:#ae81ff>4</span> weeks ago         /bin/sh -c mkdir -p /run/systemd <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;do…   7B
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;missing&gt;           4 weeks ago         /bin/sh -c set -xe   &amp;&amp; echo &#39;</span><span style=color:#75715e>#!/bin/sh&#39; &gt; /…   745B</span>
</span></span><span style=display:flex><span>&lt;missing&gt;           <span style=color:#ae81ff>4</span> weeks ago         /bin/sh -c rm -rf /var/lib/apt/lists/*          0B
</span></span><span style=display:flex><span>&lt;missing&gt;           <span style=color:#ae81ff>4</span> weeks ago         /bin/sh -c <span style=color:#75715e>#(nop) ADD file:1f70668251e2e58ce…   124MB</span>
</span></span></code></pre></div><h3 id=dive分析镜像工具>dive分析镜像工具
<a class=anchor href=#dive%e5%88%86%e6%9e%90%e9%95%9c%e5%83%8f%e5%b7%a5%e5%85%b7>#</a></h3><p>可以看出每一层所添加的大小，并针对大的层进行优化。</p><p>分析镜像还有一个很有用的工具<code>dive</code>：</p><p>下载安装<code>dive</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># wget https://github.com/wagoodman/dive/releases/download/v0.9.2/dive_0.9.2_linux_amd64.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tar -zvxf dive_0.9.2_linux_amd64.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cp dive /usr/bin</span>
</span></span></code></pre></div><p>使用：<code>dive &lt;IMAGE ID></code> 或者 <code>dive REPOSITORY:TAG</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>┃ ● Layers ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ Current Layer Contents ├──────────────────────────────────
</span></span><span style=display:flex><span>Cmp   Size  Command                                          Permission     UID:GID       Size  Filetree
</span></span><span style=display:flex><span>    5.2 MB  FROM d970df9dd8bab4b                             drwxr-xr-x         0:0     1.0 MB  ├── bin
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0     1.0 MB  │   ├── <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>│ Layer Details ├─────────────────────────────────────────── -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── <span style=color:#f92672>[[</span> → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── acpid → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Tags:   <span style=color:#f92672>(</span>unavailable<span style=color:#f92672>)</span>                                        -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── add-shell → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Id:     d970df9dd8bab4b7a604d73763aee9e732d107cf3b02000ca193 -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── addgroup → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>712fe48a460f                                                 -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── adduser → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Digest: sha256:8a9aa5c55905476e9412fcf0e18942123b239333aafc4 -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── adjtimex → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>d7b3656faf67b980b41                                          -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── ar → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Command:                                                     -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── arch → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#(nop) ADD file:d5fc1686f667af49c2cb01970701b62eeb9c818d2d4e -rwxr-xr-x         0:0        0 B  │   ├── arp → bin/[</span>
</span></span><span style=display:flex><span>8f967993dab1de737f28 in /                                    -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── arping → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── ash → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>│ Image Details ├─────────────────────────────────────────── -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── awk → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── base64 → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── basename → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Total Image size: 5.2 MB                                     -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── bc → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Potential wasted space: <span style=color:#ae81ff>0</span> B                                  -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── beep → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Image efficiency score: <span style=color:#ae81ff>100</span> %                                -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── blkdiscard → bin/
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── blkid → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>Count   Total Space  Path                                    -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── blockdev → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── bootchartd → bin/
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── brctl → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── bunzip2 → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── busybox → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── bzcat → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── bzip2 → bin/<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                                                             -rwxr-xr-x         0:0        <span style=color:#ae81ff>0</span> B  │   ├── cal → bin/<span style=color:#f92672>[</span>
</span></span></code></pre></div><p>可以非常清晰的看到每一层添加的镜像大小以及文件的变化，通过右边的<code>Content</code>可以观察到文件夹的变化。</p><h2 id=各种基础镜像的构建>各种基础镜像的构建
<a class=anchor href=#%e5%90%84%e7%a7%8d%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f%e7%9a%84%e6%9e%84%e5%bb%ba>#</a></h2><h3 id=各类基础镜像分析>各类基础镜像分析
<a class=anchor href=#%e5%90%84%e7%b1%bb%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f%e5%88%86%e6%9e%90>#</a></h3><p>常用的基础镜像<code>CentOS，Debian，Fedora，Ubuntu，Alpine</code>镜像：</p><table><thead><tr><th>类别</th><th style=text-align:right>版本</th><th style=text-align:center>镜像大小(MB)</th><th style=text-align:center>描述</th><th style=text-align:center>包管理</th></tr></thead><tbody><tr><td>CentOS</td><td style=text-align:right>latest</td><td style=text-align:center>69.84</td><td style=text-align:center>适用于正式的生产环境镜像制作，但是构建出来的镜像大小会很大，可以来考虑分步构建</td><td style=text-align:center>yum，rpm</td></tr><tr><td>-</td><td style=text-align:right>centos8</td><td style=text-align:center>69.84</td><td style=text-align:center>-</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>centos7</td><td style=text-align:center>72.15</td><td style=text-align:center>-</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>centos6</td><td style=text-align:center>66.83</td><td style=text-align:center>-</td><td style=text-align:center>-</td></tr><tr><td>Debian</td><td style=text-align:right>buster-slim</td><td style=text-align:center>26.46</td><td style=text-align:center>当前稳定版本的体积更小版本（slim）</td><td style=text-align:center>apt-get, dpkg</td></tr><tr><td>-</td><td style=text-align:right>stretch</td><td style=text-align:center>43.69</td><td style=text-align:center>旧的稳定版</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>jessie</td><td style=text-align:center>52.08</td><td style=text-align:center>测试版本</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>stable</td><td style=text-align:center>48.78</td><td style=text-align:center>稳定版本</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>sid</td><td style=text-align:center>50.54</td><td style=text-align:center>不稳定版本</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>wheezy</td><td style=text-align:center>38.66</td><td style=text-align:center>Debian 7,被淘汰的稳定版</td><td style=text-align:center>-</td></tr><tr><td>Fedora</td><td style=text-align:right>33</td><td style=text-align:center>67.21</td><td style=text-align:center>稳定版本</td><td style=text-align:center>dpkg/apt，pacman</td></tr><tr><td>-</td><td style=text-align:right>rawhide</td><td style=text-align:center>67.21</td><td style=text-align:center>永远不会被冻结, 也永远不会被正式发布. 对稳定性没有任何保证. 主要用于最新代码的初步测试</td><td style=text-align:center>-</td></tr><tr><td>Ubuntu</td><td style=text-align:right>latest</td><td style=text-align:center>25.9</td><td style=text-align:center>适用于正式的生产环境镜像制作，但是构建出来的镜像大小会很大，可以来考虑分步构建</td><td style=text-align:center>apt-get</td></tr><tr><td>-</td><td style=text-align:right>18.04</td><td style=text-align:center>25.9</td><td style=text-align:center>-</td><td style=text-align:center>-</td></tr><tr><td>-</td><td style=text-align:right>16.04</td><td style=text-align:center>42.13</td><td style=text-align:center>-</td><td style=text-align:center>-</td></tr><tr><td>Alpine</td><td style=text-align:right>latest</td><td style=text-align:center>2.68</td><td style=text-align:center>面向安全的、轻量级的Linux系统，基于musl libc和busybox，使用glibc库的大型c语言可能会遇到很多坑</td><td style=text-align:center>apk, lbu</td></tr><tr><td>busybox</td><td style=text-align:right>latest</td><td style=text-align:center>1</td><td style=text-align:center>包含了基本的linux命令</td><td style=text-align:center>apk</td></tr><tr><td>-</td><td style=text-align:right>glibc</td><td style=text-align:center>5</td><td style=text-align:center>GNU C library版本</td><td style=text-align:center>-</td></tr><tr><td>scratch</td><td style=text-align:right>latest</td><td style=text-align:center>0</td><td style=text-align:center>空白镜像，sh工具也没有</td><td style=text-align:center>无</td></tr></tbody></table><p>也可以使用编程语言对应的基础镜像，适合分步构建完成之后在其上运行或者在对应的基础镜像中编译。</p><h3 id=各个基础镜像换源>各个基础镜像换源
<a class=anchor href=#%e5%90%84%e4%b8%aa%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f%e6%8d%a2%e6%ba%90>#</a></h3><p><em><strong>CentOS yum源</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
</span></span><span style=display:flex><span>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
</span></span></code></pre></div><p><em><strong>Ubuntu apt源</strong></em>
清华源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s http://.*.ubuntu.com http://mirrors.tuna.tsinghua.edu.cn g&#39;</span> /etc/apt/sources.list
</span></span></code></pre></div><p>阿里云源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s http://.*.ubuntu.com http://mirrors.aliyun.com g&#39;</span> /etc/apt/sources.list
</span></span></code></pre></div><p><em><strong>Debian apt源</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s http://.*.debian.org http://mirrors.aliyun.com g&#39;</span> /etc/apt/sources.list
</span></span></code></pre></div><p><em><strong>Alphine apk源</strong></em></p><p>阿里源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span> /etc/apk/repositories
</span></span></code></pre></div><p>科大源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&#39;</span> /etc/apk/repositories
</span></span></code></pre></div><h3 id=各个基础镜像设置时区方法>各个基础镜像设置时区方法
<a class=anchor href=#%e5%90%84%e4%b8%aa%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f%e8%ae%be%e7%bd%ae%e6%97%b6%e5%8c%ba%e6%96%b9%e6%b3%95>#</a></h3><p><em><strong>Ubuntu</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:16.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> TZ<span style=color:#f92672>=</span>Asia/Shanghai<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install tzdata <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get clean <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get autoclean <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><em><strong>CentOS</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ENV TimeZone<span style=color:#f92672>=</span>Asia/Shanghai   
</span></span><span style=display:flex><span>RUN ln -snf /usr/share/zoneinfo/$TimeZone /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TimeZone &gt; /etc/timezone
</span></span></code></pre></div><p><em><strong>Debian</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ENV TZ<span style=color:#f92672>=</span>Asia/Shanghai
</span></span><span style=display:flex><span>RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone
</span></span></code></pre></div><p><em><strong>Alphine</strong></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>RUN apk add tzdata <span style=color:#f92672>&amp;&amp;</span> cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Asia/Shanghai&#34;</span> &gt; /etc/timezone <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apk del tzdata
</span></span></code></pre></div><h3 id=把日志文件输出到标准输出流>把日志文件输出到标准输出流
<a class=anchor href=#%e6%8a%8a%e6%97%a5%e5%bf%97%e6%96%87%e4%bb%b6%e8%be%93%e5%87%ba%e5%88%b0%e6%a0%87%e5%87%86%e8%be%93%e5%87%ba%e6%b5%81>#</a></h3><p>有时候我们写的程序不是以标准输出到控制台的方式来打印日志，而是存在某个日志文件，这就造成容器跑起来之后<code>docker logs</code>命令查看不到日志，这是因为<code>docker</code>容器只接管标准输出流和标准错误流，因此还需要重定向到<code>stdout</code>和<code>stderr</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>RUN ln -sf /dev/stdout /var/log/nginx/access.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -sf /dev/stderr /var/log/nginx/error.log
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#dockerfile简介>Dockerfile简介</a></li><li><a href=#常用镜像缩小方法>常用镜像缩小方法</a><ul><li><a href=#在哪层引入就在哪层清理>在哪层引入，就在哪层清理</a></li><li><a href=#合并run中的命令>合并RUN中的命令</a></li><li><a href=#分阶段构建>分阶段构建</a></li><li><a href=#制作基础镜像包>制作基础镜像包</a></li><li><a href=#一些容易增大镜像体积的操作>一些容易增大镜像体积的操作</a></li></ul></li><li><a href=#常用的工具>常用的工具</a><ul><li><a href=#docker-history命令>docker history命令</a></li><li><a href=#dive分析镜像工具>dive分析镜像工具</a></li></ul></li><li><a href=#各种基础镜像的构建>各种基础镜像的构建</a><ul><li><a href=#各类基础镜像分析>各类基础镜像分析</a></li><li><a href=#各个基础镜像换源>各个基础镜像换源</a></li><li><a href=#各个基础镜像设置时区方法>各个基础镜像设置时区方法</a></li><li><a href=#把日志文件输出到标准输出流>把日志文件输出到标准输出流</a></li></ul></li></ul></nav></div></aside></main></body></html>