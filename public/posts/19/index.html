<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Goæºç æ¢ç©¶ç³»åˆ—ï¼ŒåŸºäºgolang 1.16.xç‰ˆæœ¬"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Goæºç è§£è¯»ä¹‹sync.Cond"><meta property="og:description" content="Goæºç æ¢ç©¶ç³»åˆ—ï¼ŒåŸºäºgolang 1.16.xç‰ˆæœ¬"><meta property="og:type" content="article"><meta property="og:url" content="http://hindung.cn/posts/19/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-16T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-16T00:00:00+00:00"><title>Goæºç è§£è¯»ä¹‹sync.Cond | Hindung Blogs</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.scss integrity crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.babd2f636c40f8c2a90eb07eec05db5d5b170c6461306029c9a468cc2daf879d.js integrity="sha256-ur0vY2xA+MKpDrB+7AXbXVsXDGRhMGApyaRozC2vh50=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Hindung Blogs</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Goæºç è§£è¯»ä¹‹sync.Cond</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#å‰è¨€>å‰è¨€</a></li><li><a href=#æºç è§£æ>æºç è§£æ</a></li><li><a href=#ä½¿ç”¨ä¾‹å­>ä½¿ç”¨ä¾‹å­</a></li><li><a href=#å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨>å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/19/>Goæºç è§£è¯»ä¹‹sync.Cond</a></h1><h5>May 16, 2021</h5><div><a href=/tags/go/>Go</a></div><h2 id=å‰è¨€>å‰è¨€
<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h2><p><a href>å‰é¢ğŸ”—</a>è¯´è¿‡ï¼ŒCondå®ç°äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæ˜¯ç­‰å¾…æˆ–å®£å¸ƒä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„goroutinesçš„æ±‡åˆç‚¹ã€‚</p><p>å°±æ˜¯è¯´ï¼Œä½¿ç”¨sync.Condå¯ä»¥åšåˆ°å¤šä¸ªåç¨‹ç­‰å¾…æŸä¸ªåç¨‹é€šçŸ¥çš„åœºæ™¯ã€‚</p><p>ä½¿ç”¨channelå¯ä»¥å®ç°ä¸€è¯»ä¸€å†™çš„åœºæ™¯ï¼Œè€ŒCondåˆ™å®ç°å¤šè¯»ä¸€å†™çš„åœºæ™¯ã€‚</p><h2 id=æºç è§£æ>æºç è§£æ
<a class=anchor href=#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90>#</a></h2><p>ç®€åŒ–ç‰ˆæ–¹æ³•ç­¾åï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Condç»“æ„ä½“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Cond</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewCond è¿”å›å¸¦Lockerçš„Condï¼Œè¿™ä¸ªLockerå¯ä»¥æ˜¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>// *Mutex æˆ– *RWMutex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewCond</span>(<span style=color:#a6e22e>l</span> <span style=color:#a6e22e>Locker</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç­‰å¾…Lçš„è§£é”å¹¶æŒ‚èµ·goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Wait</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å”¤é†’1ä¸ªå› cé˜»å¡çš„goroutineï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœåœ¨Signalä¹‹åæ‰Waitä¼šå¯¼è‡´all goroutines are asleep - deadlock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Signal</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å”¤é†’æ‰€æœ‰å› cé˜»å¡çš„goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœåœ¨Broadcastä¹‹åæ‰Waitä¼šå¯¼è‡´all goroutines are asleep - deadlock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Broadcast</span>() {}
</span></span></code></pre></div><p>å› æ­¤ï¼Œåœ¨Signalæˆ–è€…Broadcastå‰è¦å…ˆä¿è¯ç›®æ ‡çš„åç¨‹å·²ç»è¿›å…¥äº†WaitçŠ¶æ€ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”ã€‚å› ä¸ºSignalæˆ–è€…Broadcaståªå”¤é†’å½“å‰æ­£åœ¨è¢«Waité˜»å¡çš„åç¨‹ã€‚</p><p><a href=https://go.googlesource.com/go/+/go1.16.4/src/sync/cond.go#21>Condçš„å®šä¹‰</a>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Copyright 2011 The Go Authors. All rights reserved.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Use of this source code is governed by a BSD-style
</span></span></span><span style=display:flex><span><span style=color:#75715e>// license that can be found in the LICENSE file.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>sync</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sync/atomic&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;unsafe&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Cond implements a condition variable, a rendezvous point
</span></span></span><span style=display:flex><span><span style=color:#75715e>// for goroutines waiting for or announcing the occurrence
</span></span></span><span style=display:flex><span><span style=color:#75715e>// of an event.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Condå®ç°äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå®ƒæ˜¯goroutinesç­‰å¾…æˆ–å®£å¸ƒäº‹ä»¶å‘ç”Ÿçš„é›†åˆç‚¹ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Each Cond has an associated Locker L (often a *Mutex or *RWMutex),
</span></span></span><span style=display:flex><span><span style=color:#75715e>// which must be held when changing the condition and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// when calling the Wait method.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// æ¯ä¸ªCondéƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„Locker Lï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ª*Mutexæˆ–*RWMutexï¼‰ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// åœ¨æ”¹å˜æ¡ä»¶å’Œè°ƒç”¨Waitæ–¹æ³•æ—¶ï¼Œå¿…é¡»æŒæœ‰è¿™ä¸ªLã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A Cond must not be copied after first use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Cond</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>noCopy</span> <span style=color:#a6e22e>noCopy</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// L is held while observing or changing the condition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>L</span> <span style=color:#a6e22e>Locker</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// notifyListæ˜¯ç”¨äºå®ç°sync.Condçš„åŸºäºç¥¨è¯çš„é€šçŸ¥åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å‚è€ƒï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://go.googlesource.com/go/+/go1.16.4/src/runtime/sema.go#446
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>notify</span>  <span style=color:#a6e22e>notifyList</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>checker</span> <span style=color:#a6e22e>copyChecker</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// NewCond returns a new Cond with Locker l.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewCond</span>(<span style=color:#a6e22e>l</span> <span style=color:#a6e22e>Locker</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Cond</span>{<span style=color:#a6e22e>L</span>: <span style=color:#a6e22e>l</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Wait atomically unlocks c.L and suspends execution
</span></span></span><span style=display:flex><span><span style=color:#75715e>// of the calling goroutine. After later resuming execution,
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Wait locks c.L before returning. Unlike in other systems,
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Wait cannot return unless awoken by Broadcast or Signal.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Because c.L is not locked when Wait first resumes, the caller
</span></span></span><span style=display:flex><span><span style=color:#75715e>// typically cannot assume that the condition is true when
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Wait returns. Instead, the caller should Wait in a loop:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    c.L.Lock()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    for !condition() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        c.Wait()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    ... make use of condition ...
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    c.L.Unlock()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Waitä¼šå…ˆæŠŠåŠ å…¥åˆ°å¾…å”¤é†’é˜Ÿåˆ—ï¼Œå†é‡Šæ”¾é”ï¼Œç„¶åæ‰§è¡Œç­‰å¾…ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å½“å…¶ä»–goroutineè°ƒç”¨Broadcastæˆ–è€…Signalæ¥é€šçŸ¥å…¶æ¢å¤æ‰§è¡Œåï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ä¼šé‡æ–°ä¸Šé”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Wait</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>checker</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// notifyListAddå°†è°ƒç”¨è€…æ·»åŠ åˆ°é€šçŸ¥åˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¥æ”¶é€šçŸ¥ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è°ƒç”¨è€…å¿…é¡»æœ€ç»ˆè°ƒç”¨notifyListWaitæ¥ç­‰å¾…è¿™æ ·çš„é€šçŸ¥ï¼Œå¹¶æ˜¾å¼ä¼ å‚ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å‚è€ƒï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://go.googlesource.com/go/+/go1.16.4/src/sync/runtime.go#31
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://go.googlesource.com/go/+/go1.16.4/src/runtime/sema.go#475
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime_notifyListAdd</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>notify</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// notifyListWaitç­‰å¾…é€šçŸ¥ã€‚å¦‚æœè‡ªé‚£ä»¥åå·²å‘é€ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// è°ƒç”¨notifyListAddï¼Œå®ƒç«‹å³è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒå°†é˜»å¡ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å‚è€ƒï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://go.googlesource.com/go/+/go1.16.4/src/sync/runtime.go#34
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://go.googlesource.com/go/+/go1.16.4/src/runtime/sema.go#485
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>runtime_notifyListWait</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>notify</span>, <span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Signal wakes one goroutine waiting on c, if there is any.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// It is allowed but not required for the caller to hold c.L
</span></span></span><span style=display:flex><span><span style=color:#75715e>// during the call.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Signal</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>checker</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runtime_notifyListNotifyOne</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>notify</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Broadcast wakes all goroutines waiting on c.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// It is allowed but not required for the caller to hold c.L
</span></span></span><span style=display:flex><span><span style=color:#75715e>// during the call.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cond</span>) <span style=color:#a6e22e>Broadcast</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>checker</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runtime_notifyListNotifyAll</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>notify</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// copyChecker holds back pointer to itself to detect object copying.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>copyChecker</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>copyChecker</span>) <span style=color:#a6e22e>check</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> uintptr(<span style=color:#f92672>*</span><span style=color:#a6e22e>c</span>) <span style=color:#f92672>!=</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>)) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>		!<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapUintptr</span>((<span style=color:#f92672>*</span><span style=color:#66d9ef>uintptr</span>)(<span style=color:#a6e22e>c</span>), <span style=color:#ae81ff>0</span>, uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>))) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>		uintptr(<span style=color:#f92672>*</span><span style=color:#a6e22e>c</span>) <span style=color:#f92672>!=</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>)) {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;sync.Cond is copied&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// noCopy may be embedded into structs which must not be copied
</span></span></span><span style=display:flex><span><span style=color:#75715e>// after the first use.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// See https://golang.org/issues/8005#issuecomment-190753527
</span></span></span><span style=display:flex><span><span style=color:#75715e>// for details.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>noCopy</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span><span style=color:#75715e>// Lock is a no-op used by -copylocks checker from `go vet`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>noCopy</span>) <span style=color:#a6e22e>Lock</span>()   {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>noCopy</span>) <span style=color:#a6e22e>Unlock</span>() {}
</span></span></code></pre></div><h2 id=ä½¿ç”¨ä¾‹å­>ä½¿ç”¨ä¾‹å­
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e4%be%8b%e5%ad%90>#</a></h2><p>å¯ä»¥æŒ‰ç…§å®˜æ–¹ç»™çš„ä½¿ç”¨ä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//    c.L.Lock()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    æŸä¸ªæ¡ä»¶æ»¡è¶³æ‰è¿›è¡ŒWaitï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´Waitå‘ç”Ÿåœ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    å”¤é†’ä¹‹åï¼Œä»è€Œå¯¼è‡´æ­»é”
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    for !condition() {  
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        c.Wait()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    ... make use of condition ...
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    c.L.Unlock()
</span></span></span></code></pre></div><p>å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>locker</span> = new(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cond</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>NewCond</span>(<span style=color:#a6e22e>locker</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>condition</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()         <span style=color:#75715e>//è·å–é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>() <span style=color:#75715e>//é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>condition</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>condition</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Broadcast</span>()  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()         
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„ï¼šsync.Condéœ€è¦å¼€å‘äººå‘˜æŠŠæ¡é”ä»¥åŠcondition()çš„æ¡ä»¶ï¼Œæ¯”è¾ƒå®¹æ˜“å‘ç”Ÿæ­»é”ã€‚</p><h2 id=å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨>å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨
<a class=anchor href=#%e5%85%b6%e4%bb%96%e4%bb%a3%e7%a0%81%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8>#</a></h2><p>k8sä¸­çš„client-goä»£ç ä¸­çš„<a href=https://github.com/kubernetes/client-go/blob/v0.21.0/tools/cache/delta_fifo.go#L98>DeltaFIFOé˜Ÿåˆ—</a>å®ç°å°±æ˜¯ç”¨äº†sync.Condæ¥å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DeltaFIFO</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// lock/cond protects access to &#39;items&#39; and &#39;queue&#39;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cond</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Cond</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å…¶ä»–å­—æ®µçœç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><a href=https://github.com/kubernetes/client-go/blob/v0.21.0/tools/cache/delta_fifo.go#L207>åˆå§‹åŒ–</a>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDeltaFIFO</span>(<span style=color:#a6e22e>keyFunc</span> <span style=color:#a6e22e>KeyFunc</span>, <span style=color:#a6e22e>knownObjects</span> <span style=color:#a6e22e>KeyListerGetter</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewDeltaFIFOWithOptions</span>(<span style=color:#a6e22e>DeltaFIFOOptions</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>KeyFunction</span>:  <span style=color:#a6e22e>keyFunc</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>KnownObjects</span>: <span style=color:#a6e22e>knownObjects</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDeltaFIFOWithOptions</span>(<span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>DeltaFIFOOptions</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>KeyFunction</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>KeyFunction</span> = <span style=color:#a6e22e>MetaNamespaceKeyFunc</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DeltaFIFO</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>items</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>Deltas</span>{},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>queue</span>:        []<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>keyFunc</span>:      <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>KeyFunction</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>knownObjects</span>: <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>KnownObjects</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>emitDeltaTypeReplaced</span>: <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>EmitDeltaTypeReplaced</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// f.lock ä¸ f.cond ç»“åˆä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>L</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>lock</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å†æ¥çœ‹çœ‹<a href=https://github.com/kubernetes/client-go/blob/v0.21.0/tools/cache/delta_fifo.go#L518>Popæ–¹æ³•</a>ï¼Œä½•æ—¶è°ƒç”¨Waitï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Popé˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ä¸€äº›é¡¹ç›®ï¼Œç„¶åè¿”å›ä¸€ä¸ªã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœå¤šä¸ªé¡¹ç›®å‡†å¤‡å°±ç»ªï¼Œå®ƒä»¬å°†æŒ‰ç…§å®ƒä»¬è¢«æ·»åŠ /æ›´æ–°çš„é¡ºåºè¿”å›ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span>) <span style=color:#a6e22e>Pop</span>(<span style=color:#a6e22e>process</span> <span style=color:#a6e22e>PopProcessFunc</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æœ‰æ•°æ®å°±ä¸ç”¨Wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°†é˜»æ­¢Popï¼ˆï¼‰çš„è°ƒç”¨ï¼Œç›´åˆ°æ–°é¡¹ç›®å…¥é˜Ÿã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// When Close() is called, the f.closed is set and the condition is broadcasted.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// å½“Close()è¢«è°ƒç”¨æ—¶ï¼Œf.closedè¢«è®¾ç½®ï¼Œæ¡ä»¶è¢«å¹¿æ’­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// Which causes this loop to continue and return from the Pop().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>closed</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrFIFOClosed</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// é˜»å¡ç›´åˆ°è¢«å¹¿æ’­ï¼ˆè¯´æ˜æœ‰æ•°æ®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span> = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>initialPopulationCount</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>initialPopulationCount</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>item</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// This should never happen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Inconceivable! %q was in f.queue but not f.items; ignoring.&#34;</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>process</span>(<span style=color:#a6e22e>item</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#a6e22e>ErrRequeue</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>addIfNotPresent</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>item</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Don&#39;t need to copyDeltas here, because we&#39;re transferring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// ownership to the caller.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>item</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½•æ—¶è°ƒç”¨Broadcastï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Close the queue.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span>) <span style=color:#a6e22e>Close</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>closed</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Broadcast</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// addIfNotPresent inserts deltas under id if it does not exist, and assumes the caller
</span></span></span><span style=display:flex><span><span style=color:#75715e>// already holds the fifo lock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span>) <span style=color:#a6e22e>addIfNotPresent</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>deltas</span> <span style=color:#a6e22e>Deltas</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>populated</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span> = append(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>deltas</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æœ‰æ•°æ®ï¼Œåˆ™å¹¿æ’­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Broadcast</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// queueActionLocked appends to the delta list for the object.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// queueActionLockedè¿½åŠ åˆ°è¯¥å¯¹è±¡çš„deltaåˆ—è¡¨ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Caller must lock first.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DeltaFIFO</span>) <span style=color:#a6e22e>queueActionLocked</span>(<span style=color:#a6e22e>actionType</span> <span style=color:#a6e22e>DeltaType</span>, <span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>KeyOf</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>KeyError</span>{<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>err</span>}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>oldDeltas</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newDeltas</span> <span style=color:#f92672>:=</span> append(<span style=color:#a6e22e>oldDeltas</span>, <span style=color:#a6e22e>Delta</span>{<span style=color:#a6e22e>actionType</span>, <span style=color:#a6e22e>obj</span>})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newDeltas</span> = <span style=color:#a6e22e>dedupDeltas</span>(<span style=color:#a6e22e>newDeltas</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>newDeltas</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span> = append(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>queue</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>newDeltas</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cond</span>.<span style=color:#a6e22e>Broadcast</span>()
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// This never happens, because dedupDeltas never returns an empty list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// when given a non-empty list (as it is here).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// If somehow it happens anyway, deal with it but complain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>oldDeltas</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; ignoring&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>oldDeltas</span>, <span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; breaking invariant by storing empty Deltas&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>oldDeltas</span>, <span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>newDeltas</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; broke DeltaFIFO invariant by storing empty Deltas&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>oldDeltas</span>, <span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>æ›´æ–°äº 2021/05/16 23:53</em></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#å‰è¨€>å‰è¨€</a></li><li><a href=#æºç è§£æ>æºç è§£æ</a></li><li><a href=#ä½¿ç”¨ä¾‹å­>ä½¿ç”¨ä¾‹å­</a></li><li><a href=#å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨>å…¶ä»–ä»£ç ä¸­çš„åº”ç”¨</a></li></ul></nav></div></aside></main></body></html>