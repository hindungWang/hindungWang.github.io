<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="工作中K8s的kube-proxy是采用iptable模式，故做个总结"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Iptable规则初探"><meta property="og:description" content="工作中K8s的kube-proxy是采用iptable模式，故做个总结"><meta property="og:type" content="article"><meta property="og:url" content="http://hindung.cn/posts/22/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-01T00:00:00+00:00"><title>Iptable规则初探 | Hindung Blogs</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.scss integrity crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.babd2f636c40f8c2a90eb07eec05db5d5b170c6461306029c9a468cc2daf879d.js integrity="sha256-ur0vY2xA+MKpDrB+7AXbXVsXDGRhMGApyaRozC2vh50=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Hindung Blogs</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Iptable规则初探</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#iptable是啥>iptable是啥</a></li><li><a href=#iptables规则>iptables规则</a></li><li><a href=#iptable相关命令>iptable相关命令</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/22/>Iptable规则初探</a></h1><h5>June 1, 2021</h5><div><a href=/tags/kubernetes/>Kubernetes</a>,
<a href=/tags/network/>Network</a></div><h2 id=iptable是啥>iptable是啥
<a class=anchor href=#iptable%e6%98%af%e5%95%a5>#</a></h2><p>参考<a href=https://zh.wikipedia.org/wiki/Iptables>维基百科</a>：iptables是运行在用户空间的应用软件，通过控制Linux内核netfilter模块，来管理网络数据包的处理和转发。</p><h2 id=iptables规则>iptables规则
<a class=anchor href=#iptables%e8%a7%84%e5%88%99>#</a></h2><p>iptables主要有raw、mangle、filter、nat这几个表，对应几个规则：PREROUTING 、INPUT 、FORWARD 、OUTPUT、POSTROUTING 。</p><p>NAT 包括 SNAT （源地址转换）和 DNAT （目的地址转换）。两者的区别在于做地址转换是在路由前还是路由后，SNAT和DNAT总是成对出现的。</p><p>对应的含义可以简单理解为：</p><table><thead><tr><th style=text-align:left>表名</th><th style=text-align:left>用途</th><th style=text-align:left>包含的规则</th></tr></thead><tbody><tr><td style=text-align:left>表名</td><td style=text-align:left>用途</td><td style=text-align:left>包含的规则</td></tr><tr><td style=text-align:left>raw</td><td style=text-align:left>关闭nat表上启用的连接追踪机制</td><td style=text-align:left>PREROUTING，OUTPUT</td></tr><tr><td style=text-align:left>mangle</td><td style=text-align:left>拆解报文，做出修改，并重新封装的功能</td><td style=text-align:left>PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</td></tr><tr><td style=text-align:left>nat</td><td style=text-align:left>网络地址转换功能</td><td style=text-align:left>PREROUTING，OUTPUT，POSTROUTING（centos7中还有INPUT，centos6中没有）</td></tr><tr><td style=text-align:left>filter</td><td style=text-align:left>负责过滤功能，防火墙</td><td style=text-align:left>INPUT，FORWARD，OUTPUT</td></tr></tbody></table><p>规则的意义：</p><table><thead><tr><th style=text-align:left>规则</th><th style=text-align:left>意义</th></tr></thead><tbody><tr><td style=text-align:left>PREROUTING</td><td style=text-align:left>报文刚刚到达主机，还没经过路由</td></tr><tr><td style=text-align:left>INPUT</td><td style=text-align:left>报文已经经过路由，判断是发送给本机的报文</td></tr><tr><td style=text-align:left>FORWARD</td><td style=text-align:left>报文已经经过路由，判断不是本机的报文，如果内核开启转发功能则转发出去，否则丢弃</td></tr><tr><td style=text-align:left>OUTPUT</td><td style=text-align:left>报文从应用发出报文已经经过路由</td></tr><tr><td style=text-align:left>POSTROUTING</td><td style=text-align:left>报文从应用发出已经经过路由，准备从网卡发出</td></tr></tbody></table><p>数据从网络到达主机，再从主机到达应用的过程，以集群中traefik部署的Ingress为例，可以理解为：
<img src=https://hindung.oss-cn-beijing.aliyuncs.com/img/002T8chSgy1gr2r3bnr1bj60dd0b5my602.jpg alt></p><h2 id=iptable相关命令>iptable相关命令
<a class=anchor href=#iptable%e7%9b%b8%e5%85%b3%e5%91%bd%e4%bb%a4>#</a></h2><p>查看iptables规则：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -L, --list <span style=color:#f92672>[</span>chain<span style=color:#f92672>]</span> 列出链 chain 上面的所有规则，如果没有指定链，列出表上所有链的所有规则
</span></span></code></pre></div><p>参考<a href=https://wangchujiang.com/linux-command/c/iptables.html>https://wangchujiang.com/linux-command/c/iptables.html</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#iptable是啥>iptable是啥</a></li><li><a href=#iptables规则>iptables规则</a></li><li><a href=#iptable相关命令>iptable相关命令</a></li></ul></nav></div></aside></main></body></html>