<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="http://hindung.cn/tags/go/"><title>Go | Hindung Blogs</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.scss integrity crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.babd2f636c40f8c2a90eb07eec05db5d5b170c6461306029c9a468cc2daf879d.js integrity="sha256-ur0vY2xA+MKpDrB+7AXbXVsXDGRhMGApyaRozC2vh50=" crossorigin=anonymous></script>
<link rel=alternate type=application/rss+xml href=http://hindung.cn/tags/go/index.xml title="Hindung Blogs"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Hindung Blogs</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul><li class="flex justify-between"><a href=/tags/go/>Go</a>
<span>12</span></li><li class="flex justify-between"><a href=/tags/kubernetes/>Kubernetes</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/blog/>Blog</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/makerdown/>Makerdown</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/docker/>Docker</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/network/>Network</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/leetcode/>LeetCode</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/%E6%A0%B8%E5%BF%83%E7%AB%9E%E4%BA%89%E5%8A%9B/>æ ¸å¿ƒç«äº‰åŠ›</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/algorithm/>Algorithm</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/heap/>heap</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/queue/>queue</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/gin/>Gin</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/dockerfile/>Dockerfile</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/markdown/>Markdown</a>
<span>1</span></li></ul></li></ul></nav></aside></header><article class="markdown book-post"><h2><a href=/posts/26/>K8s client-goåˆå§‹åŒ–çš„å‡ ç§æ–¹æ³•</a></h2><h5>July 19, 2022</h5><div><a href=/tags/kubernetes/>Kubernetes</a>,
<a href=/tags/go/>Go</a></div><p>ç®€ä»‹ # client-goæ˜¯k8sçš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶åº“ï¼Œæ˜¯ç”¨äºä¸API-Serveräº¤äº’çš„httpå®¢æˆ·ç«¯ã€‚K8sä¸­å¤§éƒ¨åˆ†ç»„ä»¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“å®ç°ä¸API-Serverçš„é€šä¿¡åŠŸèƒ½ã€‚é™¤äº†èƒ½å¤Ÿå¯¹èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿˜å¯Watchä¸€ä¸ªå¯¹è±¡ã€å‡çº§æˆwebsocketé“¾æ¥ç­‰ç­‰åŠŸèƒ½ã€‚
client-goæ”¯æŒå››ç§å®¢æˆ·ç«¯ï¼šRESTClientã€ClientSetã€DynamicClientã€DiscoveryClientã€‚è¿™å‡ ä¸ªclientå¯ä»¥ç›¸äº’è½¬æ¢ã€‚
RESTClient # RESTClientæ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œç›¸å½“äºæœ€åº•å±‚çš„åŸºç¡€ç»“æ„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡RESTClientæä¾›çš„RESTfulæ–¹æ³•å¦‚Get()ã€Put()ã€Post()ã€Delete()è¿›è¡Œäº¤äº’ã€‚
ä¸€èˆ¬è€Œè¨€ï¼Œä¸ºäº†æ›´ä¸ºä¼˜é›…çš„å¤„ç†ï¼Œéœ€è¦è¿›ä¸€æ­¥å°è£…ï¼Œé€šè¿‡Clientsetå°è£…RESTClientï¼Œç„¶åå†å¯¹å¤–æä¾›æ¥å£å’ŒæœåŠ¡ã€‚
å¯ä»¥é€šè¿‡ClientSetå®¢æˆ·ç«¯è·å¾—ï¼š
client := cli.CoreV1().RESTClient().(*rest.RESTClient) ClientSet # Clientsetæ˜¯è°ƒç”¨Kubernetesèµ„æºå¯¹è±¡æœ€å¸¸ç”¨çš„clientï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼ŒåŒ…å«RESTClientã€‚éœ€è¦åˆ¶å®šGroupã€Versionï¼Œç„¶åæ ¹æ®Resourceè·å–ã€‚
clientset,err := kubernetes.NewForConfig(config) sa, err := clientset.CoreV1().ServiceAccounts("kube-system").Get("kube-shell-admin", metav1.GetOptions{}) DynamicClient # Dynamic clientæ˜¯ä¸€ç§åŠ¨æ€çš„clientï¼Œå®ƒèƒ½å¤„ç†kubernetesæ‰€æœ‰çš„èµ„æºã€‚ä¸åŒäºclientsetï¼Œdynamic clientè¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ªmap[string]interface{}ã€‚
dynamicClient,err := dynamic.NewForConfig(config) gvr := schema.GroupVersionResource{Version: "v1",Resource: "pods"} unstructObjList,err := dynamicClient.Resource(gvr).Namespace("dev").List(context.TODO(),metav1.ListOptions{Limit: 100}) DiscoveryClient # DiscoveryClientæ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºå‘ç°kubernetes API Serveræ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨æˆ·æœ¬åœ°ç¼“å­˜ï¼Œä»¥å‡è½»å¯¹Kubernetes API Serverè®¿é—®çš„å‹åŠ›ã€‚ kubectlçš„api-versionså’Œapi-resourceså‘½ä»¤è¾“å‡ºä¹Ÿæ˜¯é€šè¿‡DisconversyClientå®ç°çš„ã€‚
discoveryClient,err := discovery.NewDiscoveryClientForConfig(config) APIGroup,APIResourceListSlice,err := discoveryClient.ServerGroupsAndResources() è¿™å‡ ç§å®¢æˆ·ç«¯çš„åˆå§‹åŒ–éƒ½æ¶‰åŠåˆ°äº†å…¥å‚configï¼Œå³*rest.Configï¼Œè¿™ä¸ªæ˜¯ç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚
rest.Configåˆå§‹åŒ– # åˆ›å»ºclientå‰ï¼Œéœ€è¦å…ˆä»åˆå§‹åŒ–*rest.Configï¼Œè¿™ä¸ª*rest.Configå¯ä»¥ä»é›†ç¾¤å¤–çš„kubeconfigæ–‡ä»¶æˆ–è€…é›†ç¾¤å†…éƒ¨çš„ tokenFile å’Œ CAFileåˆå§‹åŒ–ï¼ˆé€šè¿‡ServiceAcountè‡ªåŠ¨æŒ‚è½½ï¼‰ã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š
é›†ç¾¤å¤–é€šè¿‡kubeconfigåˆå§‹åŒ– # BuildConfigFromFlagsæ–¹æ³•ä»ç»™å®šçš„urlæˆ–è€…kubeconfigæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„å»åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™ä¼šä½¿ç”¨é›†ç¾¤å†…éƒ¨æ–¹æ³•åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤çš„configã€‚
// "k8s.io/client-go/tools/clientcmd" config, err := clientcmd.
<a href=/posts/26/>...</a></p></article><article class="markdown book-post"><h2><a href=/posts/19/>Goæºç è§£è¯»ä¹‹sync.Cond</a></h2><h5>May 16, 2021</h5><div><a href=/tags/go/>Go</a></div><p>å‰è¨€ # å‰é¢ğŸ”—è¯´è¿‡ï¼ŒCondå®ç°äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæ˜¯ç­‰å¾…æˆ–å®£å¸ƒä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„goroutinesçš„æ±‡åˆç‚¹ã€‚
å°±æ˜¯è¯´ï¼Œä½¿ç”¨sync.Condå¯ä»¥åšåˆ°å¤šä¸ªåç¨‹ç­‰å¾…æŸä¸ªåç¨‹é€šçŸ¥çš„åœºæ™¯ã€‚
ä½¿ç”¨channelå¯ä»¥å®ç°ä¸€è¯»ä¸€å†™çš„åœºæ™¯ï¼Œè€ŒCondåˆ™å®ç°å¤šè¯»ä¸€å†™çš„åœºæ™¯ã€‚
æºç è§£æ # ç®€åŒ–ç‰ˆæ–¹æ³•ç­¾åï¼š
// Condç»“æ„ä½“ type Cond struct {} // NewCond è¿”å›å¸¦Lockerçš„Condï¼Œè¿™ä¸ªLockerå¯ä»¥æ˜¯ // *Mutex æˆ– *RWMutex func NewCond(l Locker) *Cond {} // ç­‰å¾…Lçš„è§£é”å¹¶æŒ‚èµ·goroutine func (c *Cond) Wait() {} // å”¤é†’1ä¸ªå› cé˜»å¡çš„goroutineï¼Œ // å¦‚æœåœ¨Signalä¹‹åæ‰Waitä¼šå¯¼è‡´all goroutines are asleep - deadlock func (c *Cond) Signal() {} // å”¤é†’æ‰€æœ‰å› cé˜»å¡çš„goroutine // å¦‚æœåœ¨Broadcastä¹‹åæ‰Waitä¼šå¯¼è‡´all goroutines are asleep - deadlock func (c *Cond) Broadcast() {} å› æ­¤ï¼Œåœ¨Signalæˆ–è€…Broadcastå‰è¦å…ˆä¿è¯ç›®æ ‡çš„åç¨‹å·²ç»è¿›å…¥äº†WaitçŠ¶æ€ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”ã€‚å› ä¸ºSignalæˆ–è€…Broadcaståªå”¤é†’å½“å‰æ­£åœ¨è¢«Waité˜»å¡çš„åç¨‹ã€‚
Condçš„å®šä¹‰ï¼š
// Copyright 2011 The Go Authors. All rights reserved.
<a href=/posts/19/>...</a></p></article><article class="markdown book-post"><h2><a href=/posts/18/>Goæºç è§£è¯»ä¹‹syncä¸­çš„åŸºæœ¬ç±»å‹å’Œä½¿ç”¨åœºæ™¯</a></h2><h5>May 11, 2021</h5><div><a href=/tags/go/>Go</a></div><p>Overview # åŒ…é“¾æ¥ğŸ”—
syncåŒ…æä¾›åŸºæœ¬çš„åŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚äº’æ–¥é”ã€‚
é™¤äº†Onceå’ŒWaitGroupç±»å‹å¤–ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ä¾›ä½çº§åº“ä¾‹ç¨‹ä½¿ç”¨çš„ã€‚
æ›´é«˜å±‚æ¬¡çš„åŒæ­¥æœ€å¥½é€šè¿‡channelså’Œé€šä¿¡æ¥å®Œæˆã€‚
ä»ä»£ç çœ‹ï¼Œsyncæä¾›äº†å‡ ç§ç±»å‹ï¼š
Condï¼šæ¡ä»¶å˜é‡ Lockerï¼šé”çš„æ¥å£å®šä¹‰ Mapï¼šåç¨‹å¹¶å‘å®‰å…¨çš„Map Mutexï¼šäº’æ–¥é” Onceï¼šå•æ¬¡æ‰§è¡Œ Poolï¼šæ±  RWMutexï¼šè¯»å†™é” WaitGroupï¼šç­‰å¾…ç»„ å‡ ä¸ªç±»å‹åˆ†åˆ«å¯¹åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚
sync.Cond # Condå®ç°äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæ˜¯ç­‰å¾…æˆ–å®£å¸ƒä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„goroutinesçš„æ±‡åˆç‚¹ã€‚
é€šä¿—çš„è¯´ï¼Œsync.Condç”¨æ¥åè°ƒé‚£äº›è®¿é—®å…±äº«èµ„æºçš„goroutineï¼Œå½“å…±äº«èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥è¢«é˜»å¡goroutineã€‚
sync.Cond ç»å¸¸ç”¨åœ¨å¤šä¸ª goroutine ç­‰å¾…ä¸€ä¸ª goroutine é€šçŸ¥ï¼ˆäº‹ä»¶å‘ç”Ÿï¼‰çš„åœºæ™¯ã€‚
sync.Map # Mapå°±åƒGoä¸­çš„map[interface{}]interface{}ï¼Œä½†å¯¹äºå¤šä¸ªgoroutineçš„å¹¶å‘ä½¿ç”¨æ˜¯å®‰å…¨çš„ï¼Œä¸éœ€è¦é¢å¤–çš„é”æˆ–åè°ƒã€‚
ä½¿ç”¨map + sync.Mutexæˆ–è€…sync.RWMutexçš„æ–¹å¼ä¹Ÿå¯ä»¥å®ç°ä¸sync.Mapç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œsync.Mapå…·æœ‰æ›´é«˜çš„æ€§èƒ½ï¼š
Mapç±»å‹é’ˆå¯¹ä¸¤ç§å¸¸è§ç”¨ä¾‹è¿›è¡Œäº†ä¼˜åŒ–ï¼š
å½“ç»™å®škeyçš„æ¡ç›®ä»…è¢«å†™å…¥ä¸€æ¬¡å´è¢«è¯»å–å¤šæ¬¡æ—¶ï¼Œä¾‹å¦‚åœ¨ä»…å¢é•¿çš„é«˜é€Ÿç¼“å­˜ä¸­ å½“å¤šä¸ªgoroutineè¯»å–ï¼Œå†™å…¥å’Œè¦†ç›–çš„keyéƒ½ä¸ç›¸å…³æ—¶ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¸ä¸å•ç‹¬çš„Mutexæˆ–RWMutex + map ç›¸æ¯”ï¼Œä½¿ç”¨Mapå¯ä»¥æ˜¾ç€å‡å°‘é”äº‰ç”¨ã€‚
sync.Mutex # Mutexæ˜¯ä¸€ä¸ªç›¸äº’æ’æ–¥çš„é”ã€‚Mutexçš„é›¶å€¼æ˜¯ä¸€ä¸ªè§£é”çš„Mutexã€‚
å½“è°ƒç”¨Lockæ–¹æ³•è¿›è¡ŒåŠ é”æ—¶ï¼Œå¦‚æœé”å·²åœ¨ä½¿ç”¨ä¸­ï¼Œåˆ™goroutineä¼šé˜»å¡ï¼Œç›´åˆ°é”å¯ç”¨ä¸ºæ­¢ã€‚ å½“è°ƒç”¨UnLockæ–¹æ³•è¿›è¡Œè§£é”æ—¶ï¼Œå¦‚æœé”æ²¡æœ‰åœ¨ä½¿ç”¨ï¼Œåˆ™ä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯ã€‚
é”å®šçš„äº’æ–¥é”ä¸ç‰¹å®šçš„goroutineæ²¡æœ‰å…³è”ã€‚å…è®¸ä¸€ä¸ªgoroutineé”å®šMutexï¼Œç„¶åå®‰æ’å¦ä¸€ä¸ªgoroutineå¯¹å…¶è¿›è¡Œè§£é”ã€‚
sync.RWMutex # RWMutexæ˜¯ä¸€ä¸ªè¯»å†™å™¨ç›¸äº’æ’æ–¥çš„é”ã€‚ è¯¥é”å¯ä»¥ç”±ä»»æ„æ•°é‡çš„è¯»è€…æˆ–å•ä¸€çš„å†™è€…æŒæœ‰ã€‚RWMutexçš„é›¶å€¼æ˜¯ä¸€ä¸ªè§£é”çš„mutexã€‚
è¯»è¯»ä¸äº’æ–¥ï¼Œè¯»å†™äº’æ–¥ï¼Œå†™å†™äº’æ–¥ã€‚
sync.Once # Onceçš„Do(f)æ–¹æ³•ä¿è¯åªè¿è¡Œä¸€æ¬¡ï¼Œå³ä½¿få‘ç”Ÿpanicã€‚ è¿™å¸¸ç”¨åœ¨å•ä¾‹æ¨¡å¼ï¼Œé…ç½®æ–‡ä»¶åŠ è½½ï¼Œåˆå§‹åŒ–è¿™äº›åœºæ™¯ä¸‹ã€‚
sync.Pool # Poolæ˜¯ä¸€ç»„å¯ä»¥å•ç‹¬ä¿å­˜å’Œæ£€ç´¢çš„ä¸´æ—¶å¯¹è±¡ã€‚ å‚¨å­˜åœ¨æ± å­é‡Œçš„ä»»ä½•å¯¹è±¡éƒ½å¯èƒ½åœ¨ä»»ä½•æ—¶å€™è¢«è‡ªåŠ¨åˆ é™¤ï¼Œè€Œæ— éœ€é€šçŸ¥ã€‚ æ± å¯ä»¥å®‰å…¨åœ°åŒæ—¶è¢«å¤šä¸ªgoroutineä½¿ç”¨ã€‚
Poolçš„ä½œç”¨æ˜¯ç¼“å­˜å·²åˆ†é…ä½†æœªä½¿ç”¨çš„é¡¹ç›®ï¼Œä»¥ä¾¿ä»¥åå†ä½¿ç”¨ï¼Œå‡è½»åƒåœ¾æ”¶é›†å™¨çš„å‹åŠ›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä½¿å»ºç«‹é«˜æ•ˆã€çº¿ç¨‹å®‰å…¨çš„è‡ªç”±åˆ—è¡¨å˜å¾—å®¹æ˜“ã€‚
æ± çš„ä¸€ä¸ªé€‚å½“çš„ç”¨é€”æ˜¯ç®¡ç†ä¸€ç»„ä¸´æ—¶é¡¹ç›®ï¼Œè¿™äº›ä¸´æ—¶é¡¹ç›®åœ¨åŒ…çš„ç‹¬ç«‹å®¢æˆ·ç«¯ä¹‹é—´é»˜é»˜åœ°å…±äº«ï¼Œå¹¶å¯èƒ½è¢«é‡å¤ä½¿ç”¨ã€‚Poolæä¾›äº†ä¸€ç§åœ¨è®¸å¤šå®¢æˆ·ç«¯ä¹‹é—´åˆ†æ‘Šåˆ†é…å¼€é”€çš„æ–¹æ³•ã€‚
å½“ç„¶ï¼ŒPoolå¹¶ä¸é€‚ç”¨äºä¸€äº›çŸ­å‘½çš„å¯¹è±¡æ± åŒ–ã€‚
ç›¸å½“äºæ‹¿å‡ºæ¥ï¼Œåšæ“ä½œï¼Œå†æ”¾å›å»ï¼Œæ“ä½œè¿‡çš„ä¸œè¥¿æ”¾å›å»çš„æ—¶å€™æ˜¯å•¥æ ·ï¼Œæ‹¿å‡ºæ¥çš„æ—¶å€™å°±æ˜¯å•¥æ ·çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‹¿å‡ºæ¥ç”¨çš„æ—¶å€™éœ€è¦åˆå§‹åŒ–æ•°æ®æˆ–è€…æ¸…ç©ºã€‚ å¦‚Ginçš„æºç ï¼šhttps://github.com/gin-gonic/gin/blob/v1.7.1/gin.go#L439
// ServeHTTP conforms to the http.
<a href=/posts/18/>...</a></p></article><article class="markdown book-post"><h2><a href=/posts/16/>æ·±æ‹·è´ä¹‹å¾ªç¯å¼•ç”¨</a></h2><h5>May 8, 2021</h5><div><a href=/tags/leetcode/>LeetCode</a>,
<a href=/tags/go/>Go</a></div><p>é¢˜ç›® # å®ç°å¦‚ä¸‹ç»“æ„ä½“çš„æ·±æ‹·è´ã€‚
type Node struct { Data int Fields []*Node } å³æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¹Ÿéœ€è¦Copyä¸€ä»½ã€‚
è§£æ # è§‚å¯Ÿç»“æ„ä½“ï¼Œç”±äºFieldså­—æ®µé‡Œå­˜æ”¾çš„æ˜¯æŒ‡å‘Nodeç»“æ„ä½“çš„æŒ‡é’ˆåˆ‡ç‰‡ï¼Œæ·±æ‹·è´æ—¶è¦è€ƒè™‘å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå¦‚ï¼š
struct a : data: 1 fields: b, c struct b: data: 2 fields: c struct c: data: 3 fields: a // è¿™é‡Œå¾ªç¯å¼•ç”¨äº†aï¼Œ c->a->b, c->a å¯ä»¥è€ƒè™‘ä½¿ç”¨map[*Node]*Nodeæ¥åˆ¤æ–­æ˜¯å¦æœ‰ç¯çš„æƒ…å†µï¼Œå³ç”¨map[src] = dstæ¥ä¿å­˜æ‹·è´è¿‡çš„èŠ‚ç‚¹ã€‚
ä»£ç  # ä»£ç å¦‚ä¸‹ï¼š
package main import ( "go/ast" "go/token" ) type Node struct { Data int Fields []*Node } // deep copy var M map[*Node]*Node func Dup(src *Node) *Node { if src == nil { return nil } node := &amp;Node{ Data: src.
<a href=/posts/16/>...</a></p></article><article class="markdown book-post"><h2><a href=/posts/14/>Goæºç è§£è¯»ä¹‹sync/atomic</a></h2><h5>April 29, 2021</h5><div><a href=/tags/go/>Go</a></div><p>æ³¨ï¼šgo version 1.16.x
Overview # ä»ç½‘ç«™pkg.go.devä¸Šå¯ä»¥çœ‹åˆ°ï¼Œå¯¹åº”çš„è§£é‡Šã€‚
atomicåŒ…æä¾›äº†ç”¨äºå®ç°åŒæ­¥ç®—æ³•çš„ä½çº§åŸå­å†…å­˜åŸè¯­ã€‚
å¯ä»¥åˆ†ä¸ºå‡ ç±»æ“ä½œï¼š
Addæ“ä½œï¼šåŠ å‡æ“ä½œ CASæ“ä½œï¼šå…ˆæ¯”è¾ƒåèµ‹å€¼æ“ä½œ Swapæ“ä½œï¼šèµ‹å€¼æ“ä½œ Loadæ“ä½œï¼šä»æŸä¸ªåœ°å€ä¸­å–å€¼ Storeæ“ä½œï¼šå¾€æŸä¸ªåœ°å€èµ‹å€¼ Valueç±»å‹ï¼šå¯¹ä»»æ„ç±»å‹çš„Load/Storeæ“ä½œå°è£… æ“ä½œåˆ†ç±» # Addæ“ä½œ # ç”±AddTå‡½æ•°å®ç°çš„åŠ æ³•æ“ä½œåœ¨åŸå­ä¸Šç­‰æ•ˆäºï¼š
*addr += delta \\ åŠ ä¸Šæ­¥é•¿ æ­£è´Ÿæ•°éƒ½å¯ä»¥ return *addr \\ åå›åŠ åçš„ç»“æœ ç›¸å…³çš„æ–¹æ³•æœ‰ï¼š
func AddInt32(addr *int32, delta int32) (new int32) func AddUint32(addr *uint32, delta uint32) (new uint32) func AddInt64(addr *int64, delta int64) (new int64) func AddUint64(addr *uint64, delta uint64) (new uint64) func AddUintptr(addr *uintptr, delta uintptr) (new uintptr) CASæ“ä½œ # CASå³CompareAndSwapï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯å…ˆæ¯”è¾ƒä¸€ä¸‹å½“å‰ä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦å’Œ old å€¼ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°±èµ‹å€¼æ–°å€¼è¿”å› trueï¼Œå¦‚æœä¸ç›¸ç­‰å°±è¿”å› false.
<a href=/posts/14/>...</a></p></article><ul class="pagination pagination-default"><li class="page-item disabled"><a aria-disabled=true aria-label=First class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;&#171;</span></a></li><li class="page-item disabled"><a aria-disabled=true aria-label=Previous class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;</span></a></li><li class="page-item active"><a aria-current=page aria-label="Page 1" class=page-link role=button>1</a></li><li class=page-item><a href=/tags/go/page/2/ aria-label="Page 2" class=page-link role=button>2</a></li><li class=page-item><a href=/tags/go/page/3/ aria-label="Page 3" class=page-link role=button>3</a></li><li class=page-item><a href=/tags/go/page/2/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/tags/go/page/3/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul><li class="flex justify-between"><a href=/tags/go/>Go</a>
<span>12</span></li><li class="flex justify-between"><a href=/tags/kubernetes/>Kubernetes</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/blog/>Blog</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/makerdown/>Makerdown</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/docker/>Docker</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/network/>Network</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/leetcode/>LeetCode</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/%E6%A0%B8%E5%BF%83%E7%AB%9E%E4%BA%89%E5%8A%9B/>æ ¸å¿ƒç«äº‰åŠ›</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/algorithm/>Algorithm</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/heap/>heap</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/queue/>queue</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/gin/>Gin</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/dockerfile/>Dockerfile</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/markdown/>Markdown</a>
<span>1</span></li></ul></li></ul></nav></div></aside></main></body></html>