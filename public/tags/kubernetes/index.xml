<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kubernetes on Hindung Blogs</title>
    <link>http://hindung.cn/tags/kubernetes/</link>
    <description>Recent content in Kubernetes on Hindung Blogs</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 19 Jul 2022 00:00:00 +0000</lastBuildDate><atom:link href="http://hindung.cn/tags/kubernetes/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>K8s client-goåˆå§‹åŒ–çš„å‡ ç§æ–¹æ³•</title>
      <link>http://hindung.cn/posts/26/</link>
      <pubDate>Tue, 19 Jul 2022 00:00:00 +0000</pubDate>
      
      <guid>http://hindung.cn/posts/26/</guid>
      <description>ç®€ä»‹ client-goæ˜¯k8sçš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶åº“ï¼Œæ˜¯ç”¨äºä¸API-Serveräº¤äº’çš„httpå®¢æˆ·ç«¯ã€‚K8sä¸­å¤§éƒ¨åˆ†ç»„ä»¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“å®ç°ä¸API-Serverçš„é€šä¿¡åŠŸèƒ½ã€‚é™¤äº†èƒ½å¤Ÿå¯¹èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿˜å¯Watchä¸€ä¸ªå¯¹è±¡ã€å‡çº§æˆwebsocketé“¾æ¥ç­‰ç­‰åŠŸèƒ½ã€‚
client-goæ”¯æŒå››ç§å®¢æˆ·ç«¯ï¼šRESTClientã€ClientSetã€DynamicClientã€DiscoveryClientã€‚è¿™å‡ ä¸ªclientå¯ä»¥ç›¸äº’è½¬æ¢ã€‚
RESTClient RESTClientæ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œç›¸å½“äºæœ€åº•å±‚çš„åŸºç¡€ç»“æ„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡RESTClientæä¾›çš„RESTfulæ–¹æ³•å¦‚Get()ã€Put()ã€Post()ã€Delete()è¿›è¡Œäº¤äº’ã€‚
ä¸€èˆ¬è€Œè¨€ï¼Œä¸ºäº†æ›´ä¸ºä¼˜é›…çš„å¤„ç†ï¼Œéœ€è¦è¿›ä¸€æ­¥å°è£…ï¼Œé€šè¿‡Clientsetå°è£…RESTClientï¼Œç„¶åå†å¯¹å¤–æä¾›æ¥å£å’ŒæœåŠ¡ã€‚
å¯ä»¥é€šè¿‡ClientSetå®¢æˆ·ç«¯è·å¾—ï¼š
client := cli.CoreV1().RESTClient().(*rest.RESTClient) ClientSet Clientsetæ˜¯è°ƒç”¨Kubernetesèµ„æºå¯¹è±¡æœ€å¸¸ç”¨çš„clientï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼ŒåŒ…å«RESTClientã€‚éœ€è¦åˆ¶å®šGroupã€Versionï¼Œç„¶åæ ¹æ®Resourceè·å–ã€‚
clientset,err := kubernetes.NewForConfig(config) sa, err := clientset.CoreV1().ServiceAccounts(&amp;#34;kube-system&amp;#34;).Get(&amp;#34;kube-shell-admin&amp;#34;, metav1.GetOptions{}) DynamicClient Dynamic clientæ˜¯ä¸€ç§åŠ¨æ€çš„clientï¼Œå®ƒèƒ½å¤„ç†kubernetesæ‰€æœ‰çš„èµ„æºã€‚ä¸åŒäºclientsetï¼Œdynamic clientè¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ªmap[string]interface{}ã€‚
dynamicClient,err := dynamic.NewForConfig(config) gvr := schema.GroupVersionResource{Version: &amp;#34;v1&amp;#34;,Resource: &amp;#34;pods&amp;#34;} unstructObjList,err := dynamicClient.Resource(gvr).Namespace(&amp;#34;dev&amp;#34;).List(context.TODO(),metav1.ListOptions{Limit: 100}) DiscoveryClient DiscoveryClientæ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºå‘ç°kubernetes API Serveræ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨æˆ·æœ¬åœ°ç¼“å­˜ï¼Œä»¥å‡è½»å¯¹Kubernetes API Serverè®¿é—®çš„å‹åŠ›ã€‚ kubectlçš„api-versionså’Œapi-resourceså‘½ä»¤è¾“å‡ºä¹Ÿæ˜¯é€šè¿‡DisconversyClientå®ç°çš„ã€‚
discoveryClient,err := discovery.NewDiscoveryClientForConfig(config) APIGroup,APIResourceListSlice,err := discoveryClient.ServerGroupsAndResources() è¿™å‡ ç§å®¢æˆ·ç«¯çš„åˆå§‹åŒ–éƒ½æ¶‰åŠåˆ°äº†å…¥å‚configï¼Œå³*rest.Configï¼Œè¿™ä¸ªæ˜¯ç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚
rest.Configåˆå§‹åŒ– åˆ›å»ºclientå‰ï¼Œéœ€è¦å…ˆä»åˆå§‹åŒ–*rest.Configï¼Œè¿™ä¸ª*rest.Configå¯ä»¥ä»é›†ç¾¤å¤–çš„kubeconfigæ–‡ä»¶æˆ–è€…é›†ç¾¤å†…éƒ¨çš„ tokenFile å’Œ CAFileåˆå§‹åŒ–ï¼ˆé€šè¿‡ServiceAcountè‡ªåŠ¨æŒ‚è½½ï¼‰ã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š
é›†ç¾¤å¤–é€šè¿‡kubeconfigåˆå§‹åŒ– BuildConfigFromFlagsæ–¹æ³•ä»ç»™å®šçš„urlæˆ–è€…kubeconfigæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„å»åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™ä¼šä½¿ç”¨é›†ç¾¤å†…éƒ¨æ–¹æ³•åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤çš„configã€‚
// &amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34; config, err := clientcmd.BuildConfigFromFlags(&amp;#34;&amp;#34;, *kubeconfig) if err != nil {  panic(err.</description>
      <content>&lt;h2 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;client-goæ˜¯k8sçš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶åº“ï¼Œæ˜¯ç”¨äºä¸API-Serveräº¤äº’çš„httpå®¢æˆ·ç«¯ã€‚K8sä¸­å¤§éƒ¨åˆ†ç»„ä»¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“å®ç°ä¸API-Serverçš„é€šä¿¡åŠŸèƒ½ã€‚é™¤äº†èƒ½å¤Ÿå¯¹èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿˜å¯Watchä¸€ä¸ªå¯¹è±¡ã€å‡çº§æˆwebsocketé“¾æ¥ç­‰ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;client-goæ”¯æŒå››ç§å®¢æˆ·ç«¯ï¼š&lt;code&gt;RESTClient&lt;/code&gt;ã€&lt;code&gt;ClientSet&lt;/code&gt;ã€&lt;code&gt;DynamicClient&lt;/code&gt;ã€&lt;code&gt;DiscoveryClient&lt;/code&gt;ã€‚è¿™å‡ ä¸ªclientå¯ä»¥ç›¸äº’è½¬æ¢ã€‚&lt;/p&gt;
&lt;h3 id=&#34;restclient&#34;&gt;RESTClient&lt;/h3&gt;
&lt;p&gt;RESTClientæ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œç›¸å½“äºæœ€åº•å±‚çš„åŸºç¡€ç»“æ„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡RESTClientæä¾›çš„RESTfulæ–¹æ³•å¦‚Get()ã€Put()ã€Post()ã€Delete()è¿›è¡Œäº¤äº’ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€èˆ¬è€Œè¨€ï¼Œä¸ºäº†æ›´ä¸ºä¼˜é›…çš„å¤„ç†ï¼Œéœ€è¦è¿›ä¸€æ­¥å°è£…ï¼Œé€šè¿‡Clientsetå°è£…RESTClientï¼Œç„¶åå†å¯¹å¤–æä¾›æ¥å£å’ŒæœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥é€šè¿‡ClientSetå®¢æˆ·ç«¯è·å¾—ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cli&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;CoreV1&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;RESTClient&lt;/span&gt;().(&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;rest&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;RESTClient&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;clientset&#34;&gt;ClientSet&lt;/h3&gt;
&lt;p&gt;Clientsetæ˜¯è°ƒç”¨Kubernetesèµ„æºå¯¹è±¡æœ€å¸¸ç”¨çš„clientï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼ŒåŒ…å«RESTClientã€‚éœ€è¦åˆ¶å®šGroupã€Versionï¼Œç„¶åæ ¹æ®Resourceè·å–ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;clientset&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;kubernetes&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;NewForConfig&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sa&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;clientset&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;CoreV1&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;ServiceAccounts&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kube-system&amp;#34;&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;Get&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kube-shell-admin&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;metav1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;GetOptions&lt;/span&gt;{})
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;dynamicclient&#34;&gt;DynamicClient&lt;/h3&gt;
&lt;p&gt;Dynamic clientæ˜¯ä¸€ç§åŠ¨æ€çš„clientï¼Œå®ƒèƒ½å¤„ç†kubernetesæ‰€æœ‰çš„èµ„æºã€‚ä¸åŒäºclientsetï¼Œdynamic clientè¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ª&lt;code&gt;map[string]interface{}&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;dynamicClient&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dynamic&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;NewForConfig&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;gvr&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;schema&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;GroupVersionResource&lt;/span&gt;{&lt;span style=&#34;color:#a6e22e&#34;&gt;Version&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;v1&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;Resource&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pods&amp;#34;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;unstructObjList&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dynamicClient&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Resource&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;gvr&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;Namespace&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dev&amp;#34;&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;List&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;context&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;TODO&lt;/span&gt;(),&lt;span style=&#34;color:#a6e22e&#34;&gt;metav1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;ListOptions&lt;/span&gt;{&lt;span style=&#34;color:#a6e22e&#34;&gt;Limit&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;})
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;discoveryclient&#34;&gt;DiscoveryClient&lt;/h3&gt;
&lt;p&gt;DiscoveryClientæ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºå‘ç°kubernetes API Serveræ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨æˆ·æœ¬åœ°ç¼“å­˜ï¼Œä»¥å‡è½»å¯¹Kubernetes API Serverè®¿é—®çš„å‹åŠ›ã€‚ kubectlçš„api-versionså’Œapi-resourceså‘½ä»¤è¾“å‡ºä¹Ÿæ˜¯é€šè¿‡DisconversyClientå®ç°çš„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;discoveryClient&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;discovery&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;NewDiscoveryClientForConfig&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;APIGroup&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;APIResourceListSlice&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;discoveryClient&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;ServerGroupsAndResources&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™å‡ ç§å®¢æˆ·ç«¯çš„åˆå§‹åŒ–éƒ½æ¶‰åŠåˆ°äº†å…¥å‚configï¼Œå³&lt;code&gt;*rest.Config&lt;/code&gt;ï¼Œè¿™ä¸ªæ˜¯ç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;restconfigåˆå§‹åŒ–&#34;&gt;rest.Configåˆå§‹åŒ–&lt;/h2&gt;
&lt;p&gt;åˆ›å»ºclientå‰ï¼Œéœ€è¦å…ˆä»åˆå§‹åŒ–&lt;code&gt;*rest.Config&lt;/code&gt;ï¼Œè¿™ä¸ª&lt;code&gt;*rest.Config&lt;/code&gt;å¯ä»¥ä»é›†ç¾¤å¤–çš„kubeconfigæ–‡ä»¶æˆ–è€…é›†ç¾¤å†…éƒ¨çš„ tokenFile å’Œ CAFileåˆå§‹åŒ–ï¼ˆé€šè¿‡ServiceAcountè‡ªåŠ¨æŒ‚è½½ï¼‰ã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;h3 id=&#34;é›†ç¾¤å¤–é€šè¿‡kubeconfigåˆå§‹åŒ–&#34;&gt;é›†ç¾¤å¤–é€šè¿‡kubeconfigåˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;BuildConfigFromFlagsæ–¹æ³•ä»ç»™å®šçš„urlæˆ–è€…kubeconfigæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„å»åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™ä¼šä½¿ç”¨é›†ç¾¤å†…éƒ¨æ–¹æ³•åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤çš„configã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// &amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;clientcmd&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;BuildConfigFromFlags&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;kubeconfig&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   panic(&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Error&lt;/span&gt;())
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å†…å­˜ä¸­é€šè¿‡kubeconfigå­—ç¬¦ä¸²æˆ–è€…byteæ•°ç»„åˆå§‹åŒ–&#34;&gt;å†…å­˜ä¸­é€šè¿‡kubeconfigå­—ç¬¦ä¸²æˆ–è€…byteæ•°ç»„åˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;é€šè¿‡è¯»å–kubeconfigæ–‡ä»¶å†…å®¹è¿›è¡Œåˆå§‹åŒ–ä¸€ä¸ªconfigï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;clientcmd&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;NewClientConfigFromBytes&lt;/span&gt;([]byte(string(&lt;span style=&#34;color:#a6e22e&#34;&gt;Data&lt;/span&gt;[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kubeConfig&amp;#34;&lt;/span&gt;])))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;restConfig&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;ClientConfig&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;é›†ç¾¤ä¸­é€šè¿‡serviceacountåˆå§‹åŒ–&#34;&gt;é›†ç¾¤ä¸­é€šè¿‡ServiceAcountåˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;é€šè¿‡é›†ç¾¤å†…éƒ¨é…ç½®åˆ›å»º k8s é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡ KUBERNETES_SERVICE_HOST å’Œ KUBERNETES_SERVICE_PORT ç¯å¢ƒå˜é‡æ–¹å¼è·å–ã€‚&lt;/p&gt;
&lt;p&gt;è‹¥é›†ç¾¤ä½¿ç”¨ TLS è®¤è¯æ–¹å¼ï¼Œåˆ™é»˜è®¤è¯»å–é›†ç¾¤å†…éƒ¨ tokenFile å’Œ CAFileï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;tokenFile = &amp;quot;/var/run/secrets/kubernetes.io/serviceaccount/token&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;rootCAFile = &amp;quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// &amp;#34;k8s.io/client-go/rest&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rest&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;InClusterConfig&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   panic(&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Error&lt;/span&gt;())
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;operator-sdkä¸­åˆå§‹åŒ–config&#34;&gt;operator-sdkä¸­åˆå§‹åŒ–config&lt;/h3&gt;
&lt;p&gt;ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨operator-sdkå¼€å‘CRDséƒ½ä¼šç”¨åˆ°åœ¨æœ¬åœ°è°ƒè¯•æˆ–è€…åœ¨é›†ç¾¤ä¸­è°ƒè¯•çš„æ–¹æ³•ï¼Œåœ¨ä½ç‰ˆæœ¬operator-sdkä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// &amp;#34;sigs.k8s.io/controller-runtime/pkg/client/config&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;cfg&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;config&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;GetConfig&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Error&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#a6e22e&#34;&gt;os&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Exit&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯¥æ–¹æ³•åˆå§‹åŒ–kubeconfigçš„é¡ºåºæ˜¯&amp;ndash;kubeconfigæ ‡ç­¾ï¼ŒKUBECONFIGç¯å¢ƒå˜é‡ï¼ŒIn-clusteré›†ç¾¤å†…SAï¼Œ$HOME/.kube/configæ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨åˆå§‹åŒ–çš„configçš„åŒæ—¶ï¼Œè®¾ç½®äº†è¯·æ±‚çš„QPSï¼Œé»˜è®¤20 QPS, 30 burstã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æŸäº›é«˜ç‰ˆæœ¬sdkä¸­ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•åˆå§‹åŒ–ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;//ctrl &amp;#34;sigs.k8s.io/controller-runtime&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ctrl&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;GetConfigOrDie&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åŸç†åŒä¸Šã€‚&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>Iptableè§„åˆ™åˆæ¢</title>
      <link>http://hindung.cn/posts/22/</link>
      <pubDate>Tue, 01 Jun 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hindung.cn/posts/22/</guid>
      <description>iptableæ˜¯å•¥ å‚è€ƒç»´åŸºç™¾ç§‘ï¼šiptablesæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„åº”ç”¨è½¯ä»¶ï¼Œé€šè¿‡æ§åˆ¶Linuxå†…æ ¸netfilteræ¨¡å—ï¼Œæ¥ç®¡ç†ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†å’Œè½¬å‘ã€‚
iptablesè§„åˆ™ iptablesä¸»è¦æœ‰rawã€mangleã€filterã€natè¿™å‡ ä¸ªè¡¨ï¼Œå¯¹åº”å‡ ä¸ªè§„åˆ™ï¼šPREROUTING ã€INPUT ã€FORWARD ã€OUTPUTã€POSTROUTING ã€‚
NAT åŒ…æ‹¬ SNAT ï¼ˆæºåœ°å€è½¬æ¢ï¼‰å’Œ DNAT ï¼ˆç›®çš„åœ°å€è½¬æ¢ï¼‰ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºåšåœ°å€è½¬æ¢æ˜¯åœ¨è·¯ç”±å‰è¿˜æ˜¯è·¯ç”±åï¼ŒSNATå’ŒDNATæ€»æ˜¯æˆå¯¹å‡ºç°çš„ã€‚
å¯¹åº”çš„å«ä¹‰å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š
   è¡¨å ç”¨é€” åŒ…å«çš„è§„åˆ™     è¡¨å ç”¨é€” åŒ…å«çš„è§„åˆ™   raw å…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªæœºåˆ¶ PREROUTINGï¼ŒOUTPUT   mangle æ‹†è§£æŠ¥æ–‡ï¼Œåšå‡ºä¿®æ”¹ï¼Œå¹¶é‡æ–°å°è£…çš„åŠŸèƒ½ PREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING   nat ç½‘ç»œåœ°å€è½¬æ¢åŠŸèƒ½ PREROUTINGï¼ŒOUTPUTï¼ŒPOSTROUTINGï¼ˆcentos7ä¸­è¿˜æœ‰INPUTï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰   filter è´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œé˜²ç«å¢™ INPUTï¼ŒFORWARDï¼ŒOUTPUT    è§„åˆ™çš„æ„ä¹‰ï¼š
   è§„åˆ™ æ„ä¹‰     PREROUTING æŠ¥æ–‡åˆšåˆšåˆ°è¾¾ä¸»æœºï¼Œè¿˜æ²¡ç»è¿‡è·¯ç”±   INPUT æŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±ï¼Œåˆ¤æ–­æ˜¯å‘é€ç»™æœ¬æœºçš„æŠ¥æ–‡   FORWARD æŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±ï¼Œåˆ¤æ–­ä¸æ˜¯æœ¬æœºçš„æŠ¥æ–‡ï¼Œå¦‚æœå†…æ ¸å¼€å¯è½¬å‘åŠŸèƒ½åˆ™è½¬å‘å‡ºå»ï¼Œå¦åˆ™ä¸¢å¼ƒ   OUTPUT æŠ¥æ–‡ä»åº”ç”¨å‘å‡ºæŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±   POSTROUTING æŠ¥æ–‡ä»åº”ç”¨å‘å‡ºå·²ç»ç»è¿‡è·¯ç”±ï¼Œå‡†å¤‡ä»ç½‘å¡å‘å‡º    æ•°æ®ä»ç½‘ç»œåˆ°è¾¾ä¸»æœºï¼Œå†ä»ä¸»æœºåˆ°è¾¾åº”ç”¨çš„è¿‡ç¨‹ï¼Œä»¥é›†ç¾¤ä¸­traefikéƒ¨ç½²çš„Ingressä¸ºä¾‹ï¼Œå¯ä»¥ç†è§£ä¸ºï¼š iptableç›¸å…³å‘½ä»¤ æŸ¥çœ‹iptablesè§„åˆ™ï¼š</description>
      <content>&lt;h2 id=&#34;iptableæ˜¯å•¥&#34;&gt;iptableæ˜¯å•¥&lt;/h2&gt;
&lt;p&gt;å‚è€ƒ&lt;a href=&#34;https://zh.wikipedia.org/wiki/Iptables&#34;&gt;ç»´åŸºç™¾ç§‘&lt;/a&gt;ï¼šiptablesæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„åº”ç”¨è½¯ä»¶ï¼Œé€šè¿‡æ§åˆ¶Linuxå†…æ ¸netfilteræ¨¡å—ï¼Œæ¥ç®¡ç†ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†å’Œè½¬å‘ã€‚&lt;/p&gt;
&lt;h2 id=&#34;iptablesè§„åˆ™&#34;&gt;iptablesè§„åˆ™&lt;/h2&gt;
&lt;p&gt;iptablesä¸»è¦æœ‰rawã€mangleã€filterã€natè¿™å‡ ä¸ªè¡¨ï¼Œå¯¹åº”å‡ ä¸ªè§„åˆ™ï¼šPREROUTING ã€INPUT ã€FORWARD ã€OUTPUTã€POSTROUTING ã€‚&lt;/p&gt;
&lt;p&gt;NAT åŒ…æ‹¬ SNAT ï¼ˆæºåœ°å€è½¬æ¢ï¼‰å’Œ DNAT ï¼ˆç›®çš„åœ°å€è½¬æ¢ï¼‰ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºåšåœ°å€è½¬æ¢æ˜¯åœ¨è·¯ç”±å‰è¿˜æ˜¯è·¯ç”±åï¼ŒSNATå’ŒDNATæ€»æ˜¯æˆå¯¹å‡ºç°çš„ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹åº”çš„å«ä¹‰å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;è¡¨å&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;ç”¨é€”&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;åŒ…å«çš„è§„åˆ™&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;è¡¨å&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;ç”¨é€”&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;åŒ…å«çš„è§„åˆ™&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;raw&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;å…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªæœºåˆ¶&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;PREROUTINGï¼ŒOUTPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;mangle&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æ‹†è§£æŠ¥æ–‡ï¼Œåšå‡ºä¿®æ”¹ï¼Œå¹¶é‡æ–°å°è£…çš„åŠŸèƒ½&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;PREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;nat&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;ç½‘ç»œåœ°å€è½¬æ¢åŠŸèƒ½&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;PREROUTINGï¼ŒOUTPUTï¼ŒPOSTROUTINGï¼ˆcentos7ä¸­è¿˜æœ‰INPUTï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;filter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;è´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œé˜²ç«å¢™&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;INPUTï¼ŒFORWARDï¼ŒOUTPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;è§„åˆ™çš„æ„ä¹‰ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;è§„åˆ™&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;æ„ä¹‰&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;PREROUTING&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æŠ¥æ–‡åˆšåˆšåˆ°è¾¾ä¸»æœºï¼Œè¿˜æ²¡ç»è¿‡è·¯ç”±&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;INPUT&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±ï¼Œåˆ¤æ–­æ˜¯å‘é€ç»™æœ¬æœºçš„æŠ¥æ–‡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;FORWARD&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±ï¼Œåˆ¤æ–­ä¸æ˜¯æœ¬æœºçš„æŠ¥æ–‡ï¼Œå¦‚æœå†…æ ¸å¼€å¯è½¬å‘åŠŸèƒ½åˆ™è½¬å‘å‡ºå»ï¼Œå¦åˆ™ä¸¢å¼ƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;OUTPUT&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æŠ¥æ–‡ä»åº”ç”¨å‘å‡ºæŠ¥æ–‡å·²ç»ç»è¿‡è·¯ç”±&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;POSTROUTING&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;æŠ¥æ–‡ä»åº”ç”¨å‘å‡ºå·²ç»ç»è¿‡è·¯ç”±ï¼Œå‡†å¤‡ä»ç½‘å¡å‘å‡º&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;æ•°æ®ä»ç½‘ç»œåˆ°è¾¾ä¸»æœºï¼Œå†ä»ä¸»æœºåˆ°è¾¾åº”ç”¨çš„è¿‡ç¨‹ï¼Œä»¥é›†ç¾¤ä¸­traefikéƒ¨ç½²çš„Ingressä¸ºä¾‹ï¼Œå¯ä»¥ç†è§£ä¸ºï¼š
&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/002T8chSgy1gr2r3bnr1bj60dd0b5my602.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;iptableç›¸å…³å‘½ä»¤&#34;&gt;iptableç›¸å…³å‘½ä»¤&lt;/h2&gt;
&lt;p&gt;æŸ¥çœ‹iptablesè§„åˆ™ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;iptables -L, --list &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;chain&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; åˆ—å‡ºé“¾ chain ä¸Šé¢çš„æ‰€æœ‰è§„åˆ™ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šé“¾ï¼Œåˆ—å‡ºè¡¨ä¸Šæ‰€æœ‰é“¾çš„æ‰€æœ‰è§„åˆ™
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å‚è€ƒ&lt;a href=&#34;https://wangchujiang.com/linux-command/c/iptables.html&#34;&gt;https://wangchujiang.com/linux-command/c/iptables.html&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>K8sä¹‹calicoç½‘ç»œæ’ä»¶ä¸œè¥¿å—åŒ—æµé‡</title>
      <link>http://hindung.cn/posts/25/</link>
      <pubDate>Tue, 01 Jun 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hindung.cn/posts/25/</guid>
      <description>å‰è¨€ ç¯å¢ƒé‡‡ç”¨äº†calicoï¼‹ebgp/ibgpï¼‹äº¤æ¢æœºç»„æˆäº†ä¸€ä¸ªæ‰å¹³åŒ–ç½‘ç»œï¼Œä½¿ç”¨calicoå®£å‘ŠPOD IPï¼Œåšåˆ°äº†PODä¸å…¶ä»–è™šæ‹Ÿæœºå’Œå¼€å‘ç½‘è½å¤„åœ¨åŒä¸€ä¸ªå¹³é¢çš„æ•ˆæœã€‚
å…·ä½“ç»„ç½‘ä¿¡æ¯å¯ä»¥å‚è€ƒcalicoç½‘ç«™ã€‚
ä¸œè¥¿æµé‡ Podåˆ°Serviceæµé‡ ä¸€èˆ¬çš„åº”ç”¨å¤§å¤šæ•°æ˜¯ä»¥Podåˆ°Serviceçš„å½¢å¼å»è¯·æ±‚æœåŠ¡ï¼Œä»è€Œå‡ºç°ä¸œè¥¿æ–¹å‘çš„æµé‡ï¼Œç›®å‰é›†ç¾¤çš„ç½‘ç»œé‡‡ç”¨Calicoä½œä¸ºç½‘ç»œæ’ä»¶ï¼ŒPODçš„IPç”±Calicoè¿›è¡Œç»Ÿä¸€åˆ†é…ï¼ŒService IPç”±é›†ç¾¤K8såˆ†é…ï¼Œå¹¶ä¸”é…åˆKube-proxyæ“ä½œIptableåˆ›å»ºå¯¹åº”çš„è§„åˆ™ã€‚
é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªPODæ—¶ï¼Œcalicoä¼šåŒæ—¶åœ¨PODå¯¹åº”çš„ä¸»æœºç”Ÿæˆå¯¹åº”çš„calicoç½‘æ¡¥calixxxï¼Œå¹¶ä¸”åˆ†é…IPï¼Œå¹¶ä¸”é€šè¿‡calicoç»„ä»¶è·¯ç”±å®£å‘Šå‡ºå»ï¼š
å‘é€åˆ°calixxxçš„æµé‡ä¼šè½¬å‘è‡³PODçš„eth0ç½‘å¡ï¼Œè€Œä»PODå‘å‡ºæ¥çš„æŠ¥æ–‡åˆ™æ˜¯é€šè¿‡ARP ä»£ç†çš„æ–¹å¼è½¬å‘è‡³calixxxç½‘æ¡¥ã€‚
è€Œå½“ä¸€ä¸ªServiceåˆ›å»ºä¹‹åï¼Œä¼šæ ¹æ®é€‰æ‹©å™¨ä¸PODæ ‡ç­¾é…å¯¹ï¼Œå¯¹åº”ä¸ŠPOD IPå¹¶ä¸”è¢«Kube-Proxyç›‘æ§åˆ°ï¼ŒK8sä¼šéšå³ç”Ÿæˆå¯¹åº”çš„DNSè®°å½•service.namespace.local.cluster:serviceclusterIPï¼Œç„¶ååœ¨Iptablesæ·»åŠ ç›¸åº”çš„è§„åˆ™è®°å½•ï¼Œå¦‚(10.88.145.173ä¸ºServiceIPï¼Œ10.90.1.127ä¸ºPOD IP)ï¼š
ä¸€èˆ¬çš„ï¼Œåœ¨é›†ç¾¤ä¸­ä»PODè®¿é—®Serviceï¼Œå†ä»Serviceåˆ°è¾¾å¯¹åº”çš„PODæµç¨‹ä¸ºï¼ˆæ­£å‘è¯·æ±‚ç”¨â‘ è¡¨ç¤ºï¼Œå›å¤æŠ¥æ–‡ç”¨(1)è¡¨ç¤ºï¼‰ï¼š
ä¸‹é¢æ¢³ç†ä¸€ä¸‹è¯·æ±‚çš„ä¸»è¦è¿‡ç¨‹ï¼š
 â‘ PODå‘domianå‘é€è¯·æ±‚ â‘¡ç”±äºæ²¡æœ‰IPï¼ŒPODå…ˆå‘CoreDNSæŸ¥è¯¢åŸŸåå¯¹åº”çš„IPåœ°å€ â‘¢CoreDNSè¿”å›å¯¹åº”çš„Service IP â‘£PODæ‹¿åˆ°IPä¹‹åï¼Œå‘è¯¥IPå‘é€æ•°æ®ï¼Œå¯¹åº”çš„æŠ¥æ–‡ä»calixxxç½‘æ¡¥å‡ºæ¥ â‘¤ä»calixxxç½‘æ¡¥å‡ºæ¥åï¼Œè¿›å…¥Host Iptablesé“¾ï¼Œè¿›å…¥IP tablesä¹‹åï¼Œè¿›å…¥å¯¹åº”çš„é“¾è·¯å¦‚ä¸Šå›¾è§„åˆ™ï¼Œæœ€åå¾—åˆ°Serviceå¯¹åº”çš„POD IPï¼Œå¹¶è½¬å‘åˆ°æ­¤IPï¼Œæ­¤æ—¶ä¼šç»è¿‡è·¯ç”±ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œç›®æ ‡IPåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼ˆè·¯ç”±è¡¨æœ‰è®°å½•ï¼‰æˆ–è€…ä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼ˆè·¯ç”±è¡¨æ— è®°å½•ï¼‰ â‘¥å¦‚æœåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œæ ¹æ®è·¯ç”±è¡¨åˆ™ä¼šè·¯ç”±åˆ°ç›®æ ‡IPå¯¹åº”çš„calixxxç½‘æ¡¥ â‘¦å¦‚æœä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™æ ¹æ®è·¯ç”±è¡¨è§„åˆ™ï¼Œä¼šä»bond1å£å‡ºå» â‘§åˆ°è¾¾äº¤æ¢æœºï¼Œäº¤æ¢æœºæœ‰å¯¹åº”çš„è·¯ç”±æ¡ç›®ï¼Œåˆ™ä¼šèµ°åˆ°ï¼ˆ3ï¼‰å’Œï¼ˆ4ï¼‰è¿‡ç¨‹è¿›å…¥Hostï¼Œå¹¶ä¸”èµ°åˆ°Iptablesï¼Œé€šè¿‡è·¯ç”±ï¼Œè½¬åˆ°â‘¥è¿‡ç¨‹ â‘¨åˆ°è¾¾calixxxç½‘æ¡¥ä¹‹åä¼šè½¬å‘è‡³POD eth0ç½‘å¡ï¼Œåˆ°è¾¾POD  åº”ç­”è¿‡ç¨‹ï¼š
 (1)PODä»¥ä¼ è¿‡æ¥çš„æºPOD IPä½œä¸ºç›®çš„IPä»eth0å‘å‡ºï¼Œé€šè¿‡ARPä»£ç†è½¬å‘åˆ°calixxxç½‘æ¡¥ (2)è¾¾åˆ°calixxxç½‘æ¡¥ä¹‹åä¼šç»è¿‡PODæ‰€åœ¨çš„èŠ‚ç‚¹çš„Hostè·¯ç”±è¡¨ï¼ŒåŒæ ·åˆ†ä¸ºä¸¤ç§æƒ…å†µ (3)å¦‚æœä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™ä¼šèµ°bond1åˆ°äº¤æ¢æœº (4)å†ä»äº¤æ¢æœºåˆ°è¾¾å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¹‹åä¾¿åˆ°è¾¾è¿‡ç¨‹ï¼ˆ5ï¼‰ (5)ç»è¿‡è·¯ç”±è¡¨ï¼Œåˆ°è¾¾ç›®çš„IP å¯¹åº”calixxxç½‘æ¡¥ (6)å†ä»ç½‘æ¡¥åˆ°è¾¾POD eth0  Podåˆ°Podæµé‡ ç”±äºç½‘ç»œå¹³é¢åŒ–ï¼ŒPOD IPå¯ä»¥ç›´é€šï¼Œæ‰€ä»¥ä¼šå­˜åœ¨PODç›¸äº’è®¿é—®çš„åœºæ™¯ï¼Œå¦‚éšç§å·åº”ç”¨ç­‰ï¼š
ä¸»è¦è¿‡ç¨‹ï¼š
 â‘ PODä»¥ç›®æ ‡PODçš„IPä½œä¸ºç›®çš„IPï¼Œä»eth0å‘å‡ºï¼Œåˆ°è¾¾calixxx â‘¡åˆ°è¾¾calixxxç½‘æ¡¥ä¹‹åä¼šè¿›å…¥Hostå†…æ ¸Iptablesé“¾åˆ°è¾¾PREROUTINGï¼ˆè·¯ç”±å‰ï¼‰ â‘¢ä¹‹åè¿›å…¥è·¯ç”±æ¨¡å—è¿›è¡Œè·¯ç”±ï¼Œè·¯ç”±åˆ¤æ–­è¯¥æŠ¥æ–‡æ˜¯å¦æ˜¯å‘ç»™æœ¬æœºçš„ï¼Œå¦‚æœæ˜¯åˆ™å¾€ä¸Šæ”¶å°†è¿›å…¥INPUTé“¾ï¼Œæ­¤è¿‡ç¨‹ä¸åœ¨è®¨è®ºèŒƒå›´ï¼Œç”±äºæŠ¥æ–‡ç›®çš„åœ°å€æ˜¯POD IPï¼Œæ‰€ä»¥ä¼šè½¬å‘å‡ºå» â‘£åˆ°è¾¾FORWARDé“¾åè¿›å…¥POSTROUTINGï¼ˆè·¯ç”±åï¼‰ â‘¤è¿›å…¥POSTROUTINGä¼šè¿›è¡Œä¸€äº›åœ°å€è½¬æ¢ç­‰æ“ä½œåå‘å¾€å¯¹åº”ç½‘å¡æˆ–è€…ç½‘æ¡¥ï¼Œå¦‚æœè·¯ç”±ç»“æœè¡¨æ˜è¯¥æŠ¥æ–‡è¦é€šè¿‡ç½‘å¡Bond1å‡ºå»åˆ™ä¼šèµ°åˆ°â‘§è¿‡ç¨‹ï¼Œå¦åˆ™ä¼šèµ°åˆ°â‘¥ â‘¥è¡¨æ˜ç›®çš„IPåœ¨æœ¬æœºç½‘æ¡¥ä¸Šï¼ˆå³PODåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è¿›å…¥ç›®çš„åœ°å€å¯¹åº”çš„calixxxç½‘æ¡¥ â‘¦å†è½¬å‘è‡³POD eth0ç½‘å¡åˆ°è¾¾ç›®çš„åœ° â‘§æŠ¥æ–‡ä»å†…æ ¸å‡ºæ¥è¿›å…¥ç½‘å¡ï¼Œå‡†å¤‡å‘å¤–å‘å‡º â‘¨åˆ°è¾¾äº¤æ¢æœºï¼Œç”±äºäº¤æ¢æœºæœ‰æ‰€æœ‰PODçš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥ä»–èƒ½æ­£ç¡®å¤„ç†ç»è¿‡çš„æŠ¥æ–‡ â‘©ç»è¿‡è·¯ç”±ååˆ°è¾¾PODæ‰€åœ¨èŠ‚ç‚¹çš„å…¥å£ç½‘å¡Bond1 11.åˆ°è¾¾ç½‘å¡ä¹‹åä¼šè¿›å…¥å†…æ ¸Linuxåè®®æ ˆè¿›è¡ŒIptablesè§„åˆ™é“¾åŒ¹é…ï¼ˆå¯èƒ½çš„è·¯å¾„ä¸ºåˆ°â‘¢-&amp;gt;â‘£-&amp;gt;â‘¤-&amp;gt;â‘¥-&amp;gt;â‘¦åˆ°è¾¾å¯¹åº”çš„PODï¼‰  å›å¤è¿‡ç¨‹ï¼š
 (1)åˆ°è¾¾ç›®çš„PODä¹‹åï¼Œåº”ç”¨æ ¹æ®æºIPè¿›è¡Œå›åº”ï¼Œè½¬å‘è‡³calixxxç½‘æ¡¥ (2)åˆ°è¾¾ç½‘æ¡¥ä¹‹åè¿›å…¥Linuxåè®®æ ˆï¼Œå…¶è¿‡ç¨‹ä¼šä»â‘¢-&amp;gt;â‘£-&amp;gt;â‘¤-&amp;gt;ï¼ˆ3ï¼‰åˆ°è¾¾æºPOD (3)åˆ°è¾¾æºPODå¯¹åº”çš„ç½‘æ¡¥ (4)ä»ç½‘æ¡¥è½¬å‘è‡³POD eth0ç½‘å¡ï¼Œæ­¤æ—¶ä¼šç»è¿‡Linuxåè®®æ ˆï¼Œæœ€ç»ˆæŠ¥æ–‡ä»å†…æ ¸åˆ°ç”¨æˆ·ç©ºé—´é€åˆ°åº”ç”¨ã€‚  å—åŒ—æµé‡ å¤–éƒ¨æµé‡ä»Ingress(è¶Šè¿‡service)åˆ°Pod clientå®¢æˆ·ç«¯è¯·æ±‚PODåº”ç”¨ï¼Œé¦–å…ˆè¦åˆ›å»ºå¯¹åº”çš„Serviceï¼Œå¹¶ä¸”åˆ›å»ºIngressè·¯ç”±ã€‚é›†ç¾¤ä¸­é‡‡ç”¨Traefikä½œä¸ºIngres Controllerï¼Œä»¥DeamonSetçš„æ–¹å¼éƒ¨ç½²ï¼Œå¹¶ä¸”å¼€å¯hostNetworkæ¨¡å¼ï¼Œä¸ä¸»æœºå…¬ç”¨ç½‘ç»œåè®®æ ˆã€‚å¹¶ä¸”æ¥ç®¡æ‰€æœ‰åˆ°è¾¾ä¸»æœºçš„80ç«¯å£ã€8080ç«¯å£çš„æŠ¥æ–‡ã€‚Traefikçš„åŸç†ä¸»è¦æ˜¯é€šè¿‡ç›‘æ§APIserveræ¥ç›‘æ§Serviceã€PODçš„å˜åŒ–ï¼Œå¹¶ç»´æŠ¤è·¯ç”±ï¼Œè€Œä¸”æ¥ç®¡80ç«¯å£çš„æµé‡ï¼Œè½¬å‘åˆ°å¯¹åº”è·¯ç”±çš„POD IPä¸Šã€‚</description>
      <content>&lt;h1 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h1&gt;
&lt;p&gt;ç¯å¢ƒé‡‡ç”¨äº†calicoï¼‹ebgp/ibgpï¼‹äº¤æ¢æœºç»„æˆäº†ä¸€ä¸ªæ‰å¹³åŒ–ç½‘ç»œï¼Œä½¿ç”¨calicoå®£å‘ŠPOD IPï¼Œåšåˆ°äº†PODä¸å…¶ä»–è™šæ‹Ÿæœºå’Œå¼€å‘ç½‘è½å¤„åœ¨åŒä¸€ä¸ªå¹³é¢çš„æ•ˆæœã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“ç»„ç½‘ä¿¡æ¯å¯ä»¥å‚è€ƒcalicoç½‘ç«™ã€‚&lt;/p&gt;
&lt;h1 id=&#34;ä¸œè¥¿æµé‡&#34;&gt;ä¸œè¥¿æµé‡&lt;/h1&gt;
&lt;h2 id=&#34;podåˆ°serviceæµé‡&#34;&gt;Podåˆ°Serviceæµé‡&lt;/h2&gt;
&lt;p&gt;ä¸€èˆ¬çš„åº”ç”¨å¤§å¤šæ•°æ˜¯ä»¥Podåˆ°Serviceçš„å½¢å¼å»è¯·æ±‚æœåŠ¡ï¼Œä»è€Œå‡ºç°ä¸œè¥¿æ–¹å‘çš„æµé‡ï¼Œç›®å‰é›†ç¾¤çš„ç½‘ç»œé‡‡ç”¨Calicoä½œä¸ºç½‘ç»œæ’ä»¶ï¼ŒPODçš„IPç”±Calicoè¿›è¡Œç»Ÿä¸€åˆ†é…ï¼ŒService IPç”±é›†ç¾¤K8såˆ†é…ï¼Œå¹¶ä¸”é…åˆKube-proxyæ“ä½œIptableåˆ›å»ºå¯¹åº”çš„è§„åˆ™ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªPODæ—¶ï¼Œcalicoä¼šåŒæ—¶åœ¨PODå¯¹åº”çš„ä¸»æœºç”Ÿæˆå¯¹åº”çš„calicoç½‘æ¡¥calixxxï¼Œå¹¶ä¸”åˆ†é…IPï¼Œå¹¶ä¸”é€šè¿‡calicoç»„ä»¶è·¯ç”±å®£å‘Šå‡ºå»ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/image2020-6-3_19-46-50.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/image2020-6-3_19-46-5.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‘é€åˆ°calixxxçš„æµé‡ä¼šè½¬å‘è‡³PODçš„eth0ç½‘å¡ï¼Œè€Œä»PODå‘å‡ºæ¥çš„æŠ¥æ–‡åˆ™æ˜¯é€šè¿‡ARP ä»£ç†çš„æ–¹å¼è½¬å‘è‡³calixxxç½‘æ¡¥ã€‚&lt;/p&gt;
&lt;p&gt;è€Œå½“ä¸€ä¸ªServiceåˆ›å»ºä¹‹åï¼Œä¼šæ ¹æ®é€‰æ‹©å™¨ä¸PODæ ‡ç­¾é…å¯¹ï¼Œå¯¹åº”ä¸ŠPOD IPå¹¶ä¸”è¢«Kube-Proxyç›‘æ§åˆ°ï¼ŒK8sä¼šéšå³ç”Ÿæˆå¯¹åº”çš„DNSè®°å½•service.namespace.local.cluster:serviceclusterIPï¼Œç„¶ååœ¨Iptablesæ·»åŠ ç›¸åº”çš„è§„åˆ™è®°å½•ï¼Œå¦‚(10.88.145.173ä¸ºServiceIPï¼Œ10.90.1.127ä¸ºPOD IP)ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/image2020-6-3_19-55-42.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸€èˆ¬çš„ï¼Œåœ¨é›†ç¾¤ä¸­ä»PODè®¿é—®Serviceï¼Œå†ä»Serviceåˆ°è¾¾å¯¹åº”çš„PODæµç¨‹ä¸ºï¼ˆæ­£å‘è¯·æ±‚ç”¨â‘ è¡¨ç¤ºï¼Œå›å¤æŠ¥æ–‡ç”¨(1)è¡¨ç¤ºï¼‰ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/%E4%B8%9C%E8%A5%BF-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F-%E7%AC%AC%203%20%E9%A1%B5.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æ¢³ç†ä¸€ä¸‹è¯·æ±‚çš„ä¸»è¦è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â‘ PODå‘domianå‘é€è¯·æ±‚&lt;/li&gt;
&lt;li&gt;â‘¡ç”±äºæ²¡æœ‰IPï¼ŒPODå…ˆå‘CoreDNSæŸ¥è¯¢åŸŸåå¯¹åº”çš„IPåœ°å€&lt;/li&gt;
&lt;li&gt;â‘¢CoreDNSè¿”å›å¯¹åº”çš„Service IP&lt;/li&gt;
&lt;li&gt;â‘£PODæ‹¿åˆ°IPä¹‹åï¼Œå‘è¯¥IPå‘é€æ•°æ®ï¼Œå¯¹åº”çš„æŠ¥æ–‡ä»calixxxç½‘æ¡¥å‡ºæ¥&lt;/li&gt;
&lt;li&gt;â‘¤ä»calixxxç½‘æ¡¥å‡ºæ¥åï¼Œè¿›å…¥Host Iptablesé“¾ï¼Œè¿›å…¥IP tablesä¹‹åï¼Œè¿›å…¥å¯¹åº”çš„é“¾è·¯å¦‚ä¸Šå›¾è§„åˆ™ï¼Œæœ€åå¾—åˆ°Serviceå¯¹åº”çš„POD IPï¼Œå¹¶è½¬å‘åˆ°æ­¤IPï¼Œæ­¤æ—¶ä¼šç»è¿‡è·¯ç”±ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œç›®æ ‡IPåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼ˆè·¯ç”±è¡¨æœ‰è®°å½•ï¼‰æˆ–è€…ä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼ˆè·¯ç”±è¡¨æ— è®°å½•ï¼‰&lt;/li&gt;
&lt;li&gt;â‘¥å¦‚æœåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œæ ¹æ®è·¯ç”±è¡¨åˆ™ä¼šè·¯ç”±åˆ°ç›®æ ‡IPå¯¹åº”çš„calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;â‘¦å¦‚æœä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™æ ¹æ®è·¯ç”±è¡¨è§„åˆ™ï¼Œä¼šä»bond1å£å‡ºå»&lt;/li&gt;
&lt;li&gt;â‘§åˆ°è¾¾äº¤æ¢æœºï¼Œäº¤æ¢æœºæœ‰å¯¹åº”çš„è·¯ç”±æ¡ç›®ï¼Œåˆ™ä¼šèµ°åˆ°ï¼ˆ3ï¼‰å’Œï¼ˆ4ï¼‰è¿‡ç¨‹è¿›å…¥Hostï¼Œå¹¶ä¸”èµ°åˆ°Iptablesï¼Œé€šè¿‡è·¯ç”±ï¼Œè½¬åˆ°â‘¥è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;â‘¨åˆ°è¾¾calixxxç½‘æ¡¥ä¹‹åä¼šè½¬å‘è‡³POD eth0ç½‘å¡ï¼Œåˆ°è¾¾POD&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åº”ç­”è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)PODä»¥ä¼ è¿‡æ¥çš„æºPOD IPä½œä¸ºç›®çš„IPä»eth0å‘å‡ºï¼Œé€šè¿‡ARPä»£ç†è½¬å‘åˆ°calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(2)è¾¾åˆ°calixxxç½‘æ¡¥ä¹‹åä¼šç»è¿‡PODæ‰€åœ¨çš„èŠ‚ç‚¹çš„Hostè·¯ç”±è¡¨ï¼ŒåŒæ ·åˆ†ä¸ºä¸¤ç§æƒ…å†µ&lt;/li&gt;
&lt;li&gt;(3)å¦‚æœä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™ä¼šèµ°bond1åˆ°äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;(4)å†ä»äº¤æ¢æœºåˆ°è¾¾å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¹‹åä¾¿åˆ°è¾¾è¿‡ç¨‹ï¼ˆ5ï¼‰&lt;/li&gt;
&lt;li&gt;(5)ç»è¿‡è·¯ç”±è¡¨ï¼Œåˆ°è¾¾ç›®çš„IP å¯¹åº”calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(6)å†ä»ç½‘æ¡¥åˆ°è¾¾POD eth0&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;podåˆ°podæµé‡&#34;&gt;Podåˆ°Podæµé‡&lt;/h2&gt;
&lt;p&gt;ç”±äºç½‘ç»œå¹³é¢åŒ–ï¼ŒPOD IPå¯ä»¥ç›´é€šï¼Œæ‰€ä»¥ä¼šå­˜åœ¨PODç›¸äº’è®¿é—®çš„åœºæ™¯ï¼Œå¦‚éšç§å·åº”ç”¨ç­‰ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/%E4%B8%9C%E8%A5%BF-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F-%E7%AC%AC%206%20%E9%A1%B5.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸»è¦è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â‘ PODä»¥ç›®æ ‡PODçš„IPä½œä¸ºç›®çš„IPï¼Œä»eth0å‘å‡ºï¼Œåˆ°è¾¾calixxx&lt;/li&gt;
&lt;li&gt;â‘¡åˆ°è¾¾calixxxç½‘æ¡¥ä¹‹åä¼šè¿›å…¥Hostå†…æ ¸Iptablesé“¾åˆ°è¾¾PREROUTINGï¼ˆè·¯ç”±å‰ï¼‰&lt;/li&gt;
&lt;li&gt;â‘¢ä¹‹åè¿›å…¥è·¯ç”±æ¨¡å—è¿›è¡Œè·¯ç”±ï¼Œè·¯ç”±åˆ¤æ–­è¯¥æŠ¥æ–‡æ˜¯å¦æ˜¯å‘ç»™æœ¬æœºçš„ï¼Œå¦‚æœæ˜¯åˆ™å¾€ä¸Šæ”¶å°†è¿›å…¥INPUTé“¾ï¼Œæ­¤è¿‡ç¨‹ä¸åœ¨è®¨è®ºèŒƒå›´ï¼Œç”±äºæŠ¥æ–‡ç›®çš„åœ°å€æ˜¯POD IPï¼Œæ‰€ä»¥ä¼šè½¬å‘å‡ºå»&lt;/li&gt;
&lt;li&gt;â‘£åˆ°è¾¾FORWARDé“¾åè¿›å…¥POSTROUTINGï¼ˆè·¯ç”±åï¼‰&lt;/li&gt;
&lt;li&gt;â‘¤è¿›å…¥POSTROUTINGä¼šè¿›è¡Œä¸€äº›åœ°å€è½¬æ¢ç­‰æ“ä½œåå‘å¾€å¯¹åº”ç½‘å¡æˆ–è€…ç½‘æ¡¥ï¼Œå¦‚æœè·¯ç”±ç»“æœè¡¨æ˜è¯¥æŠ¥æ–‡è¦é€šè¿‡ç½‘å¡Bond1å‡ºå»åˆ™ä¼šèµ°åˆ°â‘§è¿‡ç¨‹ï¼Œå¦åˆ™ä¼šèµ°åˆ°â‘¥&lt;/li&gt;
&lt;li&gt;â‘¥è¡¨æ˜ç›®çš„IPåœ¨æœ¬æœºç½‘æ¡¥ä¸Šï¼ˆå³PODåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è¿›å…¥ç›®çš„åœ°å€å¯¹åº”çš„calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;â‘¦å†è½¬å‘è‡³POD eth0ç½‘å¡åˆ°è¾¾ç›®çš„åœ°&lt;/li&gt;
&lt;li&gt;â‘§æŠ¥æ–‡ä»å†…æ ¸å‡ºæ¥è¿›å…¥ç½‘å¡ï¼Œå‡†å¤‡å‘å¤–å‘å‡º&lt;/li&gt;
&lt;li&gt;â‘¨åˆ°è¾¾äº¤æ¢æœºï¼Œç”±äºäº¤æ¢æœºæœ‰æ‰€æœ‰PODçš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥ä»–èƒ½æ­£ç¡®å¤„ç†ç»è¿‡çš„æŠ¥æ–‡&lt;/li&gt;
&lt;li&gt;â‘©ç»è¿‡è·¯ç”±ååˆ°è¾¾PODæ‰€åœ¨èŠ‚ç‚¹çš„å…¥å£ç½‘å¡Bond1&lt;/li&gt;
&lt;li&gt;11.åˆ°è¾¾ç½‘å¡ä¹‹åä¼šè¿›å…¥å†…æ ¸Linuxåè®®æ ˆè¿›è¡ŒIptablesè§„åˆ™é“¾åŒ¹é…ï¼ˆå¯èƒ½çš„è·¯å¾„ä¸ºåˆ°â‘¢-&amp;gt;â‘£-&amp;gt;â‘¤-&amp;gt;â‘¥-&amp;gt;â‘¦åˆ°è¾¾å¯¹åº”çš„PODï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å›å¤è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)åˆ°è¾¾ç›®çš„PODä¹‹åï¼Œåº”ç”¨æ ¹æ®æºIPè¿›è¡Œå›åº”ï¼Œè½¬å‘è‡³calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(2)åˆ°è¾¾ç½‘æ¡¥ä¹‹åè¿›å…¥Linuxåè®®æ ˆï¼Œå…¶è¿‡ç¨‹ä¼šä»â‘¢-&amp;gt;â‘£-&amp;gt;â‘¤-&amp;gt;ï¼ˆ3ï¼‰åˆ°è¾¾æºPOD&lt;/li&gt;
&lt;li&gt;(3)åˆ°è¾¾æºPODå¯¹åº”çš„ç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(4)ä»ç½‘æ¡¥è½¬å‘è‡³POD eth0ç½‘å¡ï¼Œæ­¤æ—¶ä¼šç»è¿‡Linuxåè®®æ ˆï¼Œæœ€ç»ˆæŠ¥æ–‡ä»å†…æ ¸åˆ°ç”¨æˆ·ç©ºé—´é€åˆ°åº”ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;å—åŒ—æµé‡&#34;&gt;å—åŒ—æµé‡&lt;/h1&gt;
&lt;h2 id=&#34;å¤–éƒ¨æµé‡ä»ingressè¶Šè¿‡serviceåˆ°pod&#34;&gt;å¤–éƒ¨æµé‡ä»Ingress(è¶Šè¿‡service)åˆ°Pod&lt;/h2&gt;
&lt;p&gt;clientå®¢æˆ·ç«¯è¯·æ±‚PODåº”ç”¨ï¼Œé¦–å…ˆè¦åˆ›å»ºå¯¹åº”çš„Serviceï¼Œå¹¶ä¸”åˆ›å»ºIngressè·¯ç”±ã€‚é›†ç¾¤ä¸­é‡‡ç”¨Traefikä½œä¸ºIngres Controllerï¼Œä»¥DeamonSetçš„æ–¹å¼éƒ¨ç½²ï¼Œå¹¶ä¸”å¼€å¯hostNetworkæ¨¡å¼ï¼Œä¸ä¸»æœºå…¬ç”¨ç½‘ç»œåè®®æ ˆã€‚å¹¶ä¸”æ¥ç®¡æ‰€æœ‰åˆ°è¾¾ä¸»æœºçš„80ç«¯å£ã€8080ç«¯å£çš„æŠ¥æ–‡ã€‚Traefikçš„åŸç†ä¸»è¦æ˜¯é€šè¿‡ç›‘æ§APIserveræ¥ç›‘æ§Serviceã€PODçš„å˜åŒ–ï¼Œå¹¶ç»´æŠ¤è·¯ç”±ï¼Œè€Œä¸”æ¥ç®¡80ç«¯å£çš„æµé‡ï¼Œè½¬å‘åˆ°å¯¹åº”è·¯ç”±çš„POD IPä¸Šã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“è¿‡ç¨‹ä¸ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/%E4%B8%9C%E8%A5%BF-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F-%E7%AC%AC%204%20%E9%A1%B5%20.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç®€å•è§£é‡Šä¸€ä¸‹è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â‘ ï¼ˆå®¢æˆ·ç«¯é¦–å…ˆå‘DNSæœåŠ¡å™¨è·å–åŸŸåå¯¹åº”çš„IPï¼‰å‘ç›®æ ‡IPå‘é€è¯·æ±‚ï¼Œåˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;â‘¡ç»è¿‡è·¯ç”±ä¹‹åå®šå‘åˆ°ç›®æ ‡IPæ‰€åœ¨çš„ä¸»æœºï¼Œç”±äºè®¾ç½®äº†HA-proxyï¼Œè¯·æ±‚ä¼šå…ˆåˆ°VIPå¯¹åº”çš„ç½‘å¡bond1:1&lt;/li&gt;
&lt;li&gt;â‘¢ä»å¤–è”å£è¿›æ¥ä¹‹åè¿›å…¥å†…æ ¸ç¨‹åºå¤„ç†&lt;/li&gt;
&lt;li&gt;â‘£åˆ°è¾¾è·¯ç”±æ¨¡å—ï¼Œåˆ¤æ–­æŠ¥æ–‡æ˜¯å‘é€ç»™æœ¬æœºçš„ï¼Œåˆ™å¾€ä¸Šæ”¶&lt;/li&gt;
&lt;li&gt;â‘¤åˆ°è¾¾INPUTé“¾ï¼Œä¹‹åä¼šæ ¹æ®ç«¯å£å·ï¼Œå‘è‡³å¯¹åº”çš„åº”ç”¨ç¨‹åºï¼Œç”±äºæ˜¯HA-proxyæä¾›çš„ä»£ç†ï¼Œä»è€Œè¿›å…¥HAç¨‹åºï¼Œç¨‹åºä»£ç†åˆ°Hots3 IPä¸Šï¼Œæ‰€ä»¥ä»POSTROUTINGå‡ºæ¥ä¹‹åä¼šåˆ°è¾¾(15)è¿‡ç¨‹ï¼Œåœ¨åˆ°è¾¾â‘¤ï¼Œå¾€ä¸Šåˆ°è¾¾Traefikç¨‹åº&lt;/li&gt;
&lt;li&gt;â‘¥Traefikæ¥ç®¡80ç«¯å£çš„æµé‡ï¼Œè¿›è¡Œè·¯ç”±åŒ¹é…ä¹‹åï¼ˆæ‹¿åˆ°è¯·æ±‚å¯¹åº”çš„POD IPï¼‰ï¼Œä»£ç†è‡³POD IP&lt;/li&gt;
&lt;li&gt;â‘¦è¿›å…¥è·¯ç”±&lt;/li&gt;
&lt;li&gt;â‘§è¿›å…¥OUTPUTé“¾&lt;/li&gt;
&lt;li&gt;â‘¨è¿›å…¥POSTROUTINGï¼Œé€šè¿‡è·¯ç”±ä¹‹åï¼Œå¦‚æœç›®çš„IPåœ°å€ä½äºåŒä¸€èŠ‚ç‚¹ï¼Œåˆ™ä¼šè·¯ç”±åˆ°calixxxç½‘æ¡¥ï¼Œå¦åˆ™ä¼šèµ°åˆ°(12)è¿‡ç¨‹ï¼Œåˆ°è¾¾äº¤æ¢æœºè·¯ç”±ä¹‹åè¾¾åˆ°å¯¹åº”ä¸»æœºä¸Š(12-&amp;gt;13-&amp;gt;14-&amp;gt;15-&amp;gt;â‘£-&amp;gt;FORWARD-&amp;gt;â‘¨-&amp;gt;â‘©)&lt;/li&gt;
&lt;li&gt;â‘©åˆ°è¾¾calixxxç½‘æ¡¥ï¼Œç„¶ååˆ°è¾¾POD eth0ç½‘å¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å›å¤è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)åˆ°è¾¾calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(2)è¿›å…¥ä¸»æœºç½‘ç»œæ ˆï¼Œè¿”å›Traefikä»£ç†ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/image2020-6-5_12-31-50.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¹‹åä»Traefikå³ä¸»æœºç½‘ç»œæ ˆå‡ºæ¥åˆ°è¾¾å¤–è”å£&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(3)ä»å¤–è”å£å‡ºæ¥ï¼ˆSNATï¼‰ï¼Œåˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;(4)åˆ°è¾¾å®¢æˆ·ç«¯ï¼ˆDNATï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å¤–éƒ¨æµé‡ç›´æ¥åˆ°pod&#34;&gt;å¤–éƒ¨æµé‡ç›´æ¥åˆ°Pod&lt;/h2&gt;
&lt;p&gt;ç”±äºPOD IPç›´æ¥é€šè¿‡calico BGPè·¯ç”±å®£å‘Šå‡ºå»ï¼Œå› æ­¤PODç½‘æ®µä¸è™šæœºã€æœ¬åœ°ç”µè„‘å¤„åœ¨åŒä¸€å¹³é¢ï¼Œè¯·æ±‚POD IPä¸è¯·æ±‚è™šæ‹Ÿæœºæƒ…å†µä¸€è‡´ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/%E4%B8%9C%E8%A5%BF-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F-%E7%AC%AC%205%20%E9%A1%B5.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“æµç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â‘ å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;â‘¡äº¤æ¢æœºè·¯ç”±åˆ°ç›®çš„åœ°å€å¯¹åº”çš„ä¸»æœºä¸Š&lt;/li&gt;
&lt;li&gt;â‘¢è¿›å…¥ä¸»æœºç½‘ç»œæ ˆè¿›è¡Œè·¯ç”±ï¼ˆç®€ç”»ï¼‰&lt;/li&gt;
&lt;li&gt;â‘£å¯èƒ½ä¼šç»è¿‡æ­¤è¿‡ç¨‹ï¼ˆå°±æ˜¯ç›®æ ‡PODä¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼‰&lt;/li&gt;
&lt;li&gt;â‘¤é‡æ–°åˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;â‘¥å†æ¬¡è·¯ç”±åˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;â‘¦è¿›å…¥ä¸»æœºç½‘ç»œæ ˆ&lt;/li&gt;
&lt;li&gt;â‘§è·¯ç”±åˆ°calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;â‘¨åˆ°è¾¾POD eth0ç½‘å¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å›å¤è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)å‘é€è‡³calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;(2)è¿›å…¥åˆ°ä¸»æœºç½‘ç»œæ ˆï¼Œè¿›è¡Œè·¯ç”±&lt;/li&gt;
&lt;li&gt;(3)å‘é€è‡³å¤–è”å£bond1&lt;/li&gt;
&lt;li&gt;(4)åˆ°è¾¾äº¤æ¢æœºï¼Œè·¯ç”±&lt;/li&gt;
&lt;li&gt;(5)åˆ°è¾¾å®¢æˆ·ç«¯ï¼ˆå¯èƒ½ä¼šç»è¿‡NATï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å¤–éƒ¨æµé‡ç›´æ¥è®¿é—®serviceipç‰¹æ€§&#34;&gt;å¤–éƒ¨æµé‡ç›´æ¥è®¿é—®ServiceIPï¼ˆç‰¹æ€§ï¼‰&lt;/h2&gt;
&lt;p&gt;å°†Service IPé€šè¿‡calico BGPåè®®è·¯ç”±å®£å‘Šå‡ºå»ï¼Œä»è€Œå®ç°äº†Service IPå¯ä»¥ç›´é€šçš„åœºæ™¯ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/%E4%B8%9C%E8%A5%BF-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F-%E7%AC%AC%207%20%E9%A1%B5.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“æµç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â‘ è¢«è·¯ç”±å®£å‘Šçš„ServiceIPä¼šå‡ºç°åœ¨äº¤æ¢æœºè·¯ç”±è¡¨æ¡ç›®ä¸Šï¼Œè¯·æ±‚åˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;â‘¡äº¤æ¢æœºè¿›è¡Œè·¯ç”±ï¼Œåˆ°è¾¾ç›®çš„IPæ‰€åœ¨çš„å¯¹åº”èŠ‚ç‚¹ï¼ˆè¿›ç¾¤å†…ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;â‘¢ä»ç½‘å¡æ¥æ”¶æŠ¥æ–‡ï¼Œç»è¿‡ç½‘ç»œæ ˆè·¯ç”±åˆ°è¾¾calixxxç½‘æ¡¥ï¼ˆä¸è®¿é—®serviceè¿‡ç¨‹ä¸€è‡³ï¼‰&lt;/li&gt;
&lt;li&gt;â‘£è¿›å…¥calixxxç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;â‘¤è¿›å…¥eth0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å›å¤è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)ä»åº”ç”¨å‘å‡ºåˆ°è¾¾calixxx&lt;/li&gt;
&lt;li&gt;(2)åˆ°è¾¾ä¸»æœºç½‘ç»œæ ˆ&lt;/li&gt;
&lt;li&gt;(3)åˆ°è¾¾å¤–è”å£ç½‘å¡&lt;/li&gt;
&lt;li&gt;(4)åˆ°è¾¾äº¤æ¢æœº&lt;/li&gt;
&lt;li&gt;(5)åˆ°è¾¾å®¢æˆ·ç«¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h1&gt;
&lt;p&gt;é›†ç¾¤ç›®å‰é‡‡ç”¨Iptableséƒ¨ç½²æ–¹å¼ï¼Œä¾èµ–Iptablesè§„åˆ™ã€‚å¦‚æœé›†ç¾¤Serviceè¿‡å¤šä¼šå¯¼è‡´ç»å¸¸å¯¹Iptablesé¢‘ç¹æ“ä½œï¼Œå¹¶ä¸”å¦‚æœè¡¨å˜å¾—å¾ˆå¤§ï¼Œæ›´æ–°è¡¨å°±ä¼šå˜å¾—å›°éš¾ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤Iptablesè¿™å—å°†æ¥å¯èƒ½ä¼šé‡åˆ°ç“¶é¢ˆã€‚&lt;/p&gt;
&lt;p&gt;calicoç½‘æ¡¥ä¸å®¹å™¨ç½‘æ¡¥è¿™æ®µæ˜ å°„çš„å…·ä½“å®ç°æ˜¯æ€æ ·ï¼ŒåŒ…æ‹¬æ€§èƒ½å¦‚ä½•ç­‰è¿˜æ²¡æœ‰æ·±å…¥äº†è§£ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.projectcalico.org/reference/architecture/design/l2-interconnect-fabric&#34;&gt;l2-interconnect-fabric&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://qiankunli.github.io/2018/02/04/calico.html&#34;&gt;calicoå­¦ä¹ &lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/04/11/calico-usage.html#calico&#34;&gt;Calicoç½‘ç»œçš„åŸç†ã€ç»„ç½‘æ–¹å¼ä¸ä½¿ç”¨&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>Kubectlå‘½ä»¤è¡Œ</title>
      <link>http://hindung.cn/posts/24/</link>
      <pubDate>Tue, 01 Jun 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hindung.cn/posts/24/</guid>
      <description>æ³¨ï¼šåŸºäºKubenetes ç‰ˆæœ¬ï¼šServer v1.17.2ã€Client v1.17.9
kubectlå‘½ä»¤è¡Œå…¨æ™¯å›¾ kubectlğŸ”—
æœ‰è¶£çš„kubectlå‘½ä»¤ è·å–æ­£åœ¨Runningçš„Pod kubectl get pods -A --field-selector=status.phase==Running NAMESPACE NAME READY STATUS RESTARTS AGE kelu cka2-75dbf7c54-gm4r4 1/1 Running 0 23h kube-system calico-kube-controllers-ccf66db4-cpvqp 1/1 Running 0 3d20h kube-system calico-node-8d4th 1/1 Running 0 3d2h kube-system calico-node-szmzb 1/1 Running 0 3d20h æŸ¥çœ‹èŠ‚ç‚¹å†…å­˜å®¹é‡ kubectl get no -o json | jq -r &amp;#39;.items | sort_by(.status.capacity.memory)[]|[.metadata.name,.status.capacity.memory]| @tsv&amp;#39; rq-bjptest01 3848040Ki rqinterntest2 7986060Ki æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„Podæ•°é‡ kubectl get po -o json --all-namespaces | jq &amp;#39;.items | group_by(.</description>
      <content>&lt;p&gt;&lt;em&gt;æ³¨ï¼šåŸºäºKubenetes ç‰ˆæœ¬ï¼šServer v1.17.2ã€Client v1.17.9&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;kubectlå‘½ä»¤è¡Œå…¨æ™¯å›¾&#34;&gt;kubectlå‘½ä»¤è¡Œå…¨æ™¯å›¾&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://hindung.oss-cn-beijing.aliyuncs.com/img/kubectl.png&#34;&gt;kubectlğŸ”—&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;æœ‰è¶£çš„kubectlå‘½ä»¤&#34;&gt;æœ‰è¶£çš„kubectlå‘½ä»¤&lt;/h2&gt;
&lt;h3 id=&#34;è·å–æ­£åœ¨runningçš„pod&#34;&gt;è·å–æ­£åœ¨Runningçš„Pod&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods -A --field-selector&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;status.phase&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;Running
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kelu          cka2-75dbf7c54-gm4r4                     1/1     Running   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;          23h
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system   calico-kube-controllers-ccf66db4-cpvqp   1/1     Running   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;          3d20h
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system   calico-node-8d4th                        1/1     Running   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;          3d2h
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system   calico-node-szmzb                        1/1     Running   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;          3d20h
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŸ¥çœ‹èŠ‚ç‚¹å†…å­˜å®¹é‡&#34;&gt;æŸ¥çœ‹èŠ‚ç‚¹å†…å­˜å®¹é‡&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get no -o json |    jq -r &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.items | sort_by(.status.capacity.memory)[]|[.metadata.name,.status.capacity.memory]| @tsv&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rq-bjptest01    3848040Ki
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rqinterntest2   7986060Ki
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„podæ•°é‡&#34;&gt;æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„Podæ•°é‡&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get po -o json --all-namespaces |  jq &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.items | group_by(.spec.nodeName) | map({&amp;#34;nodeName&amp;#34;: .[0].spec.nodeName, &amp;#34;count&amp;#34;: length}) | sort_by(.count)&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nodeName&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;rq-bjptest01&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;count&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nodeName&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;rqinterntest2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;count&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods --all-namespaces -o json | jq &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.items[] | .spec.nodeName&amp;#39;&lt;/span&gt; -r | sort | uniq -c
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;17&lt;/span&gt; rqkubedev03
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt; rqkubedev04
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;23&lt;/span&gt; rqkubedev05
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŸ¥çœ‹podä»¥åŠé•œåƒ&#34;&gt;æŸ¥çœ‹PODä»¥åŠé•œåƒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods -o custom-columns&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;NAME:metadata.name,IMAGES:spec.containers[*].image&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;NAME                              IMAGES
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;details-v1-5974b67c8-gqz94        docker.io/istio/examples-bookinfo-details-v1:1.16.2,docker.io/istio/proxyv2:1.7.2
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;gitea-5bb577b964-w64gg            harbor.caih.local/gitea/gitea:1.10.1
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;productpage-v1-64794f5db4-hw2fl   docker.io/istio/examples-bookinfo-productpage-v1:1.16.2,docker.io/istio/proxyv2:1.7.2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„pod&#34;&gt;æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„POD&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods --all-namespaces -o json | jq &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.items | map({podName: .metadata.name, nodeName: .spec.nodeName}) | group_by(.nodeName) | map({nodeName: .[0].nodeName, pods: map(.podName)})&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nodeName&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;rqkubedev03&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pods&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;123-84654b5d8f-sm2dt&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;reviews-v2-6cb6ccd848-ndsqq&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;fleet-agent-6cc4bd5c67-b877w&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jaeger-es-index-cleaner-1602806100-5ngzz&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jaeger-es-index-cleaner-1602806100-b47gk&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jaeger-es-index-cleaner-1602806100-kkx2z&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jaeger-es-index-cleaner-1602806100-rg6z8&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jaeger-es-index-cleaner-1602806100-s47n4&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŸ¥çœ‹podå ç”¨çš„å†…å­˜å’Œcpuå¹¶æŒ‰å†…å­˜æˆ–è€…cpuæ’åº&#34;&gt;æŸ¥çœ‹Podå ç”¨çš„å†…å­˜å’ŒCPUå¹¶æŒ‰å†…å­˜æˆ–è€…CPUæ’åº&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# å†…å­˜&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl top pods -A | sort --reverse --key &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt; --numeric
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud              jenkinsm-6fc5d7fc46-2tl6q                            29m          1995Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;istio-system           prometheus-788c945c9c-mdrjf                          97m          1424Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-apiserver-rqkubedev04                           149m         957Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-apiserver-rqkubedev03                           69m          476Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud              jenkinsslaveswarm-6c6f5d8d9b-8ns5w                   2m           464Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# CPU&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl top pods -A | sort --reverse --key &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; --numeric
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-apiserver-rqkubedev04                           150m         964Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;istio-system           prometheus-788c945c9c-mdrjf                          89m          1426Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-apiserver-rqkubedev03                           42m          532Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            calico-node-6n65m                                    42m          46Mi
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            calico-node-fg6tk                                    34m          49Mi
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å–é‡å¯æ¬¡æ•°é™åºæ’åºçš„pod&#34;&gt;è·å–é‡å¯æ¬¡æ•°é™åºæ’åºçš„Pod&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods -A --sort-by&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;.status.containerStatuses&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;.restartCount | tac
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-scheduler-rqkubedev03                           0/1     CrashLoopBackOff   &lt;span style=&#34;color:#ae81ff&#34;&gt;593&lt;/span&gt;        2d2h
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;traefik-v2             traefik-gfnw5                                        1/1     Running            &lt;span style=&#34;color:#ae81ff&#34;&gt;27&lt;/span&gt;         23d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-controller-manager-rqkubedev03                  1/1     Running            &lt;span style=&#34;color:#ae81ff&#34;&gt;24&lt;/span&gt;         23d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-controller-manager-rqkubedev04                  1/1     Running            &lt;span style=&#34;color:#ae81ff&#34;&gt;22&lt;/span&gt;         23d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kube-system            kube-apiserver-rqkubedev03                           1/1     Running            &lt;span style=&#34;color:#ae81ff&#34;&gt;21&lt;/span&gt;         23d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;NAMESPACE              NAME                                                 READY   STATUS             RESTARTS   AGE
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å¾—æ‰€æœ‰podçš„requestå’Œlimits&#34;&gt;è·å¾—æ‰€æœ‰PODçš„requestå’Œlimits&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get pods -A  -o custom-columns&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;NAME:metadata.name,MEM_REQUEST:spec.containers[*].resources.requests.memory,MEM_LIMIT:spec.containers[*].resources.limits.memory,CPU_REQUEST:spec.containers[*].resources.requests.cpu,CPU_LIMIT:spec.containers[*].resources.limits.cpu&amp;#39;&lt;/span&gt;       
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;NAME                                                 MEM_REQUEST   MEM_LIMIT     CPU_REQUEST   CPU_LIMIT
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;123-84654b5d8f-sm2dt                                 &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;backend-c56f64647-grql6                              10Mi          1Gi           10m           &amp;lt;none&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud-67ffdf9fc9-wzmts                           10Mi          1Gi           10m           &amp;lt;none&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud-ui-9fbb954dc-trtn7                         10Mi          1Gi           10m           &amp;lt;none&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloudm-caihcloudm-api-5cfffcc96-mz6pt            10Mi          1Gi           10m           200m
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloudm-caihcloudm-api-5cfffcc96-xdwsb            10Mi          1Gi           10m           200m
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å–èŠ‚ç‚¹çš„ip&#34;&gt;è·å–èŠ‚ç‚¹çš„IP&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get nodes -o jsonpath&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{range .items[*]}{.metadata.name} {.status.addresses[?(@.type==&amp;#34;InternalIP&amp;#34;)].address}{&amp;#34;\n&amp;#34;}{end}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rqkubedev03 10.19.0.57
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rqkubedev04 10.19.0.58
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rqkubedev05 10.19.0.59
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å–serviceçš„nodeportä¿¡æ¯&#34;&gt;è·å–Serviceçš„Nodeportä¿¡æ¯&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get -A svc -o json | jq -r &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.items[] | [.metadata.name,([.spec.ports[].nodePort | tostring ] | join(&amp;#34;|&amp;#34;))]| @tsv&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;backend 23168|&lt;span style=&#34;color:#ae81ff&#34;&gt;20675&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud       &lt;span style=&#34;color:#ae81ff&#34;&gt;37386&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloud-ui    &lt;span style=&#34;color:#ae81ff&#34;&gt;26105&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloudm-caihcloudm-api       &lt;span style=&#34;color:#ae81ff&#34;&gt;36236&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;caihcloudm-caihcloudm-prerender &lt;span style=&#34;color:#ae81ff&#34;&gt;31964&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å–podç½‘æ®µ&#34;&gt;è·å–PODç½‘æ®µ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get nodes -o jsonpath&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{.items[*].spec.podCIDR}&amp;#39;&lt;/span&gt; | tr &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;10.193.0.0/24
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;10.193.1.0/24
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;10.193.2.0/24
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è¾“å‡ºä¸€ä¸ªpodä¸­æ‰€æœ‰çš„å®¹å™¨çš„æ—¥å¿—&#34;&gt;è¾“å‡ºä¸€ä¸ªPODä¸­æ‰€æœ‰çš„å®¹å™¨çš„æ—¥å¿—&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl logs caihcloudm-caihcloudm-api-5cfffcc96-mz6pt -n caihcloud â€”all-containers
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æŒ‰æ ‡ç­¾è¾“å‡ºpodçš„æ—¥å¿—&#34;&gt;æŒ‰æ ‡ç­¾è¾“å‡ºPODçš„æ—¥å¿—&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl -n caihcloud logs -f -l app&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;caihcloudm-caihcloudm-api
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è·å–å‰ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—å®¹å™¨å¼‚å¸¸æŒ‚æ‰çš„åœºæ™¯&#34;&gt;è·å–å‰ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼ˆå®¹å™¨å¼‚å¸¸æŒ‚æ‰çš„åœºæ™¯ï¼‰&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl logs caihcloud-67ffdf9fc9-wzmts -n caihcloud --previous
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
    </item>
    
    <item>
      <title>Kubernetesç»„ä»¶</title>
      <link>http://hindung.cn/posts/21/</link>
      <pubDate>Tue, 01 Jun 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hindung.cn/posts/21/</guid>
      <description>æ€»ä½“æ¶æ„ Kubernetesç³»ç»Ÿé‡‡ç”¨C/Sæ¶æ„ï¼Œåˆ†ä¸ºMasterå’ŒNodeä¸¤ä¸ªéƒ¨åˆ†ï¼ŒMasterä½œä¸ºServerç«¯ï¼ŒNodeä½œä¸ºClientç«¯ã€‚
å¤šMasterçš„æ–¹å¼å¯ä»¥å®ç°é›†ç¾¤çš„é«˜å¯ç”¨ã€‚
Masterä¹Ÿå«åšä¸»æ§èŠ‚ç‚¹ï¼Œå®ƒä¸»è¦è´Ÿè´£ï¼š
 ç®¡ç†æ‰€æœ‰çš„èŠ‚ç‚¹ è°ƒåº¦POD æ§åˆ¶é›†ç¾¤è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰çŠ¶æ€ åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š API-Serverï¼šé›†ç¾¤çš„HTTP RESTæ¥å£ï¼Œç»Ÿä¸€å…¥å£ Controller-Managerï¼šæ‰€æœ‰èµ„æºçš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒ Schedulerï¼šPODè°ƒåº¦  Nodeä¹Ÿå«åšå·¥ä½œèŠ‚ç‚¹ï¼Œä¸»è¦è´Ÿè´£ï¼š
 ç®¡ç†æ‰€æœ‰å®¹å™¨ ç›‘æ§ã€ä¸ŠæŠ¥æ‰€æœ‰PODçš„è¿è¡ŒçŠ¶æ€ åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š Kubeletï¼šç®¡ç†èŠ‚ç‚¹ä¸Šå®¹å™¨çš„ç”Ÿå‘½ï¼Œä¸MasterèŠ‚ç‚¹é€šä¿¡ Kube-Proxyï¼šæœåŠ¡é€šä¿¡ã€è´Ÿè½½å‡è¡¡ CRIå®¹å™¨è¿è¡Œæ—¶ï¼šæ¥æ”¶kubeletçš„å®¹å™¨ç›¸å…³çš„æŒ‡ä»¤å¹¶æ‰§è¡Œ  MasterèŠ‚ç‚¹ä¹Ÿæ‹¥æœ‰Nodeç›¸å…³çš„ç»„ä»¶ï¼Œå³è¯¥Masterä¹Ÿå¯ä»¥ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿›è¡Œè®¡ç®—ã€‚
é™¤æ­¤ä¹‹å¤–ï¼Œk8så†…éƒ¨çš„å­˜å‚¨é‡‡ç”¨ETCDä½œä¸ºå”¯ä¸€å­˜å‚¨ï¼Œä¸€èˆ¬é‡‡ç”¨é›†ç¾¤é«˜å¯ç”¨çš„æ–¹å¼éƒ¨ç½²ã€‚
Etcdé›†ç¾¤æ˜¯åˆ†å¸ƒå¼K/Vå­˜å‚¨é›†ç¾¤ï¼Œæä¾›äº†å¯é çš„å¼ºä¸€è‡´æ€§æœåŠ¡å‘ç°ã€‚Etcdé›†ç¾¤å­˜å‚¨Kubernetesç³»ç»Ÿçš„é›†ç¾¤çŠ¶æ€å’Œå…ƒæ•°æ®ï¼Œå…¶ä¸­åŒ…æ‹¬æ‰€æœ‰Kubernetesèµ„æºå¯¹è±¡ä¿¡æ¯ã€èµ„æºå¯¹è±¡çŠ¶æ€ã€é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ç­‰ã€‚Kuberneteså°†æ‰€æœ‰æ•°æ®å­˜å‚¨è‡³Etcdé›†ç¾¤å‰ç¼€ä¸º/registryçš„ç›®å½•ä¸‹ã€‚
å„ä¸ªç»„ä»¶çš„åŠŸèƒ½ åœ¨k8sé›†ç¾¤ä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç»„ä»¶ï¼š
kubectl kubectlæ˜¯K8så®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¸»è¦ä¸API-Serveräº¤äº’ï¼Œé€šä¿¡åè®®é‡‡ç”¨HTTP/Jsonã€‚
client-go é™¤äº†æœ‰å‘½ä»¤è¡Œå·¥å…·å¯¹K8sè¿›è¡Œç®¡ç†ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç¼–ç¨‹æ–¹å¼ã€‚client-goç”¨golangè¿›è¡Œå¼€å‘ï¼Œå®ƒæœ€åˆæ˜¯K8sçš„éƒ¨åˆ†ä»£ç ï¼Œç°åœ¨æŠ½æˆäº†ç‹¬ç«‹çš„ä»“åº“ã€‚
K8sä»»ä½•ç»„ä»¶ä¸API-Serveré€šä¿¡éƒ½æ˜¯åŸºäºclient-goã€‚
API-Server è´Ÿè´£å°†K8s â€œèµ„æºç»„/èµ„æºç‰ˆæœ¬/èµ„æºâ€ ä»¥RESTfulå½¢å¼å¯¹å¤–æä¾›æœåŠ¡ã€‚API-Serveræ˜¯é›†ç¾¤ä¸­å”¯ä¸€ä¸ETCDäº¤äº’çš„ç»„ä»¶ã€‚å¹¶ä¸”å®ç°äº†é›†ç¾¤çš„å®‰å…¨è®¿é—®æœºåˆ¶ä»¥åŠè®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶ç­‰ã€‚
Controller-Manager ç®¡ç†æ§åˆ¶å™¨è´Ÿè´£ç®¡ç†ã€ç»´æŠ¤é›†ç¾¤å†…çš„çŠ¶æ€ï¼Œå¦‚ç»´æŠ¤PODçš„å‰¯æœ¬ä¸ªæ•°ä¸ºæœŸæœ›çš„çŠ¶æ€å€¼ç­‰ã€‚
åŒ…å«äº†å¤šä¸ªæ§åˆ¶å™¨ï¼š
 DeploymentControllersæ§åˆ¶å™¨ StatefulSetæ§åˆ¶å™¨ Namespaceæ§åˆ¶å™¨ PersistentVolumeæ§åˆ¶å™¨ ç­‰ç­‰ æ¯ä¸ªæ§åˆ¶å™¨é€šè¿‡kube-apiserverç»„ä»¶æä¾›çš„æ¥å£å®æ—¶ç›‘æ§æ•´ä¸ªé›†ç¾¤æ¯ä¸ªèµ„æºå¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼Œå½“å› å‘ç”Ÿå„ç§æ•…éšœè€Œå¯¼è‡´ç³»ç»ŸçŠ¶æ€å‡ºç°å˜åŒ–æ—¶ï¼Œä¼šå°è¯•å°†ç³»ç»ŸçŠ¶æ€ä¿®å¤åˆ°â€œæœŸæœ›çŠ¶æ€â€ã€‚  Scheduler è´Ÿè´£è°ƒåº¦PODåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚Kubeletä¸ŠæŠ¥èŠ‚ç‚¹ä¿¡æ¯ï¼ŒScheduleré€šè¿‡ç›‘æ§è¿™äº›ä¿¡æ¯ï¼Œå½“æœ‰æ–°çš„PODéœ€è¦è°ƒåº¦æ—¶ï¼Œä¼šæ ¹æ®è¿™äº›èŠ‚ç‚¹ä¿¡æ¯è¿›è¡Œè°ƒåº¦ç®—æ³•è®¡ç®—æœ€æœ‰èŠ‚ç‚¹ã€‚
è°ƒåº¦ç®—æ³•åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«ä¸ºé¢„é€‰è°ƒåº¦ç®—æ³•å’Œä¼˜é€‰è°ƒåº¦ç®—æ³•ã€‚é™¤è°ƒåº¦ç­–ç•¥å¤–ï¼ŒKubernetesè¿˜æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦ã€æŠ¢å æœºåˆ¶åŠäº²å’Œæ€§è°ƒåº¦ç­‰åŠŸèƒ½ã€‚
kube-schedulerç»„ä»¶æ”¯æŒé«˜å¯ç”¨æ€§ï¼ˆå³å¤šå®ä¾‹åŒæ—¶è¿è¡Œï¼‰ï¼Œå³åŸºäºEtcdé›†ç¾¤ä¸Šçš„åˆ†å¸ƒå¼é”å®ç°é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶ï¼Œå¤šå®ä¾‹åŒæ—¶è¿è¡Œï¼Œé€šè¿‡kube-apiserveræä¾›çš„èµ„æºé”è¿›è¡Œé€‰ä¸¾ç«äº‰ã€‚æŠ¢å…ˆè·å–é”çš„å®ä¾‹è¢«ç§°ä¸ºLeaderèŠ‚ç‚¹ï¼ˆå³é¢†å¯¼è€…èŠ‚ç‚¹ï¼‰ï¼Œå¹¶è¿è¡Œkube-schedulerç»„ä»¶çš„ä¸»é€»è¾‘ï¼›è€Œæœªè·å–é”çš„å®ä¾‹è¢«ç§°ä¸ºCandidateèŠ‚ç‚¹ï¼ˆå³å€™é€‰èŠ‚ç‚¹ï¼‰ï¼Œè¿è¡Œæ—¶å¤„äºé˜»å¡çŠ¶æ€ã€‚åœ¨LeaderèŠ‚ç‚¹å› æŸäº›åŸå› é€€å‡ºåï¼ŒCandidateèŠ‚ç‚¹åˆ™é€šè¿‡é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶å‚ä¸ç«é€‰ï¼Œæˆä¸ºLeaderèŠ‚ç‚¹åæ¥æ›¿kube-schedulerçš„å·¥ä½œã€‚
Kubelet kubeletç»„ä»¶ç”¨æ¥æ¥æ”¶ã€å¤„ç†ã€ä¸ŠæŠ¥kube-apiserverç»„ä»¶ä¸‹å‘çš„ä»»åŠ¡ã€‚kubeletè¿›ç¨‹å¯åŠ¨æ—¶ä¼šå‘kube-apiserveræ³¨å†ŒèŠ‚ç‚¹è‡ªèº«ä¿¡æ¯ã€‚å®ƒä¸»è¦è´Ÿè´£æ‰€åœ¨èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šçš„Podèµ„æºå¯¹è±¡çš„ç®¡ç†ï¼Œä¾‹å¦‚Podèµ„æºå¯¹è±¡çš„åˆ›å»ºã€ä¿®æ”¹ã€ç›‘æ§ã€åˆ é™¤ã€é©±é€åŠPodç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚
kubeletç»„ä»¶å®ç°äº†3ç§å¼€æ”¾æ¥å£ï¼š
  Container Runtime Interfaceï¼šç®€ç§°CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰ï¼Œæä¾›å®¹å™¨è¿è¡Œæ—¶é€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CRIå®šä¹‰äº†å®¹å™¨å’Œé•œåƒæœåŠ¡çš„æ¥å£ã€‚CRIå°†kubeletç»„ä»¶ä¸å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œè§£è€¦ï¼Œå°†åŸæ¥å®Œå…¨é¢å‘Podçº§åˆ«çš„å†…éƒ¨æ¥å£æ‹†åˆ†æˆé¢å‘Sandboxå’ŒContainerçš„gRPCæ¥å£ï¼Œå¹¶å°†é•œåƒç®¡ç†å’Œå®¹å™¨ç®¡ç†åˆ†ç¦»ç»™ä¸åŒçš„æœåŠ¡ã€‚
  Container Network Interfaceï¼šç®€ç§°CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰ï¼Œæä¾›ç½‘ç»œé€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CNIå®šä¹‰äº†Kubernetesç½‘ç»œæ’ä»¶çš„åŸºç¡€ï¼Œå®¹å™¨åˆ›å»ºæ—¶é€šè¿‡CNIæ’ä»¶é…ç½®ç½‘ç»œã€‚
  Container Storage Interfaceï¼šç®€ç§°CSIï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰ï¼Œæä¾›å­˜å‚¨é€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CSIå®šä¹‰äº†å®¹å™¨å­˜å‚¨å·æ ‡å‡†è§„èŒƒï¼Œå®¹å™¨åˆ›å»ºæ—¶é€šè¿‡CSIæ’ä»¶é…ç½®å­˜å‚¨å·ã€‚</description>
      <content>&lt;h1 id=&#34;æ€»ä½“æ¶æ„&#34;&gt;æ€»ä½“æ¶æ„&lt;/h1&gt;
&lt;p&gt;Kubernetesç³»ç»Ÿé‡‡ç”¨C/Sæ¶æ„ï¼Œåˆ†ä¸ºMasterå’ŒNodeä¸¤ä¸ªéƒ¨åˆ†ï¼ŒMasterä½œä¸ºServerç«¯ï¼ŒNodeä½œä¸ºClientç«¯ã€‚&lt;/p&gt;
&lt;p&gt;å¤šMasterçš„æ–¹å¼å¯ä»¥å®ç°é›†ç¾¤çš„é«˜å¯ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;Masterä¹Ÿå«åšä¸»æ§èŠ‚ç‚¹ï¼Œå®ƒä¸»è¦è´Ÿè´£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®¡ç†æ‰€æœ‰çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;è°ƒåº¦POD&lt;/li&gt;
&lt;li&gt;æ§åˆ¶é›†ç¾¤è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰çŠ¶æ€
åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š&lt;/li&gt;
&lt;li&gt;API-Serverï¼šé›†ç¾¤çš„HTTP RESTæ¥å£ï¼Œç»Ÿä¸€å…¥å£&lt;/li&gt;
&lt;li&gt;Controller-Managerï¼šæ‰€æœ‰èµ„æºçš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒ&lt;/li&gt;
&lt;li&gt;Schedulerï¼šPODè°ƒåº¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Nodeä¹Ÿå«åšå·¥ä½œèŠ‚ç‚¹ï¼Œä¸»è¦è´Ÿè´£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®¡ç†æ‰€æœ‰å®¹å™¨&lt;/li&gt;
&lt;li&gt;ç›‘æ§ã€ä¸ŠæŠ¥æ‰€æœ‰PODçš„è¿è¡ŒçŠ¶æ€
åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š&lt;/li&gt;
&lt;li&gt;Kubeletï¼šç®¡ç†èŠ‚ç‚¹ä¸Šå®¹å™¨çš„ç”Ÿå‘½ï¼Œä¸MasterèŠ‚ç‚¹é€šä¿¡&lt;/li&gt;
&lt;li&gt;Kube-Proxyï¼šæœåŠ¡é€šä¿¡ã€è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;li&gt;CRIå®¹å™¨è¿è¡Œæ—¶ï¼šæ¥æ”¶kubeletçš„å®¹å™¨ç›¸å…³çš„æŒ‡ä»¤å¹¶æ‰§è¡Œ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MasterèŠ‚ç‚¹ä¹Ÿæ‹¥æœ‰Nodeç›¸å…³çš„ç»„ä»¶ï¼Œå³è¯¥Masterä¹Ÿå¯ä»¥ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿›è¡Œè®¡ç®—ã€‚&lt;/p&gt;
&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œk8så†…éƒ¨çš„å­˜å‚¨é‡‡ç”¨ETCDä½œä¸ºå”¯ä¸€å­˜å‚¨ï¼Œä¸€èˆ¬é‡‡ç”¨é›†ç¾¤é«˜å¯ç”¨çš„æ–¹å¼éƒ¨ç½²ã€‚&lt;/p&gt;
&lt;p&gt;Etcdé›†ç¾¤æ˜¯åˆ†å¸ƒå¼K/Vå­˜å‚¨é›†ç¾¤ï¼Œæä¾›äº†å¯é çš„å¼ºä¸€è‡´æ€§æœåŠ¡å‘ç°ã€‚Etcdé›†ç¾¤å­˜å‚¨Kubernetesç³»ç»Ÿçš„é›†ç¾¤çŠ¶æ€å’Œå…ƒæ•°æ®ï¼Œå…¶ä¸­åŒ…æ‹¬æ‰€æœ‰Kubernetesèµ„æºå¯¹è±¡ä¿¡æ¯ã€èµ„æºå¯¹è±¡çŠ¶æ€ã€é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ç­‰ã€‚Kuberneteså°†æ‰€æœ‰æ•°æ®å­˜å‚¨è‡³Etcdé›†ç¾¤å‰ç¼€ä¸º/registryçš„ç›®å½•ä¸‹ã€‚&lt;/p&gt;
&lt;h1 id=&#34;å„ä¸ªç»„ä»¶çš„åŠŸèƒ½&#34;&gt;å„ä¸ªç»„ä»¶çš„åŠŸèƒ½&lt;/h1&gt;
&lt;p&gt;åœ¨k8sé›†ç¾¤ä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç»„ä»¶ï¼š&lt;/p&gt;
&lt;h2 id=&#34;kubectl&#34;&gt;kubectl&lt;/h2&gt;
&lt;p&gt;kubectlæ˜¯K8så®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¸»è¦ä¸API-Serveräº¤äº’ï¼Œé€šä¿¡åè®®é‡‡ç”¨HTTP/Jsonã€‚&lt;/p&gt;
&lt;h2 id=&#34;client-go&#34;&gt;client-go&lt;/h2&gt;
&lt;p&gt;é™¤äº†æœ‰å‘½ä»¤è¡Œå·¥å…·å¯¹K8sè¿›è¡Œç®¡ç†ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç¼–ç¨‹æ–¹å¼ã€‚client-goç”¨golangè¿›è¡Œå¼€å‘ï¼Œå®ƒæœ€åˆæ˜¯K8sçš„éƒ¨åˆ†ä»£ç ï¼Œç°åœ¨æŠ½æˆäº†ç‹¬ç«‹çš„ä»“åº“ã€‚&lt;/p&gt;
&lt;p&gt;K8sä»»ä½•ç»„ä»¶ä¸API-Serveré€šä¿¡éƒ½æ˜¯åŸºäºclient-goã€‚&lt;/p&gt;
&lt;h2 id=&#34;api-server&#34;&gt;API-Server&lt;/h2&gt;
&lt;p&gt;è´Ÿè´£å°†K8s â€œèµ„æºç»„/èµ„æºç‰ˆæœ¬/èµ„æºâ€ ä»¥RESTfulå½¢å¼å¯¹å¤–æä¾›æœåŠ¡ã€‚API-Serveræ˜¯é›†ç¾¤ä¸­å”¯ä¸€ä¸ETCDäº¤äº’çš„ç»„ä»¶ã€‚å¹¶ä¸”å®ç°äº†é›†ç¾¤çš„å®‰å…¨è®¿é—®æœºåˆ¶ä»¥åŠè®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶ç­‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;controller-manager&#34;&gt;Controller-Manager&lt;/h2&gt;
&lt;p&gt;ç®¡ç†æ§åˆ¶å™¨è´Ÿè´£ç®¡ç†ã€ç»´æŠ¤é›†ç¾¤å†…çš„çŠ¶æ€ï¼Œå¦‚ç»´æŠ¤PODçš„å‰¯æœ¬ä¸ªæ•°ä¸ºæœŸæœ›çš„çŠ¶æ€å€¼ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;åŒ…å«äº†å¤šä¸ªæ§åˆ¶å™¨ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DeploymentControllersæ§åˆ¶å™¨&lt;/li&gt;
&lt;li&gt;StatefulSetæ§åˆ¶å™¨&lt;/li&gt;
&lt;li&gt;Namespaceæ§åˆ¶å™¨&lt;/li&gt;
&lt;li&gt;PersistentVolumeæ§åˆ¶å™¨&lt;/li&gt;
&lt;li&gt;ç­‰ç­‰
æ¯ä¸ªæ§åˆ¶å™¨é€šè¿‡kube-apiserverç»„ä»¶æä¾›çš„æ¥å£å®æ—¶ç›‘æ§æ•´ä¸ªé›†ç¾¤æ¯ä¸ªèµ„æºå¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼Œå½“å› å‘ç”Ÿå„ç§æ•…éšœè€Œå¯¼è‡´ç³»ç»ŸçŠ¶æ€å‡ºç°å˜åŒ–æ—¶ï¼Œä¼šå°è¯•å°†ç³»ç»ŸçŠ¶æ€ä¿®å¤åˆ°â€œæœŸæœ›çŠ¶æ€â€ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;scheduler&#34;&gt;Scheduler&lt;/h2&gt;
&lt;p&gt;è´Ÿè´£è°ƒåº¦PODåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚Kubeletä¸ŠæŠ¥èŠ‚ç‚¹ä¿¡æ¯ï¼ŒScheduleré€šè¿‡ç›‘æ§è¿™äº›ä¿¡æ¯ï¼Œå½“æœ‰æ–°çš„PODéœ€è¦è°ƒåº¦æ—¶ï¼Œä¼šæ ¹æ®è¿™äº›èŠ‚ç‚¹ä¿¡æ¯è¿›è¡Œè°ƒåº¦ç®—æ³•è®¡ç®—æœ€æœ‰èŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒåº¦ç®—æ³•åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«ä¸ºé¢„é€‰è°ƒåº¦ç®—æ³•å’Œä¼˜é€‰è°ƒåº¦ç®—æ³•ã€‚é™¤è°ƒåº¦ç­–ç•¥å¤–ï¼ŒKubernetesè¿˜æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦ã€æŠ¢å æœºåˆ¶åŠäº²å’Œæ€§è°ƒåº¦ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;kube-schedulerç»„ä»¶æ”¯æŒé«˜å¯ç”¨æ€§ï¼ˆå³å¤šå®ä¾‹åŒæ—¶è¿è¡Œï¼‰ï¼Œå³åŸºäºEtcdé›†ç¾¤ä¸Šçš„åˆ†å¸ƒå¼é”å®ç°é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶ï¼Œå¤šå®ä¾‹åŒæ—¶è¿è¡Œï¼Œé€šè¿‡kube-apiserveræä¾›çš„èµ„æºé”è¿›è¡Œé€‰ä¸¾ç«äº‰ã€‚æŠ¢å…ˆè·å–é”çš„å®ä¾‹è¢«ç§°ä¸ºLeaderèŠ‚ç‚¹ï¼ˆå³é¢†å¯¼è€…èŠ‚ç‚¹ï¼‰ï¼Œå¹¶è¿è¡Œkube-schedulerç»„ä»¶çš„ä¸»é€»è¾‘ï¼›è€Œæœªè·å–é”çš„å®ä¾‹è¢«ç§°ä¸ºCandidateèŠ‚ç‚¹ï¼ˆå³å€™é€‰èŠ‚ç‚¹ï¼‰ï¼Œè¿è¡Œæ—¶å¤„äºé˜»å¡çŠ¶æ€ã€‚åœ¨LeaderèŠ‚ç‚¹å› æŸäº›åŸå› é€€å‡ºåï¼ŒCandidateèŠ‚ç‚¹åˆ™é€šè¿‡é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶å‚ä¸ç«é€‰ï¼Œæˆä¸ºLeaderèŠ‚ç‚¹åæ¥æ›¿kube-schedulerçš„å·¥ä½œã€‚&lt;/p&gt;
&lt;h2 id=&#34;kubelet&#34;&gt;Kubelet&lt;/h2&gt;
&lt;p&gt;kubeletç»„ä»¶ç”¨æ¥æ¥æ”¶ã€å¤„ç†ã€ä¸ŠæŠ¥kube-apiserverç»„ä»¶ä¸‹å‘çš„ä»»åŠ¡ã€‚kubeletè¿›ç¨‹å¯åŠ¨æ—¶ä¼šå‘kube-apiserveræ³¨å†ŒèŠ‚ç‚¹è‡ªèº«ä¿¡æ¯ã€‚å®ƒä¸»è¦è´Ÿè´£æ‰€åœ¨èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šçš„Podèµ„æºå¯¹è±¡çš„ç®¡ç†ï¼Œä¾‹å¦‚Podèµ„æºå¯¹è±¡çš„åˆ›å»ºã€ä¿®æ”¹ã€ç›‘æ§ã€åˆ é™¤ã€é©±é€åŠPodç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;kubeletç»„ä»¶å®ç°äº†3ç§å¼€æ”¾æ¥å£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Container Runtime Interfaceï¼šç®€ç§°CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰ï¼Œæä¾›å®¹å™¨è¿è¡Œæ—¶é€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CRIå®šä¹‰äº†å®¹å™¨å’Œé•œåƒæœåŠ¡çš„æ¥å£ã€‚CRIå°†kubeletç»„ä»¶ä¸å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œè§£è€¦ï¼Œå°†åŸæ¥å®Œå…¨é¢å‘Podçº§åˆ«çš„å†…éƒ¨æ¥å£æ‹†åˆ†æˆé¢å‘Sandboxå’ŒContainerçš„gRPCæ¥å£ï¼Œå¹¶å°†é•œåƒç®¡ç†å’Œå®¹å™¨ç®¡ç†åˆ†ç¦»ç»™ä¸åŒçš„æœåŠ¡ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Container Network Interfaceï¼šç®€ç§°CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰ï¼Œæä¾›ç½‘ç»œé€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CNIå®šä¹‰äº†Kubernetesç½‘ç»œæ’ä»¶çš„åŸºç¡€ï¼Œå®¹å™¨åˆ›å»ºæ—¶é€šè¿‡CNIæ’ä»¶é…ç½®ç½‘ç»œã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Container Storage Interfaceï¼šç®€ç§°CSIï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰ï¼Œæä¾›å­˜å‚¨é€šç”¨æ’ä»¶æ¥å£æœåŠ¡ã€‚CSIå®šä¹‰äº†å®¹å™¨å­˜å‚¨å·æ ‡å‡†è§„èŒƒï¼Œå®¹å™¨åˆ›å»ºæ—¶é€šè¿‡CSIæ’ä»¶é…ç½®å­˜å‚¨å·ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;kube-proxy&#34;&gt;Kube-Proxy&lt;/h2&gt;
&lt;p&gt;kube-proxyç»„ä»¶ï¼Œä½œä¸ºèŠ‚ç‚¹ä¸Šçš„ç½‘ç»œä»£ç†ï¼Œè¿è¡Œåœ¨æ¯ä¸ªKubernetesèŠ‚ç‚¹ä¸Šã€‚å®ƒç›‘æ§kube-apiserverçš„æœåŠ¡å’Œç«¯ç‚¹èµ„æºå˜åŒ–ï¼Œå¹¶é€šè¿‡iptables/ipvsç­‰é…ç½®è´Ÿè½½å‡è¡¡å™¨ï¼Œä¸ºä¸€ç»„Podæä¾›ç»Ÿä¸€çš„TCP/UDPæµé‡è½¬å‘å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;Kube-Proxyæœ‰å‡ ä¸ªå·¥ä½œæ¨¡å¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;userspace&lt;/li&gt;
&lt;li&gt;iptables æ¨¡å¼&lt;/li&gt;
&lt;li&gt;ipvs æ¨¡å¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…·ä½“å¯ä»¥å‚è€ƒï¼š&lt;a href=&#34;https://kubernetes.io/zh/docs/concepts/services-networking/service/&#34;&gt;services-networking&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;criå®¹å™¨è¿è¡Œæ—¶ç»„ä»¶&#34;&gt;CRIå®¹å™¨è¿è¡Œæ—¶ç»„ä»¶&lt;/h2&gt;
&lt;p&gt;CRI åœ¨ Kubernetes 1.5 ä¸­å¼•å…¥ï¼Œå……å½“kubeletå’Œå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´çš„æ¡¥æ¢ã€‚&lt;/p&gt;
&lt;p&gt;å³kubeletéœ€è¦è·ŸContaner Runtimeäº¤äº’å»ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
