---
title: Prometheus GO SDK
date: '2023-07-19 17:39:52'
type: post
showTableOfContents: true
description: Prometheus SDKä½¿ç”¨å°ğŸ¥
tags:
  - Prometheus
---

# Prometheus GO SDK



## 1. ä»‹ç»Prometheus

Prometheus æ˜¯ç”±å‰ Google å·¥ç¨‹å¸ˆä» 2012 å¹´å¼€å§‹åœ¨ Soundcloud ä»¥å¼€æºè½¯ä»¶çš„å½¢å¼è¿›è¡Œç ”å‘çš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦å·¥å…·åŒ…ï¼Œè‡ªæ­¤ä»¥åï¼Œè®¸å¤šå…¬å¸å’Œç»„ç»‡éƒ½é‡‡ç”¨äº† Prometheus ä½œä¸ºç›‘æ§å‘Šè­¦å·¥å…·ã€‚Prometheus çš„å¼€å‘è€…å’Œç”¨æˆ·ç¤¾åŒºéå¸¸æ´»è·ƒï¼Œå®ƒç°åœ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ï¼Œå¯ä»¥ç‹¬ç«‹äºä»»ä½•å…¬å¸è¿›è¡Œç»´æŠ¤ã€‚

Prometheusç”Ÿæ€æœ‰å¾ˆå¤šä¸°å¯Œçš„ç»„ä»¶ä»¥åŠSDKã€‚å…¶ä¸­å¸¸è§çš„ç»„åˆæ˜¯ SDK + Prometheus + Alert Manager + Grafana + Lokiã€‚

## 2. Prometheus Goå®¢æˆ·ç«¯åº“æ¦‚è¿°

Githubåœ°å€ï¼š[https://github.com/prometheus/client_golang](https://github.com/prometheus/client_golang)

```
.
â”œâ”€â”€ api
â”‚   â””â”€â”€ prometheus 
â”œâ”€â”€ examples   # å®˜æ–¹ä¾‹å­
â”‚   â”œâ”€â”€ exemplars
â”‚   â”œâ”€â”€ gocollector
â”‚   â”œâ”€â”€ middleware
â”‚   â”œâ”€â”€ random
â”‚   â””â”€â”€ simple
â”œâ”€â”€ prometheus     # æ ¸å¿ƒä»£ç å®šä¹‰å„ç§æŒ‡æ ‡æ¥å£ã€ç»“æ„ç­‰
â”‚   â”œâ”€â”€ collectors # å®šä¹‰æ”¶é›†å™¨ç­‰
â”‚   â”œâ”€â”€ graphite   # è®¾è®¡æ¨¡å¼ç›¸å…³
â”‚   â”œâ”€â”€ internal   # å†…éƒ¨å®ç°
â”‚   â”œâ”€â”€ promauto   # ä¸Prometheuså®ä¾‹ä¹‹é—´ç»´æŠ¤ä¸€ä¸ªå…¨å±€æ³¨å†Œè¡¨ï¼Œç”¨äºç»´æŠ¤æŒ‡æ ‡ä¿¡æ¯
â”‚   â”œâ”€â”€ promhttp   # é€šè¿‡ HTTP æœåŠ¡æš´éœ²å‡ºæ¥çš„æ–¹æ³•é›†åˆ
â”‚   â”œâ”€â”€ push       # æ¨é€æŒ‡æ ‡åˆ°Prometheusç›¸å…³çš„åŒ…
â”‚   â””â”€â”€ testutil   # testç›¸å…³çš„
```


## 3. APIæ¥å£å’ŒåŠŸèƒ½

Prometheusæ”¯æŒçš„Metricç±»å‹æœ‰4ç§ï¼šCounter, Gauge, Histogram å’Œ Summaryã€‚

### Counter ï¼ˆåªå¢é‡å¯å˜ä¸º0ï¼‰

è®¡æ•°å™¨ç±»å‹æ˜¯ä¸€ä¸ªç´¯ç§¯æŒ‡æ ‡ï¼Œè¡¨ç¤ºå•ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œå…¶å€¼åªèƒ½åœ¨é‡æ–°å¯åŠ¨æ—¶å¢åŠ æˆ–é‡ç½®ä¸ºé›¶ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è®¡æ•°å™¨æ¥è¡¨ç¤ºæœåŠ¡çš„è¯·æ±‚æ•°ã€å·²å®Œæˆçš„ä»»åŠ¡æ•°æˆ–é”™è¯¯æ•°ã€‚

### Gauge ï¼ˆä»ªè¡¨ç›˜ï¼Œå³å¯å˜å¤§å˜å°ï¼‰

ä»ªè¡¨æ˜¯è¡¨ç¤ºå¯ä»¥ä»»æ„ä¸Šä¸‹ç§»åŠ¨çš„å•ä¸ªæ•°å€¼çš„æŒ‡æ ‡ã€‚å¯ä»¥ç”¨æ¥è¡¨ç¤ºæ¸©åº¦ã€å†…å­˜ä½¿ç”¨ã€é€Ÿåº¦ç­‰å€¼ã€‚

### Histogram ï¼ˆç›´æ–¹å›¾ï¼‰

ç›´æ–¹å›¾æŒ‡æ ‡æ˜¯ä¸€ç§ç”¨äºåº¦é‡æ•°æ®åˆ†å¸ƒçš„æŒ‡æ ‡ç±»å‹ã€‚å®ƒå°†æ•°æ®åˆ†æˆä¸€ç³»åˆ—æ¡¶(bucket)ï¼Œæ¯ä¸ªæ¡¶ä»£è¡¨ä¸€å®šèŒƒå›´å†…çš„æ•°æ®ï¼Œç„¶åè®°å½•æ¯ä¸ªæ¡¶ä¸­æ•°æ®çš„æ•°é‡ä»¥åŠæ€»å’Œã€‚

æ¯”å¦‚ï¼Œæ¯ä¸ª Histogram æŒ‡æ ‡éƒ½åŒ…å«å¤šä¸ªå­æŒ‡æ ‡ï¼š

`my_histogram_bucket{le="0.005"}`ï¼šè¡¨ç¤ºæ•°æ®å°äºç­‰äº 0.005 çš„æ•°é‡ã€‚

`my_histogram_bucket{le="0.01"}`ï¼šè¡¨ç¤ºæ•°æ®å°äºç­‰äº 0.01 çš„æ•°é‡ã€‚

`my_histogram_bucket{le="0.025"}`ï¼šè¡¨ç¤ºæ•°æ®å°äºç­‰äº 0.025 çš„æ•°é‡ã€‚

â€¦â€¦

`my_histogram_bucket{le="+Inf"}`ï¼šè¡¨ç¤ºæ•°æ®å°äºç­‰äºæ­£æ— ç©·çš„æ•°é‡ã€‚


å…¶ä¸­ le è¡¨ç¤ºâ€œå°äºç­‰äºâ€ï¼Œæ¯ä¸ªå­æŒ‡æ ‡åŒ…å«ä¸€ä¸ªæ ‡ç­¾ leï¼Œè¡¨ç¤ºè¯¥å­æŒ‡æ ‡æ‰€å¯¹åº”çš„æ¡¶çš„ä¸Šé™å€¼ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªå­æŒ‡æ ‡ï¼š

`my_histogram_sum`ï¼šè¡¨ç¤ºæ‰€æœ‰æ•°æ®çš„æ€»å’Œã€‚

`my_histogram_count`ï¼šè¡¨ç¤ºæ‰€æœ‰æ•°æ®çš„æ•°é‡ã€‚


### Summary

Summary æŒ‡æ ‡æ˜¯ä¸€ç§ç”¨äºåº¦é‡æ•°æ®åˆ†å¸ƒæƒ…å†µçš„æŒ‡æ ‡ç±»å‹ï¼Œå®ƒç±»ä¼¼äº Histogram æŒ‡æ ‡ï¼Œä¹Ÿå°†æ•°æ®åˆ†æˆå¤šä¸ªæ¡¶ï¼Œä½†æ¯ä¸ªæ¡¶ä»£è¡¨çš„ä¸æ˜¯æ•°æ®çš„æ•°é‡ï¼Œè€Œæ˜¯æ•°æ®çš„åˆ†ä½æ•°ã€‚

å…ˆæ¥ç†è§£ä¸€ä¸‹ä¸­ä½æ•°å’Œåˆ†ä½æ•°ï¼š

å¤§å°æ’åˆ—åï¼š`2, 3, 5, 6, 7, 8, 9`ã€‚ä½äºä¸­é—´çš„æ•°å€¼æ˜¯ `6`ï¼Œå› æ­¤å®ƒæ˜¯è¿™ç»„æ•°æ®çš„ä¸­ä½æ•°ã€‚

å¤§å°æ’åˆ—åï¼š
`2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 20, 30, 40, 50, 100`ï¼Œè¿™ç»„æ•°æ®ä¸­ï¼Œæ’åœ¨å‰ 90% çš„æ•°å€¼ä¸ºå‰ 13 ä¸ªæ•°ï¼Œå³ï¼š
`2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 20, 30, 40`ï¼Œæ‰€ä»¥è¿™ç»„æ•°æ®çš„ 90% åˆ†ä½æ•°ä¸º `40`ã€‚


æ¯ä¸ª Summary æŒ‡æ ‡éƒ½åŒ…å«å¤šä¸ªå­æŒ‡æ ‡ï¼š

`my_summary{quantile="0.5"}`ï¼šè¡¨ç¤ºæ•°æ®çš„ä¸­ä½æ•°ã€‚

`my_summary{quantile="0.9"}`ï¼šè¡¨ç¤ºæ•°æ®çš„ 90% åˆ†ä½æ•°ã€‚

`my_summary{quantile="0.99"}`ï¼šè¡¨ç¤ºæ•°æ®çš„ 99% åˆ†ä½æ•°ã€‚

â€¦â€¦

`my_summary_sum`ï¼šè¡¨ç¤ºæ‰€æœ‰æ•°æ®çš„æ€»å’Œã€‚

`my_summary_count`ï¼šè¡¨ç¤ºæ‰€æœ‰æ•°æ®çš„æ•°é‡ã€‚

ä¸ Histogram æŒ‡æ ‡ä¸åŒçš„æ˜¯ï¼ŒSummary æŒ‡æ ‡ä¸éœ€è¦å®šä¹‰å›ºå®šçš„æ¡¶ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶æ ¹æ®æ•°æ®åŠ¨æ€è®¡ç®—æ¯ä¸ªåˆ†ä½æ•°çš„å€¼ã€‚

## 4. å®ä¾‹ï¼šå¦‚ä½•ä½¿ç”¨Prometheus Goå®¢æˆ·ç«¯åº“

```go
package main

import (
	"math/rand"
	"net/http"
	"time"

	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
	// Counter æŒ‡æ ‡ç”¨äºè®¡æ•°ï¼Œå®ƒåªä¼šå¢åŠ ï¼Œä¸ä¼šå‡å°‘ã€‚
	counter = prometheus.NewCounter(prometheus.CounterOpts{
		Name: "my_counter",
		Help: "This is my counter.",
	})

	// Gauge æŒ‡æ ‡ç”¨äºè¡¨ç¤ºä¸€ä¸ªå¯å˜çš„å€¼ï¼Œå®ƒå¯ä»¥å¢åŠ æˆ–å‡å°‘ã€‚
	gauge = prometheus.NewGauge(prometheus.GaugeOpts{
		Name: "my_gauge",
		Help: "This is my gauge.",
	})

	// Histogram æŒ‡æ ‡ç”¨äºåº¦é‡æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå®ƒå°†æ•°æ®åˆ†æˆå¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ä»£è¡¨æ•°æ®çš„æ•°é‡ã€‚
	histogram = prometheus.NewHistogram(prometheus.HistogramOpts{
		Name: "my_histogram",
		Help: "This is my histogram.",
		Buckets: []float64{1, 2, 5, 10, 20, 50, 100},
	})

	// Summary æŒ‡æ ‡ç”¨äºåº¦é‡æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå®ƒå°†æ•°æ®åˆ†æˆå¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ä»£è¡¨æ•°æ®çš„åˆ†ä½æ•°ã€‚
	summary = prometheus.NewSummary(prometheus.SummaryOpts{
		Name: "my_summary",
		Help: "This is my summary.",
		Objectives: map[float64]float64{0.5: 0.05, 0.9: 0.01, 0.99: 0.001},
	})
)

func init() {
	// æ³¨å†ŒæŒ‡æ ‡åˆ°é»˜è®¤çš„æ³¨å†Œå™¨ä¸­ï¼Œé»˜è®¤æ³¨å†Œå™¨ä¼šåŒ…å«ä¸€äº›goå†…å»ºçš„æŒ‡æ ‡ï¼Œ
    // å½“ç„¶ä¹Ÿå¯ä»¥newä¸€ä¸ªè‡ªå·±çš„registry := prometheus.NewRegistry()
	prometheus.MustRegister(counter)
	prometheus.MustRegister(gauge)
	prometheus.MustRegister(histogram)
	prometheus.MustRegister(summary)
}

func main() {
	// æ¯éš”ä¸€ç§’é’Ÿæ›´æ–°æŒ‡æ ‡
	go func() {
		for {
			counter.Inc()
			gauge.Set(rand.Float64() * 100)
			histogram.Observe(rand.Float64() * 100)
			summary.Observe(rand.Float64() * 100)
			time.Sleep(time.Second)
		}
	}()

	// å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œæš´éœ²æŒ‡æ ‡æ•°æ®
	http.Handle("/metrics", promhttp.Handler())
	http.ListenAndServe(":8080", nil)
}
```

è®¿é—®metricsï¼š
```
# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
... éšè—Prometheus goè‡ªå¸¦çš„æŒ‡æ ‡

# HELP my_counter This is my counter.
# TYPE my_counter counter
my_counter 32
# HELP my_gauge This is my gauge.
# TYPE my_gauge gauge
my_gauge 15.232291874677397
# HELP my_histogram This is my histogram.
# TYPE my_histogram histogram
my_histogram_bucket{le="1"} 0
my_histogram_bucket{le="2"} 0
my_histogram_bucket{le="5"} 1
my_histogram_bucket{le="10"} 3
my_histogram_bucket{le="20"} 3
my_histogram_bucket{le="50"} 13
my_histogram_bucket{le="100"} 32
my_histogram_bucket{le="+Inf"} 32
my_histogram_sum 1804.8308076418284
my_histogram_count 32
# HELP my_summary This is my summary.
# TYPE my_summary summary
my_summary{quantile="0.5"} 55.45191711055754
my_summary{quantile="0.9"} 90.63655279983087
my_summary{quantile="0.99"} 98.26833189512352
my_summary_sum 1719.6545962079606
my_summary_count 32

...
# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.
# TYPE promhttp_metric_handler_requests_total counter
promhttp_metric_handler_requests_total{code="200"} 0
promhttp_metric_handler_requests_total{code="500"} 0
promhttp_metric_handler_requests_total{code="503"} 0
```

è¿˜å¯ä»¥åŠ ä¸Šlabelç”¨äºåŒºåˆ†ä¸åŒç»´åº¦çš„æ•°æ®ï¼Œå¦‚alertmanagerï¼š

```go
type Alerts struct {
	firing   prometheus.Counter
	resolved prometheus.Counter
	invalid  prometheus.Counter
}

// NewAlerts returns an *Alerts struct for the given API version.
func NewAlerts(version string, r prometheus.Registerer) *Alerts {
	numReceivedAlerts := prometheus.NewCounterVec(prometheus.CounterOpts{
		Name:        "alertmanager_alerts_received_total",
		Help:        "The total number of received alerts.",
		ConstLabels: prometheus.Labels{"version": version},
	}, []string{"status"})
	numInvalidAlerts := prometheus.NewCounter(prometheus.CounterOpts{
		Name:        "alertmanager_alerts_invalid_total",
		Help:        "The total number of received alerts that were invalid.",
		ConstLabels: prometheus.Labels{"version": version},
	})
	if r != nil {
		r.MustRegister(numReceivedAlerts, numInvalidAlerts)
	}
	return &Alerts{
		firing:   numReceivedAlerts.WithLabelValues("firing"),  // åŒä¸€ä¸ªCounterçš„ä¸åŒæ ‡ç­¾ï¼Œfiring.Inc()
		resolved: numReceivedAlerts.WithLabelValues("resolved"),// åŒä¸€ä¸ªCounterçš„ä¸åŒæ ‡ç­¾ï¼Œresolved.Inc()
		invalid:  numInvalidAlerts,
	}
}
```
æ•ˆæœï¼š
```
# HELP alertmanager_alerts_received_total The total number of received alerts.
# TYPE alertmanager_alerts_received_total counter è¿™ä¸ªè®¡æ•°å™¨åˆ†åˆ«åœ¨å››ä¸ªç»´åº¦ä¸Šæœ‰æ•°æ®
alertmanager_alerts_received_total{status="firing",version="v1"} 0
alertmanager_alerts_received_total{status="firing",version="v2"} 25009
alertmanager_alerts_received_total{status="resolved",version="v1"} 0
alertmanager_alerts_received_total{status="resolved",version="v2"} 758
```


## 5. æ€»ç»“

å®¹æ˜“é‡åˆ°çš„å‘ï¼šä¿®æ”¹æŒ‡æ ‡çš„æ ‡ç­¾å¯¼è‡´panicã€‚

å½“æˆ‘ä»¬å®šä¹‰å¥½ä¸€ä¸ªmetricå¦‚ï¼š
```go
var (
	counter = prometheus.NewCounterVec(prometheus.CounterOpts{
		Name: "my_counter",
		Help: "This is my counter.",
	}, []string{"foo", "bar"})
)

func init() {
	prometheus.MustRegister(counter)
}

func main() {
	// æ¯éš”ä¸€ç§’é’Ÿæ›´æ–°æŒ‡æ ‡
	go func() {
		for {
			counter.With(prometheus.Labels{"foo": "a", "bar": "b"}).Inc()
			time.Sleep(time.Second)
		}
	}()

	// ä¿®æ”¹æŒ‡æ ‡çš„æ ‡ç­¾å’Œä¿¡æ¯
	counter = prometheus.NewCounterVec(prometheus.CounterOpts{
		Name: "my_counter",
		Help: "This is my new counter.",
	}, []string{"foo", "baz"})
}
```
è¾“å‡ºï¼š
```
go run main.go                                                
panic: label name "baz" missing in label map

goroutine 19 [running]:
github.com/prometheus/client_golang/prometheus.(*CounterVec).With(...)
        /root/go/pkg/mod/github.com/prometheus/client_golang@v1.16.0/prometheus/counter.go:286
main.main.func1()
        /root/hxd/code/metrics-example/main.go:53 +0x171
created by main.main
        /root/hxd/code/metrics-example/main.go:51 +0x32
exit status 2
```
å› æ­¤æœ€å¥½å®šä¹‰metricä¹‹åä¸è¦åœ¨åœ¨ä»£ç é€»è¾‘ä¸ŠåŠ¨æ€ä¿®æ”¹Labelçš„å€¼ï¼Œæˆ–è€…ä¿®æ”¹ä¹‹åéœ€è¦é‡æ–°æ³¨å†Œï¼š`prometheus.MustRegister(counter)`ã€‚
ä½†æ˜¯ä¹Ÿä¸å»ºè®®è¿™ä¹ˆåšã€‚å®é™…ä¸ŠPrometheuså·²ç»å¸®æˆ‘ä»¬å¤„ç†å¥½äº†è¿™ä¸ªæŒ‡æ ‡çš„æ³¨å†Œè¿‡ç¨‹ï¼ˆä¸Šé¢æåˆ°çš„prometheus/promautoåŒ…ï¼‰ï¼Œå› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶åº”è¯¥æå‰å®šä¹‰å¥½æŒ‡æ ‡ä»¥åŠlabelï¼Œç„¶åæ³¨å†Œåˆ°å¯¹åº”çš„Registryã€‚åœ¨ä½¿ç”¨æ—¶ï¼Œç”¨`CounterVec.WithLabelValues()`æ–¹æ³•å®ä¾‹åŒ–ä¸€ä¸ªç»´åº¦çš„æŒ‡æ ‡å¹¶ç»´æŠ¤å€¼ã€‚

ä¹Ÿå¯ä»¥è®¾è®¡ä¸€ä¸ªcollectoræˆ–è€…ç›´æ¥å¼•å…¥ç¬¬ä¸‰æ–¹collectorè·å¾—metricèƒ½åŠ›ã€‚

å¦‚ï¼š

```go
    // Add Go module build info.
	reg.MustRegister(collectors.NewBuildInfoCollector())

    func NewBuildInfoCollector() Collector {
        path, version, sum := "unknown", "unknown", "unknown"
        if bi, ok := debug.ReadBuildInfo(); ok {
            path = bi.Main.Path
            version = bi.Main.Version
            sum = bi.Main.Sum
        }
        c := &selfCollector{MustNewConstMetric(
            NewDesc(
                "go_build_info",
                "Build information about the main Go module.",
                nil, Labels{"path": path, "version": version, "checksum": sum},
            ),
            GaugeValue, 1)}
        c.init(c.self)
        return c
    }
```

å‚è€ƒè¿æ¥ï¼š

[https://prometheus.io/docs/concepts/metric_types/](https://prometheus.io/docs/concepts/metric_types/)

[https://github.com/prometheus/client_golang](https://github.com/prometheus/client_golang)