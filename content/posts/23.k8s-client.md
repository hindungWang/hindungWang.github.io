---
title: K8s client-goåˆå§‹åŒ–çš„å‡ ç§æ–¹æ³•
Date: 2022-07-19
type: post
showTableOfContents: true
description: ç»å¸¸ç”¨åˆ°çš„é›†ä¸­k8s clientçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™é‡Œæ€»ç»“å¤‡å¿˜ğŸ“ä¸€ä¸‹
tags:
  - Kubernetes
  - Go
---

## ç®€ä»‹

client-goæ˜¯k8sçš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶åº“ï¼Œæ˜¯ç”¨äºä¸API-Serveräº¤äº’çš„httpå®¢æˆ·ç«¯ã€‚K8sä¸­å¤§éƒ¨åˆ†ç»„ä»¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“å®ç°ä¸API-Serverçš„é€šä¿¡åŠŸèƒ½ã€‚é™¤äº†èƒ½å¤Ÿå¯¹èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿˜å¯Watchä¸€ä¸ªå¯¹è±¡ã€å‡çº§æˆwebsocketé“¾æ¥ç­‰ç­‰åŠŸèƒ½ã€‚




client-goæ”¯æŒå››ç§å®¢æˆ·ç«¯ï¼š`RESTClient`ã€`ClientSet`ã€`DynamicClient`ã€`DiscoveryClient`ã€‚è¿™å‡ ä¸ªclientå¯ä»¥ç›¸äº’è½¬æ¢ã€‚




### RESTClient

RESTClientæ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œç›¸å½“äºæœ€åº•å±‚çš„åŸºç¡€ç»“æ„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡RESTClientæä¾›çš„RESTfulæ–¹æ³•å¦‚Get()ã€Put()ã€Post()ã€Delete()è¿›è¡Œäº¤äº’ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œä¸ºäº†æ›´ä¸ºä¼˜é›…çš„å¤„ç†ï¼Œéœ€è¦è¿›ä¸€æ­¥å°è£…ï¼Œé€šè¿‡Clientsetå°è£…RESTClientï¼Œç„¶åå†å¯¹å¤–æä¾›æ¥å£å’ŒæœåŠ¡ã€‚

å¯ä»¥é€šè¿‡ClientSetå®¢æˆ·ç«¯è·å¾—ï¼š

```go
client := cli.CoreV1().RESTClient().(*rest.RESTClient)
```

### ClientSet

Clientsetæ˜¯è°ƒç”¨Kubernetesèµ„æºå¯¹è±¡æœ€å¸¸ç”¨çš„clientï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼ŒåŒ…å«RESTClientã€‚éœ€è¦åˆ¶å®šGroupã€Versionï¼Œç„¶åæ ¹æ®Resourceè·å–ã€‚

```go
clientset,err := kubernetes.NewForConfig(config)
sa, err := clientset.CoreV1().ServiceAccounts("kube-system").Get("kube-shell-admin", metav1.GetOptions{})
```

### DynamicClient

Dynamic clientæ˜¯ä¸€ç§åŠ¨æ€çš„clientï¼Œå®ƒèƒ½å¤„ç†kubernetesæ‰€æœ‰çš„èµ„æºã€‚ä¸åŒäºclientsetï¼Œdynamic clientè¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ª`map[string]interface{}`ã€‚

```go
dynamicClient,err := dynamic.NewForConfig(config)
gvr := schema.GroupVersionResource{Version: "v1",Resource: "pods"}
unstructObjList,err := dynamicClient.Resource(gvr).Namespace("dev").List(context.TODO(),metav1.ListOptions{Limit: 100})
```
### DiscoveryClient

DiscoveryClientæ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºå‘ç°kubernetes API Serveræ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨æˆ·æœ¬åœ°ç¼“å­˜ï¼Œä»¥å‡è½»å¯¹Kubernetes API Serverè®¿é—®çš„å‹åŠ›ã€‚ kubectlçš„api-versionså’Œapi-resourceså‘½ä»¤è¾“å‡ºä¹Ÿæ˜¯é€šè¿‡DisconversyClientå®ç°çš„ã€‚

```go
discoveryClient,err := discovery.NewDiscoveryClientForConfig(config)
APIGroup,APIResourceListSlice,err := discoveryClient.ServerGroupsAndResources()
```

è¿™å‡ ç§å®¢æˆ·ç«¯çš„åˆå§‹åŒ–éƒ½æ¶‰åŠåˆ°äº†å…¥å‚configï¼Œå³`*rest.Config`ï¼Œè¿™ä¸ªæ˜¯ç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚

## rest.Configåˆå§‹åŒ–

åˆ›å»ºclientå‰ï¼Œéœ€è¦å…ˆä»åˆå§‹åŒ–`*rest.Config`ï¼Œè¿™ä¸ª`*rest.Config`å¯ä»¥ä»é›†ç¾¤å¤–çš„kubeconfigæ–‡ä»¶æˆ–è€…é›†ç¾¤å†…éƒ¨çš„ tokenFile å’Œ CAFileåˆå§‹åŒ–ï¼ˆé€šè¿‡ServiceAcountè‡ªåŠ¨æŒ‚è½½ï¼‰ã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

### é›†ç¾¤å¤–é€šè¿‡kubeconfigåˆå§‹åŒ–

BuildConfigFromFlagsæ–¹æ³•ä»ç»™å®šçš„urlæˆ–è€…kubeconfigæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„å»åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™ä¼šä½¿ç”¨é›†ç¾¤å†…éƒ¨æ–¹æ³•åˆå§‹åŒ–configï¼Œå¦‚æœä¸æˆåŠŸåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤çš„configã€‚
```go
// "k8s.io/client-go/tools/clientcmd"
config, err := clientcmd.BuildConfigFromFlags("", *kubeconfig)
if err != nil {
   panic(err.Error())
}
```
### å†…å­˜ä¸­é€šè¿‡kubeconfigå­—ç¬¦ä¸²æˆ–è€…byteæ•°ç»„åˆå§‹åŒ–

é€šè¿‡è¯»å–kubeconfigæ–‡ä»¶å†…å®¹è¿›è¡Œåˆå§‹åŒ–ä¸€ä¸ªconfigï¼š

```go
config, err := clientcmd.NewClientConfigFromBytes([]byte(string(Data["kubeConfig"])))
if err != nil {
   return nil, err
}
restConfig, err := config.ClientConfig()
if err != nil {
   return nil, err
}
```
### é›†ç¾¤ä¸­é€šè¿‡ServiceAcountåˆå§‹åŒ–

é€šè¿‡é›†ç¾¤å†…éƒ¨é…ç½®åˆ›å»º k8s é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡ KUBERNETES_SERVICE_HOST å’Œ KUBERNETES_SERVICE_PORT ç¯å¢ƒå˜é‡æ–¹å¼è·å–ã€‚

è‹¥é›†ç¾¤ä½¿ç”¨ TLS è®¤è¯æ–¹å¼ï¼Œåˆ™é»˜è®¤è¯»å–é›†ç¾¤å†…éƒ¨ tokenFile å’Œ CAFileï¼š

`tokenFile = "/var/run/secrets/kubernetes.io/serviceaccount/token"`

`rootCAFile = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"`

```go
// "k8s.io/client-go/rest"
config, err := rest.InClusterConfig()
if err != nil {
   panic(err.Error())
}
```

### operator-sdkä¸­åˆå§‹åŒ–config

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨operator-sdkå¼€å‘CRDséƒ½ä¼šç”¨åˆ°åœ¨æœ¬åœ°è°ƒè¯•æˆ–è€…åœ¨é›†ç¾¤ä¸­è°ƒè¯•çš„æ–¹æ³•ï¼Œåœ¨ä½ç‰ˆæœ¬operator-sdkä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

```go
// "sigs.k8s.io/controller-runtime/pkg/client/config"
cfg, err := config.GetConfig()
if err != nil {
log.Error(err, "")
   os.Exit(1)
}
```

è¯¥æ–¹æ³•åˆå§‹åŒ–kubeconfigçš„é¡ºåºæ˜¯--kubeconfigæ ‡ç­¾ï¼ŒKUBECONFIGç¯å¢ƒå˜é‡ï¼ŒIn-clusteré›†ç¾¤å†…SAï¼Œ$HOME/.kube/configæ–‡ä»¶ã€‚

åœ¨åˆå§‹åŒ–çš„configçš„åŒæ—¶ï¼Œè®¾ç½®äº†è¯·æ±‚çš„QPSï¼Œé»˜è®¤20 QPS, 30 burstã€‚

åœ¨æŸäº›é«˜ç‰ˆæœ¬sdkä¸­ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•åˆå§‹åŒ–ï¼š

```go
//ctrl "sigs.k8s.io/controller-runtime"
ctrl.GetConfigOrDie()
```

åŸç†åŒä¸Šã€‚